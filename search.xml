<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>antlr</title>
      <link href="2020/11/17/antlr/"/>
      <url>2020/11/17/antlr/</url>
      
        <content type="html"><![CDATA[<h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h3><blockquote><p>Antlr (ANother Tool for Language Recognition) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„<code>è·¨è¯­è¨€</code>è¯­æ³•è§£æå™¨ï¼Œå¯ä»¥ç”¨æ¥è¯»å–ã€å¤„ç†ã€æ‰§è¡Œæˆ–ç¿»è¯‘ç»“æ„åŒ–æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®ƒè¢«å¹¿æ³›ç”¨æ¥æ„å»ºè¯­è¨€ï¼Œå·¥å…·å’Œæ¡†æ¶ã€‚Antlrå¯ä»¥ä»è¯­æ³•ä¸Šæ¥ç”Ÿæˆä¸€ä¸ªå¯ä»¥æ„å»ºå’Œéå†è§£ææ ‘çš„è§£æå™¨ã€‚</p></blockquote><h3 id="2-è°åœ¨ä½¿ç”¨"><a href="#2-è°åœ¨ä½¿ç”¨" class="headerlink" title="2. è°åœ¨ä½¿ç”¨"></a>2. è°åœ¨ä½¿ç”¨</h3><ol><li>Hive</li><li>Spark</li><li>Oracle</li><li>Presto</li><li>Elasticsearch</li></ol><h3 id="3-å¸¸è§çš„è¯­æ³•åˆ†æå™¨"><a href="#3-å¸¸è§çš„è¯­æ³•åˆ†æå™¨" class="headerlink" title="3. å¸¸è§çš„è¯­æ³•åˆ†æå™¨"></a>3. å¸¸è§çš„è¯­æ³•åˆ†æå™¨</h3><ol><li>Antlr</li><li>Javacc</li><li>SqlParser (ä½äº<code>Alibaba</code>çš„<code>Druid</code>åº“ä¸­)</li></ol><p>å…¶ä¸­<code>Antlr</code>å’Œ<code>Javacc</code>éƒ½æ˜¯ç°ä»£çš„è¯­æ³•è§£æå™¨ï¼Œä¸¤è€…éƒ½å¾ˆä¼˜ç§€ï¼Œå…¶ä¸­<code>Antlr</code>è¦æ›´èƒœä¸€ç­¹ã€‚è€Œ<code>SqlParser</code>åªèƒ½è§£æ<code>sql</code>è¯­å¥ï¼ŒåŠŸèƒ½æ¯”è¾ƒå•ä¸€ã€‚</p><p>ğŸ·ï¼šæœ¬äººåŸºäº<code>Antlr</code>å’Œ<code>SqlParser</code>åˆ†åˆ«å†™äº†ä¸€å¥—<code>elasticsearch-sql</code>ç»„ä»¶ï¼Œæœ‰éœ€è¦çš„äººå¯ä»¥çœ‹çœ‹æºç ã€‚</p><p><a href="http://github.com/iamazy/elasticsearch-sql" target="_blank" rel="noopener">åŸºäºAntlr4çš„elasticsearch-sql</a></p><p><a href="https://github.com/iamazy/elasticsearch-sql2" target="_blank" rel="noopener">åŸºäºSqlParserçš„elasticsearch-sql</a></p><h3 id="4-åŸºæœ¬æ¦‚å¿µ"><a href="#4-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="4. åŸºæœ¬æ¦‚å¿µ"></a>4. åŸºæœ¬æ¦‚å¿µ</h3><ol><li>æŠ½è±¡è¯­æ³•æ ‘ (Abstract Syntax Tree,AST)<br>æŠ½è±¡è¯­æ³•æ ‘æ˜¯æºä»£ç ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºï¼Œå®ƒä»¥æ ‘çš„å½¢çŠ¶è¡¨ç¤ºè¯­è¨€çš„è¯­æ³•ç»“æ„ã€‚æŠ½è±¡è¯­æ³•æ ‘ä¸€èˆ¬å¯ä»¥ç”¨æ¥è¿›è¡Œ<code>ä»£ç è¯­æ³•çš„æ£€æŸ¥</code>ï¼Œ<code>ä»£ç é£æ ¼çš„æ£€æŸ¥</code>ï¼Œ<code>ä»£ç çš„æ ¼å¼åŒ–</code>ï¼Œ<code>ä»£ç çš„é«˜äº®</code>ï¼Œ<code>ä»£ç çš„é”™è¯¯æç¤º</code>ä»¥åŠ<code>ä»£ç çš„è‡ªåŠ¨è¡¥å…¨</code>ç­‰ç­‰ã€‚</li><li>è¯­æ³•è§£æå™¨ (Parser)<br>è¯­æ³•è§£æå™¨é€šå¸¸ä½œä¸º<code>ç¼–è¯‘å™¨</code>æˆ–<code>è§£é‡Šå™¨</code>å‡ºç°ã€‚å®ƒçš„ä½œç”¨æ˜¯è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œå¹¶æ„å»ºç”±è¾“å…¥å•è¯(<code>Token</code>)ç»„æˆçš„æ•°æ®ç»“æ„(å³æŠ½è±¡è¯­æ³•æ ‘)ã€‚è¯­æ³•è§£æå™¨é€šå¸¸ä½¿ç”¨<code>è¯æ³•åˆ†æå™¨(Lexer)</code>ä»è¾“å…¥å­—ç¬¦æµä¸­åˆ†ç¦»å‡ºä¸€ä¸ªä¸ªçš„å•è¯(<code>Token</code>)ï¼Œå¹¶å°†å•è¯(<code>Token</code>)æµä½œä¸ºå…¶è¾“å…¥ã€‚å®é™…å¼€å‘ä¸­ï¼Œè¯­æ³•è§£æå™¨å¯ä»¥æ‰‹å·¥ç¼–å†™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å·¥å…·è‡ªåŠ¨ç”Ÿæˆã€‚</li><li>è¯æ³•åˆ†æå™¨ (Lexer)<br><code>è¯æ³•åˆ†æ</code>æ˜¯æŒ‡åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå°†<code>å­—ç¬¦åºåˆ—</code>è½¬æ¢ä¸ºå•è¯(<code>Token</code>)çš„è¿‡ç¨‹ã€‚æ‰§è¡Œ<code>è¯æ³•åˆ†æ</code>çš„ç¨‹åºä¾¿ç§°ä¸ºè¯æ³•åˆ†æå™¨ã€‚<code>è¯æ³•åˆ†æå™¨(Lexer)</code>ä¸€èˆ¬æ˜¯ç”¨æ¥ä¾›<code>è¯­æ³•è§£æå™¨(Parser)</code>è°ƒç”¨çš„ã€‚</li></ol><h3 id="5-Antlr4ä½¿ç”¨æ–¹æ³•"><a href="#5-Antlr4ä½¿ç”¨æ–¹æ³•" class="headerlink" title="5. Antlr4ä½¿ç”¨æ–¹æ³•"></a>5. Antlr4ä½¿ç”¨æ–¹æ³•</h3><h4 id="1-å®‰è£…"><a href="#1-å®‰è£…" class="headerlink" title="(1). å®‰è£…"></a>(1). å®‰è£…</h4><pre class="line-numbers language-shell"><code class="language-shell">cd /usr/local/libwget</span> https://www.antlr.org/download/antlr-4.8-complete.jarexport CLASSPATH=".:/usr/local/lib/antlr-4.8-complete.jar:$CLASSPATH"antlr4='java -jar /usr/local/lib/antlr-4.8-complete.jar'grun='java org.antlr.v4.gui.TestRig'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯æœ¬æ–‡å¹¶ä¸ä½¿ç”¨è¿™ç§æ–¹å¼æ¥ä½¿ç”¨<code>Antlr4</code>ï¼Œè€Œæ˜¯ä½¿ç”¨æ’ä»¶çš„æ–¹å¼ã€‚</p><h4 id="2-å®‰è£…æ’ä»¶"><a href="#2-å®‰è£…æ’ä»¶" class="headerlink" title="(2). å®‰è£…æ’ä»¶"></a>(2). å®‰è£…æ’ä»¶</h4><p>æœ¬æ–‡ä½¿ç”¨IDEAä½œä¸ºå¼€å‘å·¥å…·ï¼Œåœ¨Preference-&gt;Pluginsä¸­æœç´¢<code>antlr</code>ç„¶åå®‰è£…å³å¯ã€‚</p><h4 id="3-å®šä¹‰DSLè¯­æ³•"><a href="#3-å®šä¹‰DSLè¯­æ³•" class="headerlink" title="(3). å®šä¹‰DSLè¯­æ³•"></a>(3). å®šä¹‰DSLè¯­æ³•</h4><p>æœ¬æ–‡å°†ä½¿ç”¨<code>Antlr4</code>å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„<code>Elasticsearch</code>çš„æŸ¥è¯¢è¯­æ³•ï¼Œä»£æ›¿<code>Elasticsearch</code>çš„<code>dsl</code>ã€‚</p><p><strong>æœç´¢è¯­æ³•å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><blockquote><p>å•ä¸ªæŸ¥è¯¢ï¼š<code>field</code>:<code>value</code>ï¼Œå…¶ä¸­å†’å·<code>:</code>å’Œç­‰äºå·<code>=</code>è¡¨ç¤ºç­‰äºï¼Œ<code>!=</code>è¡¨ç¤ºä¸ç­‰äº<br>å¤šä¸ªæŸ¥è¯¢ï¼š<code>field1</code>:<code>value1</code>,<code>field2</code>:<code>value2</code>ï¼Œä½¿ç”¨é€—å·<code>,</code>æˆ–è€…<code>&amp;&amp;</code>è¡¨ç¤º<code>ä¸”</code>çš„å…³ç³»ï¼Œä½¿ç”¨<code>||</code>è¡¨ç¤º<code>æˆ–</code>çš„å…³ç³»<br>æ‹¬å·ï¼šå¯ä»¥ä½¿ç”¨æ‹¬å·<code>()</code>å°†å¤šä¸ªæ¡ä»¶æ‰©èµ·æ¥</p></blockquote><p><strong>ç¤ºä¾‹ï¼š</strong></p><blockquote><p>country:ä¸­å›½,province:æ¹–å—,city:å¼ å®¶ç•Œ</p></blockquote><p><strong>ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘å¦‚ä¸‹æ‰€ç¤º:</strong><br><img src="/2020/11/17/antlr/ast1.png" alt="æœç´¢è¯­æ³•çš„æŠ½è±¡è¯­æ³•æ ‘"></p><p><strong>èšç±»è¯­æ³•å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><blockquote><p>æ¡¶èšç±»(terms)ï¼š<code>field</code><br>å»é‡å€¼è®¡æ•°(cardinality)ï¼š(<code>field</code>)<br>æ¡¶èšç±»åˆ†é¡µ(composite)ï¼š<code>field</code> after <code>value</code><br>åœ°ç†è¾¹æ¡†èšç±»(geoBoundingBox)ï¼š[<code>field</code>]<br>æ¡¶èšç±»åµŒå¥—å­èšç±»(subAgg)ï¼š<code>field1</code>&gt;<code>field2</code>&gt;<code>field3</code><br>å¤šä¸ªèšç±»æ¡ä»¶ç”¨åˆ†å·<code>;</code>éš”å¼€</p></blockquote><p><strong>ç¤ºä¾‹ï¼š</strong></p><blockquote><p>country;(country);country&gt;province&gt;city;province after æ¹–å—</p></blockquote><p><strong>ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘å¦‚ä¸‹æ‰€ç¤º:</strong><br><img src="/2020/11/17/antlr/ast2.png" alt="èšç±»è¯­æ³•çš„æŠ½è±¡è¯­æ³•æ ‘"></p><h4 id="4-ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶"><a href="#4-ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶" class="headerlink" title="(4). ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶"></a>(4). ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶</h4><blockquote><p>åˆ›å»ºSearchLexer.g4æ–‡ä»¶ï¼Œå®šä¹‰è¯æ³•åˆ†æå™¨çš„Token</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// è¡¨æ˜SearchLexer.g4æ–‡ä»¶æ˜¯è¯æ³•åˆ†æå™¨(lexer)å®šä¹‰æ–‡ä»¶</span><span class="token comment" spellcheck="true">// è¯æ³•åˆ†æå™¨çš„åç§°ä¸€å®šè¦å’Œæ–‡ä»¶åä¿æŒä¸€è‡´</span>lexer grammar SearchLexer<span class="token punctuation">;</span>channels <span class="token punctuation">{</span>    ESQLCOMMENT<span class="token punctuation">,</span>    ERRORCHANNEL<span class="token punctuation">}</span><span class="token comment" spellcheck="true">//SKIP å½“Antlrè§£æåˆ°ä¸‹é¢çš„ä»£ç æ—¶ï¼Œä¼šé€‰æ‹©è·³è¿‡</span><span class="token comment" spellcheck="true">// é‡åˆ° \t\r\n ä¼šå¿½ç•¥</span>SPACE<span class="token punctuation">:</span> <span class="token punctuation">[</span> \t\r\n<span class="token punctuation">]</span><span class="token operator">+</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>HIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// é‡åˆ° </span><span class="token comment" spellcheck="true">/*!  */</span> ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡SPEC_ESSQL_COMMENT<span class="token punctuation">:</span> <span class="token string">'/*!'</span> <span class="token punctuation">.</span><span class="token operator">+</span><span class="token operator">?</span> <span class="token string">'*/'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>ESQLCOMMENT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// é‡åˆ° </span><span class="token comment" spellcheck="true">/* */</span> ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡COMMENT_INPUT<span class="token punctuation">:</span> <span class="token string">'/*'</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">?</span> <span class="token string">'*/'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>HIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// é‡åˆ° -- ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡</span><span class="token comment" spellcheck="true">// é‡åˆ° # ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡</span>LINE_COMMENT<span class="token punctuation">:</span> <span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token string">'-- '</span> <span class="token operator">|</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>\r\n<span class="token punctuation">]</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token operator">?</span> <span class="token string">'\n'</span> <span class="token operator">|</span> EOF<span class="token punctuation">)</span>        <span class="token operator">|</span> <span class="token string">'--'</span> <span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token operator">?</span> <span class="token string">'\n'</span> <span class="token operator">|</span> EOF<span class="token punctuation">)</span>    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>HIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å®šä¹‰Tokenï¼Œæ¨¡å¼ä¸º {field}:{value}</span>MINUS<span class="token punctuation">:</span> <span class="token string">'-'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//ä½¿MINUSå’Œ-ç­‰ä»·ï¼Œä»¥ä¸‹åŒç†</span>STAR<span class="token punctuation">:</span> <span class="token string">'*'</span><span class="token punctuation">;</span>COLON<span class="token punctuation">:</span> <span class="token string">':'</span><span class="token operator">|</span><span class="token string">'\uFF1A'</span><span class="token punctuation">;</span>EQ<span class="token punctuation">:</span> <span class="token string">'='</span><span class="token punctuation">;</span>NE<span class="token punctuation">:</span> <span class="token string">'!='</span><span class="token punctuation">;</span>BOOLOR<span class="token punctuation">:</span> <span class="token string">'||'</span><span class="token operator">|</span><span class="token string">'|'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ä½¿BOOLORä¸||æˆ–è€…|ç­‰ä»·</span>BOOLAND<span class="token punctuation">:</span> <span class="token string">'&amp;&amp;'</span><span class="token operator">|</span>COMMA<span class="token operator">|</span><span class="token string">'&amp;'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//CONSTRUCTORS</span>DOT<span class="token punctuation">:</span> <span class="token string">'.'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">mode</span><span class="token punctuation">(</span>AFTER_DOT<span class="token punctuation">)</span><span class="token punctuation">;</span>LBRACKET<span class="token punctuation">:</span> <span class="token string">'['</span><span class="token punctuation">;</span>RBRACKET<span class="token punctuation">:</span> <span class="token string">']'</span><span class="token punctuation">;</span>LPAREN<span class="token punctuation">:</span> <span class="token string">'('</span><span class="token punctuation">;</span>RPAREN<span class="token punctuation">:</span> <span class="token string">')'</span><span class="token punctuation">;</span>COMMA<span class="token punctuation">:</span> <span class="token string">','</span><span class="token operator">|</span><span class="token string">'\uFF0C'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ä½¿COMMAä¸,æˆ–ï¼Œç­‰ä»·(\uFF0Cè¡¨ç¤ºï¼Œçš„unicodeç¼–ç )</span>SEMI<span class="token punctuation">:</span> <span class="token string">';'</span><span class="token punctuation">;</span>GT<span class="token punctuation">:</span> <span class="token string">'>'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è¿™é‡Œå’Œä»¥ä¸‹ä»£ç ç­‰ä»·</span><span class="token comment" spellcheck="true">// AFTER: 'after'  ä½†æ˜¯è¿™ç§ä»£ç åªèƒ½è¡¨ç¤ºå°å†™çš„afterï¼Œæ˜¯å¤§å°å†™åŒºåˆ†çš„ï¼Œè¿™æ ·ä¸å¥½</span><span class="token comment" spellcheck="true">// é€šè¿‡ä¸‹é¢å®šä¹‰çš„fragmentï¼Œå°†AFTERç”¨A F T E Rè¡¨ç¤ºï¼Œä¸€å®šè¦æ¯ä¸ªå­—æ¯ç©ºä¸€æ ¼ï¼Œå°±å¯ä»¥ä¸åŒºåˆ†å¤§å°å†™äº†</span><span class="token comment" spellcheck="true">// æ‰€æœ‰è¯­æ³•çš„å…³é”®å­—éƒ½å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼å£°æ˜</span>AFTER<span class="token punctuation">:</span> A F T E R<span class="token punctuation">;</span>SINGLE_QUOTE<span class="token punctuation">:</span> <span class="token string">'\''</span><span class="token punctuation">;</span>DOUBLE_QUOTE<span class="token punctuation">:</span> <span class="token string">'"'</span><span class="token punctuation">;</span>REVERSE_QUOTE<span class="token punctuation">:</span> <span class="token string">'`'</span><span class="token punctuation">;</span>UNDERLINE<span class="token punctuation">:</span> <span class="token string">'_'</span><span class="token punctuation">;</span>CHINESE<span class="token punctuation">:</span> <span class="token string">'\u4E00'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">'\u9FA5'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//è¡¨ç¤ºæ‰€æœ‰ä¸­æ–‡çš„unicodeç¼–ç ï¼Œä»¥æ”¯æŒä¸­æ–‡</span>ID<span class="token punctuation">:</span> <span class="token punctuation">(</span>CHINESE<span class="token operator">|</span>ID_LETTER<span class="token operator">|</span>DOT<span class="token operator">|</span>MINUS<span class="token operator">|</span>UNDERLINE<span class="token operator">|</span>INT<span class="token operator">|</span>FLOAT<span class="token operator">|</span>REVERSE_QUOTE<span class="token operator">|</span>DOUBLE_QUOTE<span class="token operator">|</span>SINGLE_QUOTE<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ? è¡¨ç¤ºå¯æœ‰å¯æ— </span><span class="token comment" spellcheck="true">// + è¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ª</span><span class="token comment" spellcheck="true">// | è¡¨ç¤ºæˆ–çš„å…³ç³»</span><span class="token comment" spellcheck="true">// * è¡¨ç¤ºæœ‰0æˆ–è€…å¤šä¸ª</span>INT<span class="token punctuation">:</span> MINUS<span class="token operator">?</span> DEC_DIGIT<span class="token operator">+</span><span class="token punctuation">;</span>FLOAT<span class="token punctuation">:</span> <span class="token punctuation">(</span>MINUS<span class="token operator">?</span> DEC_DIGIT<span class="token operator">+</span> DOT DEC_DIGIT<span class="token operator">+</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token punctuation">(</span>MINUS<span class="token operator">?</span> DOT DEC_DIGIT<span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ä½¿ç”¨DEC_DIGITä»£è¡¨0åˆ°9ä¹‹é—´çš„æ•°å­—</span>fragment DEC_DIGIT<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä½¿ç”¨ID_LETTERä»£è¡¨a-zçš„å¤§å†™å°å†™å­—æ¯å’Œ_</span>fragment ID_LETTER<span class="token punctuation">:</span> <span class="token punctuation">[</span>a<span class="token operator">-</span>zA<span class="token operator">-</span>Z<span class="token punctuation">]</span><span class="token operator">|</span> UNDERLINE<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è¡¨ç¤ºç”¨Aä»£è¡¨aå’ŒAï¼Œè¿™æ ·å°±å¯ä»¥ä¸åŒºåˆ†å¤§å°å†™äº†ï¼Œä»¥ä¸‹åŒç†</span>fragment A<span class="token punctuation">:</span> <span class="token punctuation">[</span>aA<span class="token punctuation">]</span><span class="token punctuation">;</span> fragment B<span class="token punctuation">:</span> <span class="token punctuation">[</span>bB<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment C<span class="token punctuation">:</span> <span class="token punctuation">[</span>cC<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment D<span class="token punctuation">:</span> <span class="token punctuation">[</span>dD<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment E<span class="token punctuation">:</span> <span class="token punctuation">[</span>eE<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment F<span class="token punctuation">:</span> <span class="token punctuation">[</span>fF<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment G<span class="token punctuation">:</span> <span class="token punctuation">[</span>gG<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment H<span class="token punctuation">:</span> <span class="token punctuation">[</span>hH<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment I<span class="token punctuation">:</span> <span class="token punctuation">[</span>iI<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment J<span class="token punctuation">:</span> <span class="token punctuation">[</span>jJ<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment K<span class="token punctuation">:</span> <span class="token punctuation">[</span>kK<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment L<span class="token punctuation">:</span> <span class="token punctuation">[</span>lL<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment M<span class="token punctuation">:</span> <span class="token punctuation">[</span>mM<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment N<span class="token punctuation">:</span> <span class="token punctuation">[</span>nN<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment O<span class="token punctuation">:</span> <span class="token punctuation">[</span>oO<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment P<span class="token punctuation">:</span> <span class="token punctuation">[</span>pP<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment Q<span class="token punctuation">:</span> <span class="token punctuation">[</span>qQ<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment R<span class="token punctuation">:</span> <span class="token punctuation">[</span>rR<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment S<span class="token punctuation">:</span> <span class="token punctuation">[</span>sS<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment T<span class="token punctuation">:</span> <span class="token punctuation">[</span>tT<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment U<span class="token punctuation">:</span> <span class="token punctuation">[</span>uU<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment V<span class="token punctuation">:</span> <span class="token punctuation">[</span>vV<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment W<span class="token punctuation">:</span> <span class="token punctuation">[</span>wW<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment X<span class="token punctuation">:</span> <span class="token punctuation">[</span>xX<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment Y<span class="token punctuation">:</span> <span class="token punctuation">[</span>yY<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment Z<span class="token punctuation">:</span> <span class="token punctuation">[</span>zZ<span class="token punctuation">]</span><span class="token punctuation">;</span>mode AFTER_DOT<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//DEFAULT_MODEæ˜¯Antlrä¸­é»˜è®¤å®šä¹‰å¥½çš„mode</span>DOTINTEGER<span class="token punctuation">:</span> <span class="token punctuation">(</span> <span class="token string">'0'</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">mode</span><span class="token punctuation">(</span>DEFAULT_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>DOTID<span class="token punctuation">:</span> <span class="token punctuation">[</span>_a<span class="token operator">-</span>zA<span class="token operator">-</span>Z<span class="token punctuation">]</span> <span class="token punctuation">[</span>_a<span class="token operator">-</span>zA<span class="token operator">-</span>Z0<span class="token number">-9</span><span class="token punctuation">]</span><span class="token operator">*</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">mode</span><span class="token punctuation">(</span>DEFAULT_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åˆ›å»ºSearchParser.g4æ–‡ä»¶ï¼Œå®šä¹‰è¯­æ³•è§£æå™¨çš„æœç´¢è¯­æ³•</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// è¡¨æ˜SearchParser.g4æ–‡ä»¶æ˜¯è¯­æ³•è§£æå™¨(parser)å®šä¹‰æ–‡ä»¶</span><span class="token comment" spellcheck="true">// åŒç†ï¼Œè¯­æ³•åˆ†æå™¨çš„åç§°ä¸€å®šè¦å’Œæ–‡ä»¶åä¿æŒä¸€è‡´</span>parser grammar SearchParser<span class="token punctuation">;</span>options <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è¡¨ç¤ºè§£ætokençš„è¯æ³•è§£æå™¨ä½¿ç”¨SearchLexer</span>    tokenVocab <span class="token operator">=</span> SearchLexer<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// EOF(end of file)è¡¨ç¤ºæ–‡ä»¶ç»“æŸç¬¦ï¼Œè¿™ä¸ªæ˜¯Antlrä¸­å·²ç»å®šä¹‰å¥½çš„</span>prog<span class="token punctuation">:</span> expression <span class="token operator">|</span> STAR EOF<span class="token punctuation">;</span>expression<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">// è¡¨ç¤ºè¡¨è¾¾å¼å¯ä»¥è¢«æ‹¬å·æ‹¬èµ·æ¥</span>    <span class="token comment" spellcheck="true">// å¦‚æœè¯­æ³•åé¢åŠ ä¸Šäº†#{name}ï¼Œç›¸å½“äºå°†è¿™ä¸ªnameä½œä¸ºè¿™ä¸ªè¯­æ³•å—çš„åå­—ï¼Œè¿™ä¸ª#{name}è¦åŠ éƒ½å¾—åŠ ä¸Šï¼Œè¦ä¸åŠ éƒ½ä¸åŠ </span>    <span class="token comment" spellcheck="true">// (country:ä¸­å›½)</span>    LPAREN expression RPAREN                                                            #lrExpr    <span class="token comment" spellcheck="true">// leftExpræ˜¯ç»™å®šä¹‰çš„è¯­æ³•èµ·çš„åˆ«å(alias)ï¼Œå¯æœ‰å¯æ— ï¼Œä½†æ˜¯æœ‰ä¼šæ›´å¥½ç‚¹</span>    <span class="token comment" spellcheck="true">// å› ä¸ºantlrè§£æåŒä¸€è¯­æ³•å—çš„åŒä¸€ç±»tokenæ—¶ï¼Œä¼šå°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªlisté‡Œé¢</span>    <span class="token comment" spellcheck="true">// æ¯”å¦‚ä¸‹é¢çš„è¯­æ³•å—ï¼Œæœ‰ä¸¤ä¸ªexpressionï¼Œantlrä¼šå°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨expressionsé‡Œ</span>    <span class="token comment" spellcheck="true">// è·å–ç¬¬ä¸€ä¸ªexpressionæ—¶éœ€è¦expressions.get(0)ï¼Œè·å–ç¬¬äºŒä¸ªexpressionæ—¶éœ€è¦expressions.get(1)</span>    <span class="token comment" spellcheck="true">// å¦‚æœç»™ç¬¬ä¸€ä¸ªexpressionèµ·äº†ä¸ªåˆ«åå«leftExprï¼Œç»™ç¬¬äºŒä¸ªexpressionèµ·äº†ä¸ªåˆ«åå«rightExpr</span>    <span class="token comment" spellcheck="true">// é‚£æ ·åœ¨javaé‡Œé¢è°ƒç”¨æ—¶å°±å¯ä»¥ç›´æ¥è°ƒç”¨leftExprå’ŒrightExprï¼Œè€Œä¸éœ€è¦æŒ‡å®šexpressionsä¸­çš„ç´¢å¼•(0æˆ–1)</span>    <span class="token comment" spellcheck="true">// è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå¦‚æœä¹‹åæ·»åŠ äº†æ–°çš„tokenï¼Œæ¯”å¦‚åœ¨ä¸‹é¢è¯­æ³•ä¸­é—´æ·»åŠ ä¸€ä¸ªexpressionçš„token</span>    <span class="token comment" spellcheck="true">// è¿™æ—¶å¦‚æœä¸ä½¿ç”¨åˆ«åleftExprï¼ŒrightExprå°±å¯èƒ½éœ€è¦ä¿®æ”¹javaä»£ç ï¼Œå› ä¸ºåŸæ¥rightExprå¯¹åº”çš„expressionåœ¨expressionsä¸­ç´¢å¼•å˜ä¸º2äº†</span>    <span class="token comment" spellcheck="true">// ä½¿ç”¨åˆ«åleftExprï¼ŒrightExpr(å½“ç„¶è¿˜å¯ä»¥å–åˆ«çš„åå­—)å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œä½¿è¯­æ³•æ–‡ä»¶å’Œç”Ÿæˆçš„javaä»£ç æ›´ä¾¿äºç»´æŠ¤</span>    <span class="token comment" spellcheck="true">// country:ä¸­å›½</span>    <span class="token operator">|</span> leftExpr <span class="token operator">=</span> expression operator <span class="token operator">=</span> <span class="token punctuation">(</span>EQ <span class="token operator">|</span>COLON<span class="token operator">|</span> NE <span class="token punctuation">)</span> rightExpr <span class="token operator">=</span> expression            #eqExpr    <span class="token comment" spellcheck="true">// (country:ä¸­å›½||country:ç¾å›½)&amp;&amp;city:åŒ—äº¬</span>    <span class="token operator">|</span> leftExpr <span class="token operator">=</span> expression operator <span class="token operator">=</span> <span class="token punctuation">(</span>BOOLAND<span class="token operator">|</span>BOOLOR<span class="token punctuation">)</span> rightExpr <span class="token operator">=</span> expression            #boolExpr    <span class="token comment" spellcheck="true">// countryç­‰å­—é¢é‡</span>    <span class="token operator">|</span> ID                                                                                #identityExpr<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åˆ›å»ºAggregateParser.g4æ–‡ä»¶ï¼Œå®šä¹‰è¯­æ³•è§£æå™¨çš„èšç±»è¯­æ³•</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript">parser grammar AggregateParser<span class="token punctuation">;</span>options <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// èšç±»çš„è¯­æ³•åˆ†æå™¨ä¹Ÿå¯ä»¥ä½¿ç”¨SearchLexer</span>    tokenVocab <span class="token operator">=</span> SearchLexer<span class="token punctuation">;</span><span class="token punctuation">}</span>expr<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">// å¤šä¸ªèšç±»æ¡ä»¶ç”¨åˆ†å·éš”å¼€</span>    aggClause <span class="token punctuation">(</span>SEMI aggClause<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// aggClauseè¡¨ç¤ºä»£è¡¨ä»¥ä¸‹èšç±»çš„ä»»æ„ä¸€ç§</span>aggClause<span class="token punctuation">:</span>    cardinalityAggClause<span class="token operator">|</span>termsAggClause<span class="token operator">|</span>termsAfterAggClause<span class="token operator">|</span>geoBoundingBoxAggClause<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å»é‡å€¼è®¡æ•° -> (country)</span>cardinalityAggClause<span class="token punctuation">:</span>    LPAREN ID RPAREN<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ¡¶èšç±»åˆ†é¡µ -> province after æ¹–å—</span>termsAfterAggClause<span class="token punctuation">:</span>    field <span class="token operator">=</span> ID AFTER after<span class="token operator">=</span>ID<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ¡¶èšç±»åµŒå¥—å­èšç±» -> country>province>city</span>termsAggClause<span class="token punctuation">:</span>    field <span class="token operator">=</span> ID <span class="token punctuation">(</span>GT termsAggClause<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// åœ°ç†è¾¹æ¡†èšç±» -> [coordinate]</span>geoBoundingBoxAggClause<span class="token punctuation">:</span>    LBRACKET ID RBRACKET<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5-ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶"><a href="#5-ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶" class="headerlink" title="(5). ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶"></a>(5). ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶</h4><blockquote><p>åœ¨IDEAä¸­ï¼Œåœ¨<code>SearchParser.g4</code>ï¼Œ<code>AggregateParser.g4</code>æ–‡ä»¶å³é”®é€‰æ‹©<code>Configure ANTLR...</code>ï¼Œé…ç½®æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä»£ç çš„é…ç½®å’Œè¾“å‡ºç›®å½•</p></blockquote><p><img src="/2020/11/17/antlr/configure-antlr.png" alt="antlré…ç½®é¡¹"></p><blockquote><p>ç„¶ååœ¨<code>SearchParser.g4</code>ï¼Œ<code>AggregateParser.g4</code>æ–‡ä»¶å³é”®é€‰æ‹©<code>Generate ANTLR Recognizer</code>ç”Ÿæˆä»£ç æ–‡ä»¶ã€‚ç”Ÿæˆçš„ä»£ç ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">|</span><span class="token operator">--</span> io    <span class="token operator">|</span><span class="token operator">--</span> github        <span class="token operator">|</span><span class="token operator">--</span> iamazy            <span class="token operator">|</span><span class="token operator">--</span> elasticsearch                <span class="token operator">|</span><span class="token operator">--</span> dsl                    <span class="token operator">|</span><span class="token operator">--</span> antlr4                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParser<span class="token punctuation">.</span>interp                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParser<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParser<span class="token punctuation">.</span>tokens                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserBaseListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserBaseVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateWalker<span class="token punctuation">.</span>java          <span class="token comment" spellcheck="true">//è¿™æ˜¯è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¸æ˜¯antlrè‡ªåŠ¨ç”Ÿæˆçš„</span>                        <span class="token operator">|</span><span class="token operator">--</span> QueryParser<span class="token punctuation">.</span>java              <span class="token comment" spellcheck="true">//è¿™æ˜¯è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¸æ˜¯antlrè‡ªåŠ¨ç”Ÿæˆçš„</span>                        <span class="token operator">|</span><span class="token operator">--</span> SearchLexer<span class="token punctuation">.</span>interp                        <span class="token operator">|</span><span class="token operator">--</span> SearchLexer<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchLexer<span class="token punctuation">.</span>tokens                        <span class="token operator">|</span><span class="token operator">--</span> SearchParser<span class="token punctuation">.</span>interp                        <span class="token operator">|</span><span class="token operator">--</span> SearchParser<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParser<span class="token punctuation">.</span>tokens                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserBaseListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserBaseVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchWalker<span class="token punctuation">.</span>java             <span class="token comment" spellcheck="true">//è¿™æ˜¯è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¸æ˜¯antlrè‡ªåŠ¨ç”Ÿæˆçš„</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="6-éå†æŠ½è±¡è¯­æ³•æ ‘"><a href="#6-éå†æŠ½è±¡è¯­æ³•æ ‘" class="headerlink" title="(6). éå†æŠ½è±¡è¯­æ³•æ ‘"></a>(6). éå†æŠ½è±¡è¯­æ³•æ ‘</h4><blockquote><p>è¿™é‡Œæˆ‘ä»¬ä¸å®ç°<code>Antlr</code>ç”Ÿæˆå¥½çš„<code>Listener</code>æˆ–<code>Visitor</code>éå†æŠ½è±¡è¯­æ³•æ ‘çš„æ¥å£ï¼Œè€Œæ˜¯è‡ªå·±å†™ä»£ç éå†æŠ½è±¡è¯­æ³•æ ‘</p></blockquote><p>åœ¨<code>io.github.iamazy.elasticsearch.dsl.antlr4</code>åŒ…ä¸‹åˆ›å»ºJavaç±»<code>SearchWalker</code>ï¼Œ<code>AggregateWalker</code>ï¼Œ<code>QueryParser</code>ã€‚</p><blockquote><p><code>SearchWalker</code>ç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>antlr4<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStreams<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CommonTokenStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @descrition ç”Ÿæˆéå†æœç´¢æ¡ä»¶çš„æŠ½è±¡è¯­æ³•æ ‘çš„éå†å™¨ **/</span><span class="token keyword">class</span> <span class="token class-name">SearchWalker</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String expression<span class="token punctuation">;</span>    <span class="token function">SearchWalker</span><span class="token punctuation">(</span>String expression<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token operator">=</span>expression<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    SearchParser <span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æœç´¢è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        CharStream stream<span class="token operator">=</span> CharStreams<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>        SearchLexer lexer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SearchLexer</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommonTokenStream</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>AggregateWalker</code>ç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>antlr4<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStreams<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CommonTokenStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @descrition ç”Ÿæˆéå†èšç±»æ¡ä»¶çš„æŠ½è±¡è¯­æ³•æ ‘çš„éå†å™¨ **/</span><span class="token keyword">class</span> <span class="token class-name">AggregateWalker</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String expression<span class="token punctuation">;</span>    <span class="token function">AggregateWalker</span><span class="token punctuation">(</span>String expression<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token operator">=</span>expression<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    AggregateParser <span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æœç´¢è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        CharStream stream<span class="token operator">=</span> CharStreams<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>        SearchLexer lexer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SearchLexer</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AggregateParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommonTokenStream</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>QueryParser</code>ç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>antlr4<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span>BoolQueryBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QueryBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QueryBuilders<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>AggregationBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>AggregationBuilders<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>composite<span class="token punctuation">.</span>CompositeAggregationBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>composite<span class="token punctuation">.</span>CompositeValuesSourceBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>composite<span class="token punctuation">.</span>TermsValuesSourceBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @descrition éå†æœç´¢æ¡ä»¶å’Œèšç±»æ¡ä»¶çš„æŠ½è±¡è¯­æ³•æ ‘ **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryParser</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> QueryBuilder <span class="token function">parse</span><span class="token punctuation">(</span>String expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼ä¸º*ï¼Œåˆ™è¿”å›å…¨éƒ¨æ•°æ®</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆéå†æ ‘çš„å®ä¾‹</span>        SearchWalker walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchWalker</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è°ƒç”¨æ–¹æ³•ï¼Œéå†è¡¨è¾¾å¼</span>        SearchParser searchParser <span class="token operator">=</span> walker<span class="token punctuation">.</span><span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†æœç´¢è¡¨è¾¾å¼è½¬æ¢ä¸ºæŸ¥è¯¢elasticsearchçš„querybuilder</span>        <span class="token keyword">return</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>searchParser<span class="token punctuation">.</span><span class="token function">prog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> QueryBuilder <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>ExpressionContext expressionContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼æ˜¯è¢«æ‹¬å·åŒ…å«çš„è¯ï¼Œè°ƒç”¨parseLrExprContext</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionContext <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>LrExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">parseLrExprContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>LrExprContext<span class="token punctuation">)</span> expressionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼æ˜¯æ¡ä»¶è¡¨è¾¾å¼åŒ…å«ä¸æˆ–éçš„è¯ï¼Œè°ƒç”¨parseBoolExprContext</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionContext <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>BoolExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">parseBoolExprContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>BoolExprContext<span class="token punctuation">)</span> expressionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼æ˜¯ç­‰å¼çš„è¯ï¼Œè°ƒç”¨parseEqExprContext</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionContext <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>EqExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">parseEqExprContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>EqExprContext<span class="token punctuation">)</span> expressionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸æ”¯æŒè¯¥æŸ¥è¯¢è¯­æ³•!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£ææ‹¬å·ä¸­çš„è¡¨è¾¾å¼</span>    <span class="token keyword">private</span> QueryBuilder <span class="token function">parseLrExprContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>LrExprContext lrExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        SearchParser<span class="token punctuation">.</span>ExpressionContext expression <span class="token operator">=</span> lrExprContext<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> BoolQueryBuilder <span class="token function">parseBoolExprContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>BoolExprContext boolExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//è§£ææ¡ä»¶è¡¨è¾¾å¼çš„å·¦åŠè¾¹è¡¨è¾¾å¼</span>        SearchParser<span class="token punctuation">.</span>ExpressionContext leftExpr <span class="token operator">=</span> boolExprContext<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è§£ææ¡ä»¶è¡¨è¾¾å¼çš„å³åŠè¾¹è¡¨è¾¾å¼</span>        SearchParser<span class="token punctuation">.</span>ExpressionContext rightExpr <span class="token operator">=</span> boolExprContext<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†å·¦åŠè¾¹è¡¨è¾¾å¼è½¬æ¢æˆquerybuilder</span>        QueryBuilder leftQuery <span class="token operator">=</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>leftExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†å³åŠè¾¹è¡¨è¾¾å¼è½¬æ¢ä¸ºquerybuilder</span>        QueryBuilder rightQuery <span class="token operator">=</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>rightExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼è¡¨ç¤ºçš„æ˜¯ä¸”çš„å…³ç³»</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>boolExprContext<span class="token punctuation">.</span><span class="token function">BOOLAND</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>leftQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>rightQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼è¡¨ç¤ºçš„æ˜¯æˆ–çš„å…³ç³»</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>leftQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>rightQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> QueryBuilder <span class="token function">parseEqExprContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>EqExprContext eqExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String field<span class="token punctuation">,</span> value<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å¦‚æœå·¦åŠè¾¹çš„å­—æ®µå€¼</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eqExprContext<span class="token punctuation">.</span>leftExpr <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>IdentityExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//è·å–è¯¥å­—æ®µå®é™…çš„æ˜ å°„å­—æ®µ</span>            field <span class="token operator">=</span> <span class="token function">parseIdentityContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>IdentityExprContext<span class="token punctuation">)</span> eqExprContext<span class="token punctuation">.</span>leftExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦åˆ™æŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸æ”¯æŒè¯¥æŸ¥è¯¢è¯­æ³•!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//å¦‚æœå³åŠè¾¹æ˜¯ä¸ªå€¼</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eqExprContext<span class="token punctuation">.</span>rightExpr <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>IdentityExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//åˆ™ä¸åŠ¨</span>            value <span class="token operator">=</span> <span class="token function">parseIdentityContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>IdentityExprContext<span class="token punctuation">)</span> eqExprContext<span class="token punctuation">.</span>rightExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦åˆ™æŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸æ”¯æŒè¯¥æŸ¥è¯¢è¯­æ³•!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//å¦‚æœæ¡ä»¶è¡¨è¾¾å¼çš„å…³è”æ¡ä»¶æ˜¯ä¸ç­‰äº</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eqExprContext<span class="token punctuation">.</span><span class="token function">NE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//åˆ™è°ƒç”¨must_not</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//å¦‚æœæ¡ä»¶è¡¨è¾¾å¼çš„å…³è”æ¡ä»¶æ˜¯å†’å·æˆ–è€…ç­‰äºå·</span>        <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£æå­—æ®µåå’Œå­—æ®µå€¼</span>    <span class="token keyword">private</span> String <span class="token function">parseIdentityContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>IdentityExprContext identityExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> identityExprContext<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£æèšç±»è¡¨è¾¾å¼</span>    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> <span class="token function">parseAggregationExpr</span><span class="token punctuation">(</span>String expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆèšç±»éå†æ ‘å®ä¾‹</span>        AggregateWalker walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AggregateWalker</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//éå†èšç±»è¡¨è¾¾å¼</span>        AggregateParser aggregateParser <span class="token operator">=</span> walker<span class="token punctuation">.</span><span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†èšç±»è¡¨è¾¾å¼è½¬æ¢æˆelasticsearchçš„aggregationbuilderçš„åˆ—è¡¨</span>        <span class="token keyword">return</span> <span class="token function">parseAggregationContext</span><span class="token punctuation">(</span>aggregateParser<span class="token punctuation">.</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> <span class="token function">parseAggregationContext</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>AggregateParser<span class="token punctuation">.</span>AggClauseContext<span class="token operator">></span> aggClauseContexts<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºaggregationbuilderç©ºåˆ—è¡¨</span>        List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> aggregationBuilders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ˜¯å¦æ”¯æŒèšç±»åˆ†é¡µï¼Œé»˜è®¤å€¼ä¸ºfalse</span>        <span class="token keyword">boolean</span> hasCompositeAggregation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºCompositeValuesSourceBuilderçš„åˆ—è¡¨</span>        List<span class="token operator">&lt;</span>CompositeValuesSourceBuilder<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> compositeValuesSourceBuilders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºafterkeyçš„map</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> afterKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å¯¹èšç±»è¡¨è¾¾å¼è¿›è¡Œéå†</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>AggregateParser<span class="token punctuation">.</span>AggClauseContext aggClauseContext <span class="token operator">:</span> aggClauseContexts<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚(ip)ï¼Œåˆ™è°ƒç”¨AggregationBuilders.cardinalityæ–¹æ³•ï¼Œå¹¶æ·»åŠ åˆ°èšç±»åˆ—è¡¨ä¸­</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">cardinalityAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//è·å–èšç±»å­—æ®µå</span>                String field <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">cardinalityAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//å°†è½¬æ¢åçš„å­—æ®µæºå…¥AggregationBuilders.cardinalityæ–¹æ³•ä¸­</span>                aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AggregationBuilders<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span>field <span class="token operator">+</span> <span class="token string">"_cardinality"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚country after æ¹–å—ï¼Œåˆ™è°ƒç”¨CompositeValuesSourceBuilderè¿›è¡Œèšç±»åˆ†é¡µ</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//è·å–å­—æ®µå€¼</span>                String field <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//å°†æ˜¯å¦èšç±»åˆ†é¡µå­—æ®µè®¾ç½®ä¸ºtrue</span>                hasCompositeAggregation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//è·å–afterçš„å€¼</span>                String after <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>after<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//è®¾ç½®æŸ¥è¯¢çš„åç§°</span>                String compositeField <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_composite"</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//ç”Ÿæˆèšç±»åˆ†é¡µçš„å®ä¾‹</span>                CompositeValuesSourceBuilder sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TermsValuesSourceBuilder</span><span class="token punctuation">(</span>compositeField<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//æ·»åŠ åˆ°èšç±»åˆ†é¡µçš„åˆ—è¡¨ä¸­</span>                compositeValuesSourceBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>                afterKeys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>compositeField<span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚[coordinate]ï¼Œåˆ™è¿›è¡Œåœ°ç†è¾¹æ¡†èšç±»</span>             <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">geoBoundingBoxAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//è·å–åœ°ç†å­—æ®µçš„å€¼</span>                String field <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">geoBoundingBoxAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//æ·»åŠ åˆ°èšç±»åˆ—è¡¨ä¸­</span>                aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AggregationBuilders<span class="token punctuation">.</span><span class="token function">geoBounds</span><span class="token punctuation">(</span>field <span class="token operator">+</span> <span class="token string">"_geoBound"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>             <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚ipï¼Œåˆ™å¯¹å…¶è¿›è¡Œæ¡¶èšç±»</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//å°†è½¬æ¢åçš„æ¡¶èšç±»å®ä¾‹æ·»åŠ åˆ°èšç±»åˆ—è¡¨ä¸­</span>                aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">parseTermsAggregationContext</span><span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¯·æ±‚ä¸­å­˜åœ¨èšç±»åˆ†é¡µ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasCompositeAggregation<span class="token punctuation">)</span> <span class="token punctuation">{</span>            CompositeAggregationBuilder composite <span class="token operator">=</span> AggregationBuilders<span class="token punctuation">.</span><span class="token function">composite</span><span class="token punctuation">(</span><span class="token string">"composites"</span><span class="token punctuation">,</span> compositeValuesSourceBuilders<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//åˆ™è®¾ç½®èšç±»åˆ†é¡µçš„å€¼ï¼Œä½†æ¯æ¬¡è¯·æ±‚åªæ”¯æŒä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ†é¡µ</span>            composite<span class="token punctuation">.</span><span class="token function">aggregateAfter</span><span class="token punctuation">(</span>afterKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>            aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>composite<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>compositeValuesSourceBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æš‚ä¸æ”¯æŒå¤šå­—æ®µåˆ†é¡µåŠŸèƒ½"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> aggregationBuilders<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£ææ¡¶èšç±»è¡¨è¾¾å¼ï¼Œå½¢å¦‚ip</span>    <span class="token keyword">private</span> AggregationBuilder <span class="token function">parseTermsAggregationContext</span><span class="token punctuation">(</span>AggregateParser<span class="token punctuation">.</span>TermsAggClauseContext termsAggClauseContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//è·å–å­—æ®µå</span>        String field <span class="token operator">=</span> termsAggClauseContext<span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆæ¡¶èšç±»å®ä¾‹</span>        AggregationBuilder aggregationBuilder <span class="token operator">=</span> AggregationBuilders<span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span>field <span class="token operator">+</span> <span class="token string">"_terms"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>termsAggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦‚æœæ¡¶èšç±»ä¸‹æœ‰å­èšç±»ï¼Œåˆ™æ·»åŠ å­èšç±»</span>            aggregationBuilder<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token function">parseTermsAggregationContext</span><span class="token punctuation">(</span>termsAggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> aggregationBuilder<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="7-å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch-DSL"><a href="#7-å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch-DSL" class="headerlink" title="(7). å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch DSL"></a>(7). å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch DSL</h4><blockquote><p>åœ¨mainæ–¹æ³•(æˆ–å…¶ä»–è°ƒç”¨è§£æå™¨çš„æ–¹æ³•)ä¸­</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    QueryParser queryParser<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">QueryParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//å°†æœç´¢æ¡ä»¶è½¬æ¢æˆQueryBuilder</span>    QueryBuilder queryBuilder <span class="token operator">=</span> queryParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"country:ä¸­å›½,province:æ¹–å—,city:å¼ å®¶ç•Œ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//ç„¶åå°†queryBuilderä¼ ç»™Elasticsearchè¿›è¡ŒæŸ¥è¯¢</span>    <span class="token comment" spellcheck="true">//å°†èšç±»æ¡ä»¶è½¬æ¢æˆList&lt;AggregationBuilder></span>    List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> aggregationBuilders <span class="token operator">=</span> queryParser<span class="token punctuation">.</span><span class="token function">parseAggregationExpr</span><span class="token punctuation">(</span><span class="token string">"country,(country),country>province>city,province after æ¹–å—"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//ç„¶åå°†aggregationBuildersä¼ ç»™Elasticsearchè¿›è¡Œèšç±»</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-æ¨èé˜…è¯»"><a href="#6-æ¨èé˜…è¯»" class="headerlink" title="6. æ¨èé˜…è¯»"></a>6. æ¨èé˜…è¯»</h3><p><a href="https://github.com/antlr/antlr4/blob/master/doc/index.md" target="_blank" rel="noopener">Antlr4å®˜æ–¹æŒ‡å—</a><br><a href="https://github.com/antlr/grammars-v4" target="_blank" rel="noopener">Antlr4å®˜æ–¹ç¤ºä¾‹:Grammars-v4</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è¿½æ¢¦å°‘å¹´</title>
      <link href="2020/09/17/zhui-meng-shao-nian/"/>
      <url>2020/09/17/zhui-meng-shao-nian/</url>
      
        <content type="html"><![CDATA[<center><h2 id="è¿½æ¢¦å°‘å¹´"><a href="#è¿½æ¢¦å°‘å¹´" class="headerlink" title="è¿½æ¢¦å°‘å¹´"></a>è¿½æ¢¦å°‘å¹´</h2><p>æˆ‘è¸è¿›ä¸€ç‰‡æ¢¦æƒ³çš„æµ·<br>é¥æœ›é‚£æ— å°½çš„è¾¹ç•Œ<br>æ±¹æ¶Œçš„æµ·æ°´æ³¢æ¶›æ¾æ¹ƒ<br>æˆ‘çš„å¿ƒå„¿å¾®èµ·æ¼ªæ¶Ÿ  </p><p>é‚£æ˜¯ä¸€ç‰‡æ€æ ·å¹¿é˜”çš„å¤©<br>å¤©ç©ºçš„äº‘æœµåœ¨ç»½æ”¾æ€æ ·çš„ç¬‘è„¸<br>é£˜é€¸çš„é£å„¿å‘¼å•¸è€Œè¿‡<br>è¡æ¼¾åœ¨ç©ºä¸­é£èˆç»µå»¶  </p><p>è¿™æ˜¯ä¸€ä¸ªå½©è‰²çš„ä¸–ç•Œ<br>é’é’çš„è‰åœ°å’Œä½èˆçš„è´è¶<br>æ¢¦å¹»èˆ¬çš„èŠ±æœµè£…æ‰®ç€é²œè‰³<br>ä½ æˆ‘ä»¿ä½›å›åˆ°é‚£ä¸ªçº¯çœŸçš„ç«¥å¹´  </p><p>ä¸€å¤©å¤©   ä¸€å¹´å¹´<br>æ¢¦æƒ³åœ¨æˆ‘ä»¬çš„é™¶é†‰ä¸­èµ°è¿œ<br>éš¾å‰²èˆçš„æ˜¯å‘¼å¸   ä¸¢ä¸æ‰çš„æ˜¯çœ·å¿µ<br>é£å„¿å¹è¿‡   ä»¿ä½›åˆå›åˆ°ç›¸é‡çš„é‚£ä¸ªå¤å¤©  </p><p>ä¸è¦å®³æ€•å¤±è´¥   ä¸è¦åœæ­¢å‘å‰<br>å¤©ä»æ—§å¾ˆè“   æ¢¦ä¾ç„¶å¾ˆç”œ<br>ç­‰å¾…æ—¶å…‰æµé€   å²æœˆå˜è¿<br>æˆ‘æƒ³æˆ‘ä»¬è¿˜æ˜¯<br>é‚£ä¸ªå‚»é‡Œå‚»æ°”   å‹‡æ•¢æ‰§ç€çš„å°‘å¹´  </p></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯—æ­Œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> åŸåˆ› </tag>
            
            <tag> 19å² </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‘é«˜ä¸‰å®£æˆ˜</title>
      <link href="2020/09/17/xiang-gao-san-xuan-zhan/"/>
      <url>2020/09/17/xiang-gao-san-xuan-zhan/</url>
      
        <content type="html"><![CDATA[<center><h2 id="å‘é«˜ä¸‰å®£æˆ˜"><a href="#å‘é«˜ä¸‰å®£æˆ˜" class="headerlink" title="å‘é«˜ä¸‰å®£æˆ˜"></a>å‘é«˜ä¸‰å®£æˆ˜</h2><p>æˆ‘çŸ¥é“å¤©ç©ºå¾ˆè“  æˆ‘çš„æ¢¦æƒ³ä¸ä¼šé»¯æ·¡<br>æˆ‘çŸ¥é“æµ·å²¸è¾½é˜”  ä¸ä¼šé˜»æ–­æˆ‘æ¢¦çš„ç¿…è†€  </p><p>å’¸é±¼ç¿»èº«  é‚£å†ä¹Ÿä¸æ˜¯ä¸€æ¡é¥è¿œçš„è·¯<br>é£æµç›´ä¸Š  æˆ‘å·²ç»çœ‹è§é‚£é€¼è¿‘çš„å…‰èŠ’  </p><p>èœ€é“è†æ£˜  æ¯”ä¸ä¸Šé«˜è€ƒé€”ä¸­çš„é•¿è·¯æ¼«æ¼«<br>é»„æ²³å¥”è…¾  åˆå“ªæœ‰è€ƒåœºä¸Šçš„åŠ¿å±€ç´§å¼   </p><p>å¤©å ‚,æˆ‘ä»¬ä¸Š  åœ°ç‹±,æˆ‘ä»¬é—¯<br>æˆ‘ä»¬æ‹¼æ  æˆ‘ä»¬æ­Œå”±  æˆ‘ä»¬ç•¥å¸¦ç€é‚£ä¹ˆä¸€ç‚¹ç‚¹åš£å¼   </p><p>é£è§è§  æ˜“æ°´å¯’  ä¸€å¹´ä¹‹åå†è§è°ç¬‘ä¸è°ä¼¤<br>365å¤©å·²ç»ä¸å†å®Œæ•´  çœ¼çœ‹ä¸‡é©¬é©°éª‹  åˆåœ¨äº‰å¤ºè°çš„å¤©ä¸‹  </p><p>æ¢¦æƒ³æ˜¯ç›´æµæŒºè¿›çš„å¸†  æ˜¯å¤§é›¨å€¾ç›†è€Œä¸‹çš„ç—´ç‹‚<br>è¿½æ±‚æ˜¯å¸ƒæ»¡è†æ£˜çš„è·¯  æ˜¯åˆ»ç€è¾›åŠ³ä¸å“è¶Šçš„å°ç«   </p><p>è¸ä¸Šé«˜ä¸‰  åƒä¸‡åˆ«æ…Œ<br>åœ¨è¿™æ¡å……æ»¡è¿·èŒ«çš„è·¯ä¸Š  æˆ‘ä»¬æœ‰è°é™ªä¼´<br>åˆæœ‰è°åœ¨ä¸ºæˆ‘ä»¬é¼“æŒ  </p><p>å¤¸å¥–,å…‰ç¯  æˆ‘ä»¬éƒ½ä¸èƒ½å› ä¹‹éª„å‚²è‡ªæ»¡<br>æ‚²ä¼¤,æƒ†æ€…  ä¹Ÿä¸èƒ½å—åˆ°ä»–ä»¬çš„æ‰“å‡»  è‚†æ„é¢“å”  </p><p>ä¸åˆ°æœ€åä¸€åˆ»  æˆ‘ä»¬ä¸èƒ½æ°”é¦<br>ä¸åˆ°æœ€åä¸€ç§’  æˆ‘ä»¬éƒ½è¦ç»§ç»­ç–¯ç‹‚  </p><p>æˆ‘ä»¬è¦å§‹ç»ˆåšä¿¡<br>é«˜è€ƒæœ‰å¤šç‹    æˆ‘ä»¬å°±æœ‰å¤šå¼º  </p></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯—æ­Œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> åŸåˆ› </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯»ä¹¦éƒ</title>
      <link href="2020/09/17/du-shu-lang/"/>
      <url>2020/09/17/du-shu-lang/</url>
      
        <content type="html"><![CDATA[<center><h2 id="è¯»ä¹¦éƒ"><a href="#è¯»ä¹¦éƒ" class="headerlink" title="è¯»ä¹¦éƒ"></a>è¯»ä¹¦éƒ</h2><p>æ…Œ<br>å—ä¼¤<br>æ›´ä½œè¯»<br>ä»¥ä¹¦ä¸ºä¼´<br>åŠå¤œæŠ¬å¤´çœ‹<br>ç¨€ç¨€æ”˜æ”˜ç¯å…‰<br>è¯»ä¹¦åå¹´å¯’çª—è‹¦<br>åªä¸ºè€ƒè¯•ä¸€åœº<br>å¸ˆç”Ÿæƒ…æ·±æ„é•¿<br>ä¸€å¹´ç›¸å¤„ä¸¤ä¸–éš¾å¿˜<br>å¤©å¤©æ¬¢ç¬‘åˆ°ç¥ä¼¤<br>äººç”Ÿè·¯æ¼«æ¼«é•¿<br>æ®‹é£å†·æœˆä¼´<br>è˜è˜å­¦å­<br>è¯´ä¸å°½<br>ä¸çˆ½<br>æ®‹ </p></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯—æ­Œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> åŸåˆ› </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‚è¯—</title>
      <link href="2020/09/17/mei-li-yi-yi-04/"/>
      <url>2020/09/17/mei-li-yi-yi-04/</url>
      
        <content type="html"><![CDATA[<center><h2 id="æ‚è¯—"><a href="#æ‚è¯—" class="headerlink" title="æ‚è¯—"></a>æ‚è¯—</h2><p>æ— å®šæ²³è¾¹æš®è§’å£°<br>èµ«è¿å°ç•”æ—…äººæƒ…<br>å‡½å…³æ—§è·¯åƒä½™é‡Œ<br>ä¸€å¤•ç§‹é£ç™½å‘ç”Ÿ  </p><h2 id="é­…åŠ›æ„è¯‘"><a href="#é­…åŠ›æ„è¯‘" class="headerlink" title="é­…åŠ›æ„è¯‘"></a>é­…åŠ›æ„è¯‘</h2><p>æ— å®šæ²³æµªæ»”æ»”  æš®è‰²è‹èŒ«<br>å·è§’å£°å£°  å†·é£å‘¼å•¸<br>æ²¡æœ‰æœˆäº®çš„å¤œæ™š<br>æ˜¯è°ä¸èµ«è¿å°ä¸€èµ·ç«™åˆ°è‹è€ï¼Ÿ<br>ä¸ºäº†é£Ÿä¸æœè…¹è¡£ä¸è”½ä½“çš„ä¸€å®¶è€å°<br>èµ°ä¸Šäº†è¿™æ¡ä¸å½’çš„è°‹ç”Ÿä¹‹é“<br>äº²å†è¿å¤©çƒ½ç«<br>å†’ç€é›ªå‰‘éœœåˆ€<br>çˆ¶æ¯å¯å¥åœ¨<br>å¦»å„¿å¯å®‰å¥½<br>å¤šå°‘æ¬¡æ¢¦å›å®¶ä¸­<br>å¬çˆ¶æ¯æ¸©é¦¨å” å¨<br>çœ‹å¦»å­æ½é•œè‡ªç…§<br>ä»»å„¿å¥³è†ä¸‹æ’’å¨‡<br>ä¸€è§‰é†’æ¥<br>æ‰å‘ç°ä¸æ•…ä¹¡ç›¸éš”åƒé‡Œ<br>ä»…ä»…ä¸€ä¸ªæ™šä¸Šçš„ç§‹é£<br>å¹å¾—å¤´ä¸Šçš„é’ä¸å˜æˆäº†é›ªèŠ±<br>é£˜é£˜é£˜é£˜  </p><center></center></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> é­…åŠ›æ„è¯‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> æ„è¯‘ </tag>
            
            <tag> æ‘˜å½• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è´ºæ–°éƒ - å¯„æä¼¯çºªä¸ç›¸</title>
      <link href="2020/09/17/mei-li-yi-yi-03/"/>
      <url>2020/09/17/mei-li-yi-yi-03/</url>
      
        <content type="html"><![CDATA[<center><h2 id="è´ºæ–°éƒ-å¯„æä¼¯çºªä¸ç›¸"><a href="#è´ºæ–°éƒ-å¯„æä¼¯çºªä¸ç›¸" class="headerlink" title="è´ºæ–°éƒ - å¯„æä¼¯çºªä¸ç›¸"></a>è´ºæ–°éƒ - å¯„æä¼¯çºªä¸ç›¸</h2><p>æ›³æ–å±æ¥¼å»ï¼Œæ–—å‚å¤©ï¼Œæ²§æ³¢ä¸‡é¡·ï¼ŒæœˆæµçƒŸæ¸šã€‚<br>æ‰«å°½æµ®äº‘é£ä¸å®šï¼Œæœªæ”¾æ‰èˆŸå¤œæ¸¡ã€‚å®¿é›è½å¯’èŠ¦æ·±å¤„ã€‚<br>æ€…æœ›å…³æ²³ç©ºåŠå½±ï¼Œæ­£äººé—´é¼»æ¯é¼é¼“ã€‚è°ä¼´æˆ‘ï¼Œé†‰ä¸­èˆï¼Ÿ  </p><p>åå¹´ä¸€æ¢¦æ‰¬å·è·¯ã€‚å€šé«˜å¯’,æ„ç”Ÿæ•…å›½ï¼Œæ°”åéª„è™ã€‚<br>è¦æ–©æ¥¼å…°ä¸‰å°ºå‰‘ï¼Œé—æ¨çµç¶æ—§è¯­ã€‚è°©æš—æ¶©é“œåå°˜åœŸã€‚<br>å”¤å–è°ªä»™å¹³ç« çœ‹ï¼Œè¿‡è‹•æºªå°šè®¸å‚çº¶å¦ï¼Ÿé£æµ©è¡ï¼Œæ¬²é£ä¸¾ã€‚  </p><h2 id="é­…åŠ›æ„è¯‘"><a href="#é­…åŠ›æ„è¯‘" class="headerlink" title="é­…åŠ›æ„è¯‘"></a>é­…åŠ›æ„è¯‘</h2><p>æ›³æ–ç‹¬ç«‹é«˜æ¥¼ï¼Œçœºæœ›ä¸çœ çš„æ˜Ÿæ–—ã€‚<br>è€³ç•”æ˜¯æ²§æ¡‘çš„æ³¢æ¶›ï¼Œå¦‚æ°´çš„æ˜æœˆï¼Œ<br>æµæ³»åœ¨çƒŸé›¾ç¼­ç»•çš„æ±Ÿä¸­å°èˆŸã€‚<br>é£å‘è°èƒ½å®šï¼Œæµ®äº‘ä½•å¤„ç•™ã€‚<br>è°åœ¨æŒ¥åŠ¨é˜´éœ¾çš„å·¨æ‰‹ï¼Ÿ<br>é£æ€¥æµªé«˜ï¼Œè°äººæ•¢å¼„èˆŸã€‚<br>åªæœ‰æ˜¨å¤œçš„å¤§é›ï¼Œä»Šå¤œåœ¨å¯’å†·çš„èŠ¦è‹‡æ·±å¤„é€—ç•™ã€‚<br>æ€…æœ›å†·è½å…³æ²³ï¼Œè°çš„å½±å­åœ¨å¾˜å¾Šï¼Œ<br>è°åœ¨æ¢¦é‡Œé¼¾å£°ç¨ ï¼Ÿ<br>è°åœ¨æ•æˆˆå¾…æ—¦æ•²æˆ˜é¼“ï¼Œ<br>è°åœ¨ä¼´æˆ‘é†‰é‡ŒæŒ¥å‰‘èˆæ¸…ç§‹ï¼Ÿ<br>åå¹´ä»…ä¸€æ¢¦ï¼Œå…³ä¹æ‰¬å·è·¯ã€‚<br>é«˜å¤„ä¸èƒœå¯’ï¼Œæ•…å›½å¤„å¤„æ„ã€‚<br>æ‰‹æä¸‰å°ºå‰‘ï¼Œæ–©æ€æ¥¼å…°åæ•Œå¯‡ï¼Œ<br>å°˜åœŸé£æ‰¬æ‚²å£®ã€‚<br>é»¯æ·¡äº†å²æœˆé”ˆèš€äº†é“ ç”²ï¼Œç›´æ•™è°ªä»™ä¿¯é¦–ã€‚<br>æ¸…æ¸…è‹•æºªä¸Šï¼Œä¹˜å…´å‚é’“é’©ï¼Œ<br>é±¼åŒ–è›Ÿé¾™æ¬²é£å»ï¼Œ<br>æµ©è¡ä¹‹é£èµ·ç¥å·ã€‚  </p></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> é­…åŠ›æ„è¯‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> æ„è¯‘ </tag>
            
            <tag> æ‘˜å½• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç™»é«˜</title>
      <link href="2020/09/17/mei-li-yi-yi-02/"/>
      <url>2020/09/17/mei-li-yi-yi-02/</url>
      
        <content type="html"><![CDATA[<center><h2 id="ç™»é«˜"><a href="#ç™»é«˜" class="headerlink" title="ç™»é«˜"></a>ç™»é«˜</h2><p>é£æ€¥å¤©é«˜çŒ¿å•¸å“€ï¼Œæ¸šæ¸…æ²™ç™½é¸Ÿé£å›ã€‚<br>æ— è¾¹è½æœ¨è§è§ä¸‹ï¼Œä¸å°½é•¿æ±Ÿæ»šæ»šæ¥ã€‚<br>ä¸‡é‡Œæ‚²ç§‹å¸¸ä½œå®¢ï¼Œç™¾å¹´å¤šç—…ç‹¬ç™»å°ã€‚<br>è‰°éš¾è‹¦æ¨ç¹éœœé¬“ï¼Œæ½¦å€’æ–°åœæµŠé…’æ¯ã€‚  </p><h2 id="é­…åŠ›æ„è¯‘"><a href="#é­…åŠ›æ„è¯‘" class="headerlink" title="é­…åŠ›æ„è¯‘"></a>é­…åŠ›æ„è¯‘</h2><p>å¯’é£åœ¨ç©ºä¸­é£é©°å‡›å†½<br>çŒ¿çŒ´åœ¨ç»å£ä¸Šä»°èº«å•¸å¤©<br>æ°´ä¸­é«˜åœ°æ¸…æ²™å¼¥æ¼«<br>æ”¾é£çš„é¸Ÿå„¿åœ¨é£ä¸­ä½èˆç›˜æ—‹<br>é‚£é£˜é£˜è€Œä¸‹çš„è½å¶<br>æ˜¯æˆ‘å¯¹å¦»å„¿æ·±æ·±çš„æ€å¿µ<br>åœ¨é‚£å¥”è…¾å‘¼å•¸çš„æ±Ÿè¾¹<br>å†™æ»¡äº†æˆ‘å¯¹å›½å®¶å‘½è¿çš„æŒ‚ç‰µ<br>ä¸‡é‡Œå¾é€”è¯´ä¸å°½å®¢å±…ä»–ä¹¡çš„è¾›é…¸æ— é™<br>å¤šç—…çš„èº«èº¯å´é…¿å°±äº†ä¸€éƒ¨éƒ¨è„ç‚™äººå£çš„ä¼Ÿå¤§è¯—ç¯‡<br>åœ¨é‚£æ–‘é©³çš„æœˆå¤œ<br>ç‹¬å€šåœ¨æ±Ÿè¾¹<br>æ‹¿èµ·ç†Ÿæ‚‰çš„é…’æ¯<br>ç‹ ç‹ åœ°æ‘”ç¢<br>ç«‹ä¸‹èª“è¨€<br>æˆ‘å°†é€æ³¢è¸æµª   å¥‹å‹‡å‘å‰<br>å»è¿½å¯»æˆ‘çš„ç†æƒ³   è¿½é€æˆ‘çš„æ˜å¤©  </p></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> é­…åŠ›æ„è¯‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> åŸåˆ› </tag>
            
            <tag> æ„è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é”¦ç‘Ÿ</title>
      <link href="2020/09/17/mei-li-yi-yi-01/"/>
      <url>2020/09/17/mei-li-yi-yi-01/</url>
      
        <content type="html"><![CDATA[<center><h2 id="é”¦ç‘Ÿ"><a href="#é”¦ç‘Ÿ" class="headerlink" title="é”¦ç‘Ÿ"></a>é”¦ç‘Ÿ</h2><p>é”¦ç‘Ÿæ— ç«¯äº”åå¼¦<br>ä¸€å¼¦ä¸€æŸ±æ€åå¹´<br>åº„ç”Ÿæ™“æ¢¦è¿·è´è¶<br>æœ›å¸æ˜¥å¿ƒæ‰˜æœé¹ƒ<br>æ²§æµ·æœˆæ˜ç æœ‰æ³ª<br>è“ç”°æ—¥æš–ç‰ç”ŸçƒŸ<br>æ­¤æƒ…å¯å¾…æˆè¿½å¿†<br>åªæ˜¯å½“æ—¶å·²æƒ˜ç„¶  </p><h2 id="é­…åŠ›æ„è¯‘"><a href="#é­…åŠ›æ„è¯‘" class="headerlink" title="é­…åŠ›æ„è¯‘"></a>é­…åŠ›æ„è¯‘</h2><p>ç¾ä¸½çš„å¤ç‘Ÿä¸ä¼šæ— ç”±çš„æœ‰äº”åæ ¹å¼¦<br>æ‹¨åŠ¨è¿™ä¸€æ ¹åˆä¸€æ ¹çš„å¼¦<br>æ— é™çš„æ„æ€å¯„æ‰˜åœ¨ä¸Šé¢,è¿½æº¯åˆ°ä»å‰<br>é¥æƒ³å½“å¹´<br>åº„å‘¨å…¥æ¢¦å¹»åŒ–ä¸ºè¶<br>å¾œå¾‰åœ¨ç‰©æˆ‘ä¸¤å¿˜çš„å¢ƒç•Œ<br>æœé¹ƒæ³£è¡€<br>ä¼¤æ˜¥ä¹‹å¿ƒå´ä¾ç„¶ç•™æ‹æ˜¨å¤©<br>é‚£ç‹‚æ€’çš„å¤§æµ·  å­¤å‚²çš„æ˜æœˆ<br>è¿é‚£åŠ¨äººçš„æ³ªç éƒ½é‚£ä¹ˆçš„æ˜äº®å…‰é²œ<br>è€Œé‚£æœ€ä»¤äººæ²‰è¿·çš„ç•™æ‹<br>å´åˆå¦‚è“ç”°æ—¥æš–  è‰¯ç‰ç”ŸçƒŸ<br>å¯æœ›è€Œä¸å¯ç½®äºçœ‰ç«ä¹‹å‰<br>æ»¡è‚šçš„è‹¦æ¥š  æ— å¤„å¯è¯‰<br>é‚£æ—·ä¸–ç»ä¼¦çš„çˆ±æ‹ å´ä¿¨ç„¶å¹»ç­<br>éš¾é“éè¦æˆ‘å­¤ç‹¬æ— ä¾ å«æ¨ç»ˆç”Ÿ<br>æ‰å¯¹å¾—èµ·ä½ çš„æ— ç§å¥‰çŒ®<br>åæ¥æƒ³æƒ³  æ‰çªç„¶äº†è§£<br>è¿™ä¸€åˆ‡çš„ä¸€åˆ‡<br>åªä¸è¿‡æ˜¯æˆ‘ä»¬è‡ªå·±ç»™è‡ªå·±å¥—äº†ä¸€ä¸ªåœˆ  </p></center><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> é­…åŠ›æ„è¯‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯—è¯ </tag>
            
            <tag> åŸåˆ› </tag>
            
            <tag> æ„è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>address-already-in-use</title>
      <link href="2020/04/05/address-already-in-use/"/>
      <url>2020/04/05/address-already-in-use/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸Šå‘¨é‡åˆ°ä¸ªç†Ÿæ‚‰çš„é—®é¢˜<code>Address already in use: bind</code>ï¼Œæœ¬æ¥ä»¥ä¸ºæ˜¯ä¸ªç®€å•çš„ç«¯å£å ç”¨é—®é¢˜ï¼Œæ²¡æƒ³åˆ°èŠ±äº†å¾ˆé•¿æ—¶é—´æ‰è§£å†³ï¼Œé¿å…ä»¥åå†æ¬¡å…¥å‘ï¼Œç‰¹æ­¤è®°å½•ã€‚</p></blockquote><h3 id="å¸¸è§„ç«¯å£å ç”¨"><a href="#å¸¸è§„ç«¯å£å ç”¨" class="headerlink" title="å¸¸è§„ç«¯å£å ç”¨"></a>å¸¸è§„ç«¯å£å ç”¨</h3><p>windows</p><blockquote><p>netstat -ano|findstr ${ç«¯å£å·}      #æŸ¥æ‰¾ç«¯å£<br> taskkill /f /pid ${ç«¯å£å·}   #æ€æ­»è¿›ç¨‹</p></blockquote><p>Linux &amp; Mac</p><blockquote><p>lsof -i:${ç«¯å£å·}<br>kill -9 ${ç«¯å£å·}</p></blockquote><h3 id="Hyper-Vä¿ç•™ç«¯å£"><a href="#Hyper-Vä¿ç•™ç«¯å£" class="headerlink" title="Hyper-Vä¿ç•™ç«¯å£"></a>Hyper-Vä¿ç•™ç«¯å£</h3><p>è¿™æ¬¡é‡åˆ°ç«¯å£å ç”¨é—®é¢˜ï¼Œæ˜¯åœ¨ç¬”è®°æœ¬è¢«å¼ºåˆ¶æ›´æ–°ä¹‹åé‡åˆ°çš„(Windows10ç³»ç»Ÿ)ï¼Œç”¨äº†ä¸Šè¿°çš„æ–¹æ³•æ€ä¹ˆä¹Ÿä¸å¥½ä½¿ï¼Œæœ‰äººè¯´ç”¨ç®¡ç†å‘˜æ‰§è¡Œ<code>netsh winsock reset</code>ï¼Œç„¶åæœºå™¨é‡å¯å°±è¡Œäº†ã€‚å¯æ˜¯æˆ‘æ‰§è¡Œåé‡å¯äº†5ï¼Œ6æ¬¡ï¼Œç¨‹åºä¾ç„¶è¿˜æ˜¯æŠ¥<code>Address already in use: bind</code>ã€‚è¿™æ—¶å€™æˆ‘å°±æ¯”è¾ƒè¿·æƒ‘äº†ï¼Œä¸€èˆ¬è¯´ç¨‹åºå‘˜3å¤§æ³•å®ï¼š<code>é‡å¯ç¨‹åº</code>ï¼Œ<code>é‡å¯ç”µè„‘</code>ï¼Œ<code>é‡è£…ç³»ç»Ÿ</code>ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯è§£å†³ä¸äº†çš„ã€‚å› ä¸ºæ˜¯å…¬å¸ç”µè„‘ï¼Œé‡è£…ç³»ç»Ÿæ˜¯ä¸å¯èƒ½çš„äº†ã€‚é‡å¯ç¨‹åºå’Œç”µè„‘æˆ‘è¯•äº†ä¸ä¸‹10éï¼Œé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œè¿™æ—¶å€™äººå°±æ¯”è¾ƒæ…Œäº†ã€‚</p><p>åæ¥ä¸ŠGithubæœç´¢å¯èƒ½æ˜¯<code>Hyper-V</code>çš„é—®é¢˜ï¼ŒæŒ‰ç…§<a href="https://github.com/docker/for-win/issues/3171" target="_blank" rel="noopener">issue: Unable to bind ports</a>çš„æ–¹å¼æŸ¥çœ‹å‘ç°æˆ‘ç¨‹åºçš„å¯åŠ¨ç«¯å£åœ¨<code>Hyper-V</code>çš„ä¿ç•™ç«¯å£çš„èŒƒå›´ä¹‹å†…ï¼Œäºæ˜¯ä¹è™½ç„¶ç«¯å£æ²¡è¢«å ç”¨ï¼Œä½†æ˜¯ç¨‹åºä¾ç„¶ä¼šæŠ¥<code>Address already in use: bind</code>ã€‚äºæ˜¯æŠŠ<code>Hyper-V</code>å¸äº†ï¼Œé‡å¯ç”µè„‘é—®é¢˜è§£å†³ã€‚</p><h4 id="æŸ¥æ‰¾Hyper-Vä¿ç•™ç«¯å£èŒƒå›´"><a href="#æŸ¥æ‰¾Hyper-Vä¿ç•™ç«¯å£èŒƒå›´" class="headerlink" title="æŸ¥æ‰¾Hyper-Vä¿ç•™ç«¯å£èŒƒå›´"></a>æŸ¥æ‰¾<code>Hyper-V</code>ä¿ç•™ç«¯å£èŒƒå›´</h4><p>åœ¨<code>cmd</code>æ‰§è¡Œ</p><blockquote><p>netsh interface ipv4 show excludedportrange protocol=tcp</p></blockquote><p>è¿”å›</p><pre><code>Protocol tcp Port Exclusion RangesStart Port    End Port----------    --------     49692       49791     49792       49891     49892       49991     49992       50091     50092       50191     50214       50313     50498       50597* - Administered port exclusions.</code></pre><h4 id="issueæä¾›çš„è§£å†³æ–¹æ³•"><a href="#issueæä¾›çš„è§£å†³æ–¹æ³•" class="headerlink" title="issueæä¾›çš„è§£å†³æ–¹æ³•"></a>issueæä¾›çš„è§£å†³æ–¹æ³•</h4><ol><li>ç¦ç”¨<code>Hyper-V</code>ï¼ˆéœ€è¦2æ¬¡é‡å¯ï¼‰</li></ol><blockquote><p>dism.exe /Online /Disable-Feature:Microsoft-Hyper-V</p></blockquote><ol start="2"><li>é‡å¯ç»“æŸä¹‹åï¼Œä¿ç•™ä½ æƒ³è¦çš„ç«¯å£ä½¿<code>Hyper-V</code>æ— æ³•å ç”¨è¯¥ç«¯å£</li></ol><blockquote><p>netsh int ipv4 add excludedportrange protocol=tcp startport=50051 numberofports=1</p></blockquote><ol start="3"><li>é‡å¯<code>Hyper-V</code>ï¼ˆè¿˜æ˜¯éœ€è¦é‡å¯ï¼‰</li></ol><blockquote><p>dism.exe /Online /Enable-Feature:Microsoft-Hyper-V /All</p></blockquote><p>ç„¶åä½ å°±ä¼šå‘ç°ç¨‹åºå¯ä»¥æ­£å¸¸çš„å¯åŠ¨äº†</p><p>å› ä¸ºæˆ‘ç”¨ä¸åˆ°<code>Hyper-V</code>ï¼Œæ‰€ä»¥ç›´æ¥å¸è½½äº†<code>Hyper-V</code>ã€‚</p><p>äº‹åæ„Ÿå¹ï¼šWindowsæ›´æ–°çœŸçš„å¾ˆå‘å‘€ï¼ï¼ï¼ </p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> çˆ¬å‡ºæ·±å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> address-already-in-use </tag>
            
            <tag> port </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè™šæ‹ŸæœºæŒ‡ä»¤é›†</title>
      <link href="2020/03/22/jvm-instructions/"/>
      <url>2020/03/22/jvm-instructions/</url>
      
        <content type="html"><![CDATA[<h3 id="aaload-50-0x32"><a href="#aaload-50-0x32" class="headerlink" title="aaload (50,0x32)"></a>aaload (50,0x32)</h3><blockquote><p>ä»æ•°ç»„ä¸­è£…è½½å¼•ç”¨ç±»å‹</p></blockquote><h4 id="1-æ“ä½œæ•°æ ˆ"><a href="#1-æ“ä½œæ•°æ ˆ" class="headerlink" title="1. æ“ä½œæ•°æ ˆ"></a>1. æ“ä½œæ•°æ ˆ</h4><blockquote><p>pop: <code>arrayref</code>,<code>index</code><br>push: <code>value</code>  </p></blockquote><p><code>arrayref</code>å¿…é¡»æ˜¯å¼•ç”¨ç±»å‹<code>R[]</code>ï¼Œå¹¶ä¸”å¿…é¡»æŒ‡å‘å…ƒç´ ä¸ºå¼•ç”¨ç±»å‹<code>R</code>çš„æ•°ç»„ã€‚ç´¢å¼•å¿…é¡»æ˜¯<code>int</code>ç±»å‹ã€‚<br><code>arrayref</code>å’Œ<code>index</code>ä»æ“ä½œæ•°æ ˆä¸­å¼¹å‡ºï¼Œæ•°ç»„ä¸­ç´¢å¼•ä¸º<code>index</code>çš„å¼•ç”¨å€¼(<code>value</code>)è¢«æ£€ç´¢åˆ°å¹¶æ¨å…¥åˆ°æ“ä½œæ•°æ ˆä¸­ã€‚</p><h3 id="1-å­—èŠ‚ç è§£è¯»ç¤ºä¾‹"><a href="#1-å­—èŠ‚ç è§£è¯»ç¤ºä¾‹" class="headerlink" title="-1. å­—èŠ‚ç è§£è¯»ç¤ºä¾‹"></a>-1. å­—èŠ‚ç è§£è¯»ç¤ºä¾‹</h3><p>åœ¨mainå‡½æ•°ä¸­å£°æ˜ä¸€ä¸ªé•¿åº¦ä¸º1çš„æ•°ç»„ï¼Œå¹¶ç»™ç´¢å¼•ä¸º0çš„é¡¹èµ‹å€¼ï¼Œç„¶åæ ¹æ®ç´¢å¼•0è°ƒç”¨è¯¥å€¼èµ‹ç»™æŸä¸ªå˜é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>asm<span class="token punctuation">.</span>instructions<span class="token punctuation">.</span>aaload<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Aaload</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    String name <span class="token operator">=</span> <span class="token string">"aaload"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello asm"</span><span class="token punctuation">;</span>        Object object <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œmainå‡½æ•°æˆ–æ‰§è¡Œ<code>javac Aaload.java</code>ç”Ÿæˆ<code>Aaload.class</code>æ–‡ä»¶ï¼Œå¹¶åœ¨<code>Aaload.class</code>æ–‡ä»¶åŒçº§ç›®å½•æ‰§è¡Œ<code>javap -verbose Aaload</code>ï¼Œç”Ÿæˆå¦‚ä¸‹å­—èŠ‚ç ä¿¡æ¯ã€‚</p><pre><code>Warning: File ./Aaload.class does not contain class AaloadClassfile /Users/iamazy/Documents/GitHub/asm-tutorial/target/classes/io/github/iamazy/asm/instructions/aaload/Aaload.class  Last modified Mar 22, 2020; size 804 bytes  SHA-256 checksum 7ebc42d18bc4fc81d44ab57f7492aa00e500f1a0fb02c2f71f8be359ca78d102  Compiled from "Aaload.java"public class io.github.iamazy.asm.instructions.aaload.Aaload implements java.io.Serializable  minor version: 0  major version: 52  flags: (0x0021) ACC_PUBLIC, ACC_SUPER  this_class: #8                          // io/github/iamazy/asm/instructions/aaload/Aaload  super_class: #4                         // java/lang/Object  interfaces: 1, fields: 1, methods: 2, attributes: 1Constant pool:   #1 = Methodref          #4.#29         // java/lang/Object."&lt;init&gt;":()V   #2 = String             #30            // aaload   #3 = Fieldref           #8.#31         // io/github/iamazy/asm/instructions/aaload/Aaload.name:Ljava/lang/String;   #4 = Class              #32            // java/lang/Object   #5 = String             #33            // hello asm   #6 = Fieldref           #34.#35        // java/lang/System.out:Ljava/io/PrintStream;   #7 = Methodref          #36.#37        // java/io/PrintStream.println:(Ljava/lang/Object;)V   #8 = Class              #38            // io/github/iamazy/asm/instructions/aaload/Aaload   #9 = Class              #39            // java/io/Serializable  #10 = Utf8               name  #11 = Utf8               Ljava/lang/String;  #12 = Utf8               &lt;init&gt;  #13 = Utf8               ()V  #14 = Utf8               Code  #15 = Utf8               LineNumberTable  #16 = Utf8               LocalVariableTable  #17 = Utf8               this  #18 = Utf8               Lio/github/iamazy/asm/instructions/aaload/Aaload;  #19 = Utf8               main  #20 = Utf8               ([Ljava/lang/String;)V  #21 = Utf8               args  #22 = Utf8               [Ljava/lang/String;  #23 = Utf8               objects  #24 = Utf8               [Ljava/lang/Object;  #25 = Utf8               object  #26 = Utf8               Ljava/lang/Object;  #27 = Utf8               SourceFile  #28 = Utf8               Aaload.java  #29 = NameAndType        #12:#13        // "&lt;init&gt;":()V  #30 = Utf8               aaload  #31 = NameAndType        #10:#11        // name:Ljava/lang/String;  #32 = Utf8               java/lang/Object  #33 = Utf8               hello asm  #34 = Class              #40            // java/lang/System  #35 = NameAndType        #41:#42        // out:Ljava/io/PrintStream;  #36 = Class              #43            // java/io/PrintStream  #37 = NameAndType        #44:#45        // println:(Ljava/lang/Object;)V  #38 = Utf8               io/github/iamazy/asm/instructions/aaload/Aaload  #39 = Utf8               java/io/Serializable  #40 = Utf8               java/lang/System  #41 = Utf8               out  #42 = Utf8               Ljava/io/PrintStream;  #43 = Utf8               java/io/PrintStream  #44 = Utf8               println  #45 = Utf8               (Ljava/lang/Object;)V{  java.lang.String name;    descriptor: Ljava/lang/String;    flags: (0x0000)  public io.github.iamazy.asm.instructions.aaload.Aaload();    descriptor: ()V    flags: (0x0001) ACC_PUBLIC    Code:      stack=2, locals=1, args_size=1         0: aload_0         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V         4: aload_0         5: ldc           #2                  // String aaload         7: putfield      #3                  // Field name:Ljava/lang/String;        10: return      LineNumberTable:        line 5: 0        line 7: 4      LocalVariableTable:        Start  Length  Slot  Name   Signature            0      11     0  this   Lio/github/iamazy/asm/instructions/aaload/Aaload;  public static void main(java.lang.String[]);    descriptor: ([Ljava/lang/String;)V    flags: (0x0009) ACC_PUBLIC, ACC_STATIC    Code:      stack=3, locals=3, args_size=1         0: iconst_1         1: anewarray     #4                  // class java/lang/Object         4: astore_1         5: aload_1         6: iconst_0         7: ldc           #5                  // String hello asm         9: aastore        10: aload_1        11: iconst_0        12: aaload        13: astore_2        14: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;        17: aload_2        18: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/Object;)V        21: return      LineNumberTable:        line 10: 0        line 11: 5        line 12: 10        line 13: 14        line 14: 21      LocalVariableTable:        Start  Length  Slot  Name   Signature            0      22     0  args   [Ljava/lang/String;            5      17     1 objects   [Ljava/lang/Object;           14       8     2 object   Ljava/lang/Object;}SourceFile: "Aaload.java"</code></pre><p>æœ‰ä¸Šè¿°ä¿¡æ¯å¯çŸ¥ï¼š</p><h5 id="1-æŒ‡å®šclassæ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å·"><a href="#1-æŒ‡å®šclassæ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å·" class="headerlink" title="1. æŒ‡å®šclassæ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å·"></a>1. æŒ‡å®šclassæ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å·</h5><p>Aaload.classæ–‡ä»¶çš„classæ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å·æ˜¯52.0  </p><h5 id="2-æ˜¾ç¤ºç±»è®¿é—®æ ‡è®°ç¬¦çš„å€¼"><a href="#2-æ˜¾ç¤ºç±»è®¿é—®æ ‡è®°ç¬¦çš„å€¼" class="headerlink" title="2. æ˜¾ç¤ºç±»è®¿é—®æ ‡è®°ç¬¦çš„å€¼"></a>2. æ˜¾ç¤ºç±»è®¿é—®æ ‡è®°ç¬¦çš„å€¼</h5><p>ç±»çš„<code>access_flags</code>ä¸º<code>ACC_PUBLIC+ACC_SUPER</code>=<code>0x0001+0x0020</code>=<code>0x0021</code>  (ACC_XXXå¯¹åº”çš„å€¼è§<a href="https://iamazy.github.io/2020/03/17/jdk-class-file/">access_flags</a>)  </p><h5 id="3-æ˜¾ç¤ºç±»çš„åŸºæœ¬ä¿¡æ¯"><a href="#3-æ˜¾ç¤ºç±»çš„åŸºæœ¬ä¿¡æ¯" class="headerlink" title="3. æ˜¾ç¤ºç±»çš„åŸºæœ¬ä¿¡æ¯"></a>3. æ˜¾ç¤ºç±»çš„åŸºæœ¬ä¿¡æ¯</h5><p>interfaces: 1 (impl <code>Serializable</code>), fields: 1 (<code>name</code>), methods: 2 (<code>&lt;init&gt;</code>,<code>main</code>), attributes: 1 ()  </p><h5 id="4-æ˜¾ç¤ºäº†å¸¸é‡æ± ä¸­å…·ä½“çš„ä¿¡æ¯"><a href="#4-æ˜¾ç¤ºäº†å¸¸é‡æ± ä¸­å…·ä½“çš„ä¿¡æ¯" class="headerlink" title="4. æ˜¾ç¤ºäº†å¸¸é‡æ± ä¸­å…·ä½“çš„ä¿¡æ¯"></a>4. æ˜¾ç¤ºäº†å¸¸é‡æ± ä¸­å…·ä½“çš„ä¿¡æ¯</h5><p>å¦‚å¸¸é‡æ± ç¬¬ä¸€è¡Œ</p><blockquote><p><code>#1 = Methodref          #4.#29         // java/lang/Object."&lt;init&gt;":()V</code>  </p></blockquote><p>å«ä¹‰ï¼šå¸¸é‡æ± ä¸­ç¬¬ä¸€é¡¹çš„ç±»å‹ä¸º<code>CONSTANT_Methodref_info</code>ï¼Œå®ƒçš„å€¼æ˜¯<code>#4.#29</code>(å¾€ä¸‹æ‰¾ç¬¬4é¡¹å’Œç¬¬29é¡¹)ï¼Œå³<code>java/lang/Object."&lt;init&gt;":()V</code></p><h5 id="5-ç±»å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#5-ç±»å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="5. ç±»å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹"></a>5. ç±»å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹</h5><p>åœ¨ç”Ÿæˆçš„<code>Aaload.class</code>æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ç±»<code>Aaload</code>çš„æ— å‚æ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ç¨‹åºå…¥å£<code>main</code>å‡½æ•°ã€‚</p><ol><li><p><code>Aaload</code>çš„æ— å‚æ„é€ å‡½æ•°å¯¹åº”çš„å­—èŠ‚ç ä¿¡æ¯</p><pre><code>public io.github.iamazy.asm.instructions.aaload.Aaload(); descriptor: ()V flags: (0x0001) ACC_PUBLIC Code:   stack=2, locals=1, args_size=1    //å¯çŸ¥æ“ä½œæ•°æ ˆé•¿åº¦ä¸º2ï¼Œæœ¬åœ°å˜é‡è¡¨é•¿åº¦ä¸º1ï¼Œå‚æ•°åˆ—è¡¨é•¿åº¦ä¸º1      0: aload_0                     //ä»æœ¬åœ°å˜é‡è¡¨ä¸­åŠ è½½ç´¢å¼•ä¸º0å˜é‡çš„å€¼ï¼Œä¹Ÿå³thisçš„å¼•ç”¨ï¼Œå‹å…¥æ ˆ      1: invokespecial #1            //å‡ºæ ˆï¼Œä½¿ç”¨invokespecialæŒ‡ä»¤è°ƒç”¨æ„é€ å‡½æ•°(java/lang/Object."&lt;init&gt;":()V),å¹¶åˆå§‹åŒ–å¯¹è±¡      4: aload_0                     //åŒä¸Šï¼Œè°ƒç”¨this.name="aaload",å¹¶å°†thisçš„å¼•ç”¨å‹å…¥æ ˆ      5: ldc           #2            //å°†å­—ç¬¦ä¸²"aaload"å¸¸é‡å‹å…¥æ ˆ      7: putfield      #3            //å‡ºæ ˆå‰é¢å‹å…¥çš„ä¸¤ä¸ªå€¼(thiså¼•ç”¨ï¼Œå­—ç¬¦ä¸²"aaload")ï¼Œå¹¶å°†å­—ç¬¦ä¸²"aaload"èµ‹å€¼ç»™this.name     10: return   LineNumberTable:     line 5: 0     line 7: 4   LocalVariableTable:     Start  Length  Slot  Name   Signature         0      11     0  this   Lio/github/iamazy/asm/instructions/aaload/Aaload;</code></pre><p>å…¶ä¸­ï¼š<code>LineNumberTable</code>è¡¨ç¤ºä»£ç è¡Œå·ä¸æŒ‡ä»¤çš„å¯¹åº”å…³ç³»ï¼Œå‰é¢ä¸€ä¸ªæ•°å­—è¡¨ç¤ºä»£ç è¡Œå·ï¼Œåé¢ä¸€ä¸ªæ•°å­—è¡¨ç¤ºå‰é¢codeå¯¹åº”çš„æŒ‡ä»¤ä»£å·ã€‚<code>LocalVariableTable</code>è¡¨ç¤ºæœ¬åœ°å˜é‡è¡¨ï¼Œè¿™é‡Œåªå­˜äº†ä¸€ä¸ª<code>this</code>çš„å¼•ç”¨ï¼Œç±»å‹æè¿°ä¸º<code>Lio/github/iamazy/asm/instructions/aaload/Aaload</code>ï¼Œ<code>start+length</code>è¡¨ç¤ºè¿™ä¸ªå˜é‡åœ¨å­—èŠ‚ç ä¸­çš„ç”Ÿå‘½å‘¨æœŸèµ·å§‹å’Œç»“æŸçš„åç§»é‡(thiså£°æ˜å‘¨æœŸä¸ºå¼€å§‹0åˆ°ç»“æŸ11)ï¼Œslotè¡¨ç¤ºè¿™ä¸ªå˜é‡åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½(æ§½ä½å¯ä»¥å¤ç”¨)ã€‚</p></li><li><p><code>main</code>å‡½æ•°å¯¹åº”çš„å­—èŠ‚ç ä¿¡æ¯</p><pre><code>public static void main(java.lang.String[]); descriptor: ([Ljava/lang/String;)V flags: (0x0009) ACC_PUBLIC, ACC_STATIC Code:   stack=3, locals=3, args_size=1      0: iconst_1            //å°†intç±»å‹çš„å¸¸é‡1å‹å…¥æ“ä½œæ•°æ ˆ      1: anewarray     #4    //ä»æ ˆé¡¶å¼¹å‡ºæ•°ç»„é•¿åº¦(æŒ‡å®šæ•°ç»„é•¿åº¦ä¸º1)ï¼Œå¹¶å®ä¾‹åŒ–æ•°ç»„ï¼Œå¹¶å°†å…¶å‹æ ˆ      4: astore_1            //å°†æ ˆé¡¶çš„å¼•ç”¨å‹æ•°å€¼å¼¹å‡ºæ ˆï¼Œå¹¶ä¿å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„1çš„ä½ç½®      5: aload_1             //ä»å±€éƒ¨å˜é‡è¡¨ä¸­è£…è½½ç´¢å¼•å€¼ä¸º1(slot=1)çš„å¼•ç”¨å‹æ•°å€¼ï¼Œå¹¶å‹æ ˆ      6: iconst_0            //å°†intç±»å‹çš„å¸¸é‡0å‹æ ˆ      7: ldc           #5    //å°†å­—ç¬¦ä¸²"hello asm"å¸¸é‡å‹æ ˆ      9: aastore             //å°†æ ˆé¡¶çš„æ•°å€¼ä¾æ¬¡å¼¹å‡ºï¼Œå¹¶å¼•ç”¨å‹æ•°å€¼å­˜å…¥æŒ‡å®šæ•°ç»„çš„æŒ‡å®šç´¢å¼•ä½ç½®     10: aload_1             //åŒä¸Šï¼Œä»å±€éƒ¨å˜é‡è¡¨ä¸­è£…è½½ç´¢å¼•å€¼ä¸º1(slot=1)çš„å¼•ç”¨å‹æ•°å€¼ï¼Œå¹¶å‹æ ˆ     11: iconst_0            //å°†intç±»å‹çš„å¸¸é‡0å‹æ ˆ     12: aaload              //å°†å¼•ç”¨å‹æ•°ç»„æŒ‡å®šç´¢å¼•çš„å€¼(0)æ¨é€è‡³æ ˆé¡¶     13: astore_2            //å°†æ ˆé¡¶çš„å¼•ç”¨å‹æ•°å€¼(object[0])å¼¹å‡ºæ ˆï¼Œå¹¶ä¿å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­slot=2çš„ä½ç½®     14: getstatic     #6    //è®¿é—®ç±»çš„é™æ€å˜é‡ï¼Œç±»å‹ä¸º(java/lang/System.out:Ljava/io/PrintStream;)     17: aload_2             //ä»å±€éƒ¨å˜é‡è¡¨ä¸­è£…è½½slot=2çš„å¼•ç”¨å‹æ•°å€¼ï¼Œå¹¶å‹æ ˆ     18: invokevirtual #7    //å°†æ ˆé¡¶çš„å¼•ç”¨å‹æ•°å€¼å¼¹å‡ºæ ˆï¼Œå¹¶è°ƒç”¨ç±»æˆå‘˜æ–¹æ³•ï¼Œæ–¹æ³•æè¿°ç¬¦ä¸ºjava/io/PrintStream.println:(Ljava/lang/Object;)V     21: return   LineNumberTable:     line 10: 0     line 11: 5     line 12: 10     line 13: 14     line 14: 21   LocalVariableTable:     Start  Length  Slot  Name   Signature         0      22     0  args   [Ljava/lang/String;         5      17     1 objects   [Ljava/lang/Object;        14       8     2 object   Ljava/lang/Object;</code></pre></li></ol><pre><code>aaloadaastoreaconst_nullaloadaload_&lt;n&gt;anewarrayareturnarraylengthastoreastore_&lt;n&gt;athrowbaloadbastorebipushcaloadcastorecheckcastd2fd2id2ldadddaloaddastoredcmp&lt;op&gt;dconst_&lt;d&gt;ddivdloaddload_&lt;n&gt;dmuldnegdremdreturndstoredstore_&lt;n&gt;dsubdupdup_x1dup_x2dup2dup2_x1dup2_x2f2df2if2lfaddfaloadfastorefcmp&lt;op&gt;fconst_&lt;f&gt;fdivfloadfload_&lt;n&gt;fmulfnegfremfreturnfstorefstore_&lt;n&gt;fsubgetfieldgetstaticgotogoto_wi2bi2ci2di2fi2li2siaddialoadiandiastoreiconst_&lt;i&gt;idivif_acmp&lt;cond&gt;if_icmp&lt;cond&gt;if&lt;cond&gt;ifnonnullifnulliinciloadiload_&lt;n&gt;imulineginstanceofinvokedynamicinvokeinterfaceinvokespecialinvokestaticinvokevirtualioriremireturnishlishristoreistore_&lt;n&gt;isubiushrixorjsrjsr_wl2dl2fl2iladdlaloadlandlastorelcmplconst_&lt;l&gt;ldcldc_wldc2_wldivlloadlload_&lt;n&gt;lmullneglookupswitchlorlremlreturnlshllshrlstorelstore_&lt;n&gt;lsublushrlxormonitorentermonitorexitmultianewarraynewnewarraynoppoppop2putfieldputstaticretreturnsaloadsastoresipushswaptableswitchwide</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> jvm-tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> jdk </tag>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jvm-è¿è¡Œæ—¶æ–¹æ³•åŒº</title>
      <link href="2020/03/22/jvm-structure/"/>
      <url>2020/03/22/jvm-structure/</url>
      
        <content type="html"><![CDATA[<h1 id="è¿è¡Œæ—¶æ•°æ®åŒº-Run-Time-Data-Areas"><a href="#è¿è¡Œæ—¶æ•°æ®åŒº-Run-Time-Data-Areas" class="headerlink" title="è¿è¡Œæ—¶æ•°æ®åŒº (Run-Time Data Areas)"></a>è¿è¡Œæ—¶æ•°æ®åŒº (Run-Time Data Areas)</h1><blockquote><p>Javaè™šæ‹Ÿæœºåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å®šä¹‰äº†å„ç§<code>è¿è¡Œæ—¶æ•°æ®åŒº</code>ï¼Œä¸€éƒ¨åˆ†æ•°æ®åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸Javaè™šæ‹Ÿæœºä¸€è‡´ï¼Œå¦ä¸€éƒ¨åˆ†æ•°æ®åŒºçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ä¸€è‡´ã€‚</p></blockquote><h3 id="1-ç¨‹åºè®¡æ•°å™¨-program-counter-register"><a href="#1-ç¨‹åºè®¡æ•°å™¨-program-counter-register" class="headerlink" title="1. ç¨‹åºè®¡æ•°å™¨ (program counter register)"></a>1. ç¨‹åºè®¡æ•°å™¨ (program counter register)</h3><ol><li>ç¨‹åºè®¡æ•°å™¨æ˜¯<code>çº¿ç¨‹ç§æœ‰çš„</code>ï¼Œç”Ÿå‘½å‘¨æœŸéšçº¿ç¨‹è€Œç”Ÿè€Œç­ã€‚</li><li>åœ¨ä»»ä½•æ—¶å€™ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ã€‚å¦‚æœè¯¥æ–¹æ³•æ˜¯<code>native</code>æ–¹æ³•ï¼Œç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰jvmæŒ‡ä»¤çš„å†…å­˜åœ°å€ã€‚åä¹‹ï¼Œç¨‹åºè®¡æ•°å™¨çš„å€¼å°†ä¸ä¼šè¢«å®šä¹‰ã€‚</li><li>ç¨‹åºè®¡æ•°å™¨(ç©ºé—´)è¶³å¤Ÿå¤§ï¼Œå¯ä»¥ä¿å­˜ä¸€ä¸ª<code>returnAddress</code>ç±»å‹çš„å€¼æˆ–è€…ç‰¹å®šå¹³å°ä¸Šçš„æœ¬åœ°æŒ‡é’ˆã€‚</li></ol><h3 id="2-Javaè™šæ‹Ÿæœºæ ˆ-java-virtual-machine-stacks"><a href="#2-Javaè™šæ‹Ÿæœºæ ˆ-java-virtual-machine-stacks" class="headerlink" title="2. Javaè™šæ‹Ÿæœºæ ˆ (java virtual machine stacks)"></a>2. Javaè™šæ‹Ÿæœºæ ˆ (java virtual machine stacks)</h3><ol><li>Javaè™šæ‹Ÿæœºæ ˆæ˜¯<code>çº¿ç¨‹ç§æœ‰</code>çš„ï¼Œç”Ÿå‘½å‘¨æœŸéšçº¿ç¨‹è€Œç”Ÿè€Œç­ã€‚</li><li>Javaè™šæ‹Ÿæœºæ ˆçš„ä½¿ç”¨çš„å†…å­˜å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</li><li>Javaè™šæ‹Ÿæœºæ ˆå­˜å‚¨<code>æ ˆå¸§</code>ã€‚æ¯ä¸ªæ–¹æ³•ä»è°ƒç”¨åˆ°æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå¯¹åº”ç€ä¸€ä¸ª<code>æ ˆå¸§</code>åœ¨Javaè™šæ‹Ÿæœºæ ˆä¸­çš„<code>å‹æ ˆ</code>åˆ°<code>å¼¹æ ˆ</code>çš„è¿‡ç¨‹ã€‚</li><li>Javaè™šæ‹Ÿæœºæ ˆå¯ä»¥å…·æœ‰å›ºå®šå¤§å°ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è®¡ç®—è¦æ±‚åŠ¨æ€æ‰©å±•æˆ–æ”¶ç¼©ã€‚</li><li>å¦‚æœJavaè™šæ‹Ÿæœºå…è®¸åŠ¨æ€æ‰©å±•ï¼Œä½†æ˜¯æ‰©å±•æ—¶å´æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œåˆ™ä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</li><li>å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡å¤§äºJavaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼Œåˆ™ä¼šæŠ›å‡º<code>StackOverflowError</code>å¼‚å¸¸ã€‚</li></ol><h3 id="3-å †-heap"><a href="#3-å †-heap" class="headerlink" title="3. å † (heap)"></a>3. å † (heap)</h3><ol><li>å †å­˜å‚¨å¯¹è±¡å®ä¾‹ã€‚</li><li>å †å†…å­˜å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</li><li>å †æ˜¯<code>çº¿ç¨‹å…±äº«</code>çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸Javaè™šæ‹Ÿæœºä¸€è‡´ã€‚</li><li>å †å¯ä»¥æ˜¯å›ºå®šå¤§å°ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚åŠ¨æ€æ‰©å±•å’Œæ”¶ç¼©ã€‚</li><li>åªè¦Javaè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸æ–­è¢«åˆ›å»ºï¼Œä¸”ä¿è¯<code>GC Roots</code>åˆ°å¯¹è±¡ä¹‹é—´æœ‰<code>å¯è¾¾è·¯å¾„</code>æ¥é¿å…åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå½“å †å­˜å‚¨çš„å¯¹è±¡åˆ°è¾¾å †å†…å­˜å…è®¸çš„æœ€å¤§å®¹é‡æ—¶ï¼Œä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</li></ol><h3 id="4-æ–¹æ³•åŒº-method-area"><a href="#4-æ–¹æ³•åŒº-method-area" class="headerlink" title="4. æ–¹æ³•åŒº (method area)"></a>4. æ–¹æ³•åŒº (method area)</h3><ol><li>æ–¹æ³•åŒºæ˜¯<code>çº¿ç¨‹å…±äº«çš„</code>ï¼Œç”Ÿå‘½å‘¨æœŸä¸Javaè™šæ‹Ÿæœºä¸€è‡´</li><li>æ–¹æ³•åŒºå­˜å‚¨ç±»ä¿¡æ¯ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± (<code>runtime constant pool</code>)ï¼Œå­—ï¼Œæ–¹æ³•æ•°æ®ï¼Œ<code>JITç¼–è¯‘åçš„ä»£ç æ•°æ®</code>ï¼Œä»¥åŠç±»å’Œæ¥å£åˆå§‹åŒ–çš„å‡½æ•°<code>&lt;clinit&gt;</code>å’Œç±»å®ä¾‹åˆå§‹åŒ–çš„å‡½æ•°<code>&lt;init&gt;</code>ç­‰ä¿¡æ¯ã€‚</li><li>æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯<code>å †</code>çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä¸¤è€…åº”è¯¥åŒºåˆ†æ¥çœ‹ã€‚</li><li>æ–¹æ³•åŒºçš„å†…å­˜åŒºåŸŸå¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</li><li>æ–¹æ³•åŒºçš„å¤§å°å¯ä»¥æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚åŠ¨æ€çš„æ‰©ç¼©å®¹ã€‚</li><li>å¦‚æœæ— æ³•æä¾›æ–¹æ³•åŒºä¸­çš„å†…å­˜æ¥æ»¡è¶³åˆ†é…çš„è¯·æ±‚ï¼Œä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</li></ol><h3 id="5-è¿è¡Œæ—¶å¸¸é‡æ± -runtime-constant-pool"><a href="#5-è¿è¡Œæ—¶å¸¸é‡æ± -runtime-constant-pool" class="headerlink" title="5. è¿è¡Œæ—¶å¸¸é‡æ±  (runtime constant pool)"></a>5. è¿è¡Œæ—¶å¸¸é‡æ±  (runtime constant pool)</h3><ol><li>æ¯ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± éƒ½æ˜¯ä»Javaè™šæ‹Ÿæœºçš„<code>æ–¹æ³•åŒº</code>ä¸­åˆ†é…çš„</li><li>è¿è¡Œæ—¶å¸¸é‡æ± ä¸»è¦ç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œä»¥åŠåœ¨è¿è¡Œæ—¶è§£æçš„æ–¹æ³•å’Œå­—æ®µå¼•ç”¨ã€‚</li><li>åˆ›å»ºç±»æˆ–æ¥å£æ—¶ï¼Œå¦‚æœè¿è¡Œæ—¶å¸¸é‡æ± æ„é€ æ‰€éœ€çš„å†…å­˜è¶…è¿‡Javaè™šæ‹Ÿæœºçš„æ–¹æ³•åŒºåŸŸä¸­å¯ç”¨çš„å†…å­˜ï¼Œåˆ™Javaè™šæ‹Ÿæœºå°†æŠ›å‡º<code>OutOfMemoryError</code></li></ol><h3 id="6-æœ¬åœ°æ–¹æ³•æ ˆ-native-method-stacks"><a href="#6-æœ¬åœ°æ–¹æ³•æ ˆ-native-method-stacks" class="headerlink" title="6. æœ¬åœ°æ–¹æ³•æ ˆ (native method stacks)"></a>6. æœ¬åœ°æ–¹æ³•æ ˆ (native method stacks)</h3><ol><li>æœ¬åœ°æ–¹æ³•æ ˆå’Œ<code>Javaè™šæ‹Ÿæœºæ ˆ</code>å¾ˆç›¸ä¼¼ã€‚</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿæ˜¯<code>çº¿ç¨‹ç§æœ‰</code>çš„ï¼Œå¹¶ä¸”ä¹Ÿèƒ½æŠ›å‡º<code>OutOfMemoryError</code>,<code>StackOverflowError</code>å¼‚å¸¸ã€‚</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¸ºè™šæ‹Ÿæœºä½¿æ‰€ä½¿ç”¨åˆ°çš„<code>native</code>æ–¹æ³•æœåŠ¡ã€‚</li><li>Javaè™šæ‹Ÿæœºä¸­å¹¶æ²¡æœ‰é™åˆ¶å®ç°<code>native</code>æ–¹æ³•çš„è¯­è¨€ï¼Œä½¿ç”¨æ–¹å¼å’Œæ•°æ®ç»“æ„ï¼Œå› æ­¤å…·ä½“çš„è™šæ‹Ÿæœºå¯ä»¥è‡ªç”±çš„å®ç°å®ƒã€‚</li><li>æœ‰çš„è™šæ‹Ÿæœº(Sun HotSpotè™šæ‹Ÿæœº)ç›´æ¥æŠŠæœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆå¹¶åœ¨ä¸€èµ·</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> jvm-tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> jdk </tag>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awesome-java</title>
      <link href="2020/03/21/awesome-java/"/>
      <url>2020/03/21/awesome-java/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">repository</th><th align="center">watch</th><th align="center">star</th><th align="center">fork</th><th align="center">read</th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/alibaba/transmittable-thread-local" target="_blank" rel="noopener">transmittable-thread-local</a></td><td align="center"><img src="https://img.shields.io/github/watchers/alibaba/transmittable-thread-local.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/alibaba/transmittable-thread-local.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/alibaba/transmittable-thread-local.svg" alt=""></td><td align="center"><input type="checkbox" checked=""></td></tr><tr><td align="center"><a href="https://github.com/openjdk/jdk" target="_blank" rel="noopener">jdk</a></td><td align="center"><img src="https://img.shields.io/github/watchers/openjdk/jdk.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/openjdk/jdk.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/openjdk/jdk.svg" alt=""></td><td align="center"><input type="checkbox" checked=""></td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> awesome </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> awesome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awesome-ml</title>
      <link href="2020/03/21/awesome-ml/"/>
      <url>2020/03/21/awesome-ml/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">repository</th><th align="center">watch</th><th align="center">star</th><th align="center">fork</th><th align="center">read</th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/czy36mengfei/tensorflow2_tutorials_chinese" target="_blank" rel="noopener">tensorflow2_tutorials_chinese</a></td><td align="center"><img src="https://img.shields.io/github/watchers/czy36mengfei/tensorflow2_tutorials_chinese.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/czy36mengfei/tensorflow2_tutorials_chinese.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/czy36mengfei/tensorflow2_tutorials_chinese.svg" alt=""></td><td align="center"><input type="checkbox" checked=""></td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> awesome </category>
          
      </categories>
      
      
        <tags>
            
            <tag> awesome </tag>
            
            <tag> machine learning </tag>
            
            <tag> deep learning </tag>
            
            <tag> ml </tag>
            
            <tag> dl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awesome-rust</title>
      <link href="2020/03/21/awesome-rust/"/>
      <url>2020/03/21/awesome-rust/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">repository</th><th align="center">watch</th><th align="center">star</th><th align="center">fork</th><th align="center">read</th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/jonathandturner/rhai" target="_blank" rel="noopener">rhai</a></td><td align="center"><img src="https://img.shields.io/github/watchers/jonathandturner/rhai.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/jonathandturner/rhai.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/jonathandturner/rhai.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/alacritty/alacritty" target="_blank" rel="noopener">alacritty</a></td><td align="center"><img src="https://img.shields.io/github/watchers/alacritty/alacritty.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/alacritty/alacritty.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/alacritty/alacritty.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/Rigellute/spotify-tui" target="_blank" rel="noopener">spotify-tui</a></td><td align="center"><img src="https://img.shields.io/github/watchers/Rigellute/spotify-tui.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/Rigellute/spotify-tui.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/Rigellute/spotify-tui.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/cjbassi/ytop" target="_blank" rel="noopener">ytop</a></td><td align="center"><img src="https://img.shields.io/github/watchers/cjbassi/ytop.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/cjbassi/ytop.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/cjbassi/ytop.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/BurntSushi/xsv" target="_blank" rel="noopener">xsv</a></td><td align="center"><img src="https://img.shields.io/github/watchers/BurntSushi/xsv.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/BurntSushi/xsv.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/BurntSushi/xsv.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/IGI-111/Smith" target="_blank" rel="noopener">Smith</a></td><td align="center"><img src="https://img.shields.io/github/watchers/IGI-111/Smith.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/IGI-111/Smith.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/IGI-111/Smith.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/PistonDevelopers/dyon" target="_blank" rel="noopener">dyon</a></td><td align="center"><img src="https://img.shields.io/github/watchers/PistonDevelopers/dyon.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/PistonDevelopers/dyon.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/PistonDevelopers/dyon.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/bwasty/learn-opengl-rs" target="_blank" rel="noopener">learn-opengl-rs</a></td><td align="center"><img src="https://img.shields.io/github/watchers/bwasty/learn-opengl-rs.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/bwasty/learn-opengl-rs.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/bwasty/learn-opengl-rs.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/betta-cyber/netease-music-tui" target="_blank" rel="noopener">netease-music-tui</a></td><td align="center"><img src="https://img.shields.io/github/watchers/betta-cyber/netease-music-tui.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/betta-cyber/netease-music-tui.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/betta-cyber/netease-music-tui.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/zkat/cacache-rs" target="_blank" rel="noopener">cacache-rs</a></td><td align="center"><img src="https://img.shields.io/github/watchers/zkat/cacache-rs.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/zkat/cacache-rs.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/zkat/cacache-rs.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/jaemk/cached" target="_blank" rel="noopener">cached</a></td><td align="center"><img src="https://img.shields.io/github/watchers/jaemk/cached.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/jaemk/cached.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/jaemk/cached.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/epilys/bb" target="_blank" rel="noopener">bb</a></td><td align="center"><img src="https://img.shields.io/github/watchers/epilys/bb.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/epilys/bb.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/epilys/bb.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/Nercury/rust-and-opengl-lessons" target="_blank" rel="noopener">rust-and-opengl-lessons</a></td><td align="center"><img src="https://img.shields.io/github/watchers/Nercury/rust-and-opengl-lessons.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/Nercury/rust-and-opengl-lessons.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/Nercury/rust-and-opengl-lessons.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/jonhoo/bus" target="_blank" rel="noopener">bus</a></td><td align="center"><img src="https://img.shields.io/github/watchers/jonhoo/bus.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/jonhoo/bus.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/jonhoo/bus.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/tokio-rs/tokio-minihttp" target="_blank" rel="noopener">tokio-rs/tokio-minihttp</a></td><td align="center"><img src="https://img.shields.io/github/watchers/tokio-rs/tokio-minihttp.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/tokio-rs/tokio-minihttp.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/tokio-rs/tokio-minihttp.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/swindon-rs/tk-http" target="_blank" rel="noopener">swindon-rs/tk-http</a></td><td align="center"><img src="https://img.shields.io/github/watchers/swindon-rs/tk-http.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/swindon-rs/tk-http.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/swindon-rs/tk-http.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> awesome </category>
          
      </categories>
      
      
        <tags>
            
            <tag> awesome </tag>
            
            <tag> rust </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awesome-c/c++</title>
      <link href="2020/03/21/awesome-c/"/>
      <url>2020/03/21/awesome-c/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">repository</th><th align="center">watch</th><th align="center">star</th><th align="center">fork</th><th align="center">read</th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/kozross/awesome-c" target="_blank" rel="noopener">awesome-c</a></td><td align="center"><img src="https://img.shields.io/github/watchers/kozross/awesome-c.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/kozross/awesome-c.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/kozross/awesome-c.svg" alt=""></td><td align="center"><input type="checkbox" checked=""></td></tr><tr><td align="center"><a href="https://github.com/changkun/modern-cpp-tutorial" target="_blank" rel="noopener">modern-cpp-tutorial</a></td><td align="center"><img src="https://img.shields.io/github/watchers/changkun/modern-cpp-tutorial.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/changkun/modern-cpp-tutorial.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/changkun/modern-cpp-tutorial.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/changkun/modern-cpp-tutorial" target="_blank" rel="noopener">awesome-modern-cpp</a></td><td align="center"><img src="https://img.shields.io/github/watchers/rigtorp/awesome-modern-cpp.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/rigtorp/awesome-modern-cpp.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/rigtorp/awesome-modern-cpp.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/fffaraz/awesome-cpp" target="_blank" rel="noopener">awesome-cpp</a></td><td align="center"><img src="https://img.shields.io/github/watchers/fffaraz/awesome-cpp.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/fffaraz/awesome-cpp.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/fffaraz/awesome-cpp.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/jbhuang0604/awesome-computer-vision" target="_blank" rel="noopener">awesome-computer-vision</a></td><td align="center"><img src="https://img.shields.io/github/watchers/jbhuang0604/awesome-computer-vision.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/jbhuang0604/awesome-computer-vision.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/jbhuang0604/awesome-computer-vision.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/jbhuang0604/awesome-computer-vision" target="_blank" rel="noopener">project-based-tutorials-in-c</a></td><td align="center"><img src="https://img.shields.io/github/watchers/rby90/project-based-tutorials-in-c.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/rby90/project-based-tutorials-in-c.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/rby90/project-based-tutorials-in-c.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/brenns10/lsh" target="_blank" rel="noopener">lsh</a></td><td align="center"><img src="https://img.shields.io/github/watchers/brenns10/lsh.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/brenns10/lsh.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/brenns10/lsh.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/jamesroutley/write-a-hash-table" target="_blank" rel="noopener">write-a-hash-table</a></td><td align="center"><img src="https://img.shields.io/github/watchers/jamesroutley/write-a-hash-table.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/jamesroutley/write-a-hash-table.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/jamesroutley/write-a-hash-table.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/forhappy/Cplusplus-Concurrency-In-Practice" target="_blank" rel="noopener">Cplusplus-Concurrency-In-Practice</a></td><td align="center"><img src="https://img.shields.io/github/watchers/forhappy/Cplusplus-Concurrency-In-Practice.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/forhappy/Cplusplus-Concurrency-In-Practice.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/forhappy/Cplusplus-Concurrency-In-Practice.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/redis/hiredis" target="_blank" rel="noopener">hiredis</a></td><td align="center"><img src="https://img.shields.io/github/watchers/redis/hiredis.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/redis/hiredis.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/redis/hiredis.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/wzpan/cmake-demo" target="_blank" rel="noopener">cmake-demo</a></td><td align="center"><img src="https://img.shields.io/github/watchers/wzpan/cmake-demo.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/wzpan/cmake-demo.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/wzpan/cmake-demo.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/Akagi201/learning-cmake" target="_blank" rel="noopener">learning-cmake</a></td><td align="center"><img src="https://img.shields.io/github/watchers/Akagi201/learning-cmake.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/Akagi201/learning-cmake.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/Akagi201/learning-cmake.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr><tr><td align="center"><a href="https://github.com/antirez/kilo" target="_blank" rel="noopener">kilo</a></td><td align="center"><img src="https://img.shields.io/github/watchers/antirez/kilo.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/stars/antirez/kilo.svg" alt=""></td><td align="center"><img src="https://img.shields.io/github/forks/antirez/kilo.svg" alt=""></td><td align="center"><input type="checkbox"></td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> awesome </category>
          
      </categories>
      
      
        <tags>
            
            <tag> awesome </tag>
            
            <tag> c/c++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SPIæœºåˆ¶ç®€å•ç¤ºä¾‹</title>
      <link href="2020/03/18/spi/"/>
      <url>2020/03/18/spi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>spi(Service Provider Interface)æ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä¸»è¦å¯¹æ¥å£è¿›è¡Œè§£è€¦ï¼Œå®ç°å¯¹è£…é…ç±»çš„åŠ¨æ€åŠ è½½ã€‚æœ¬æ–‡åªè®²å¦‚ä½•ä½¿ç”¨<code>spi</code>ï¼Œä¸å»åˆ†æå®ƒçš„æºç ã€‚</p></blockquote><h3 id="1-åœ¨classpathä¸‹åˆ›å»ºMETA-INF-servicesæ–‡ä»¶å¤¹"><a href="#1-åœ¨classpathä¸‹åˆ›å»ºMETA-INF-servicesæ–‡ä»¶å¤¹" class="headerlink" title="1. åœ¨classpathä¸‹åˆ›å»ºMETA-INF/servicesæ–‡ä»¶å¤¹"></a>1. åœ¨classpathä¸‹åˆ›å»º<code>META-INF/services</code>æ–‡ä»¶å¤¹</h3><p><code>ServiceLoader</code>å°†ä¼šæ‰«æ<code>META-INF/services</code>ä¸‹çš„æ–‡ä»¶</p><h3 id="2-åˆ›å»ºä»¥çˆ¶ç±»æˆ–æ¥å£çš„å®Œå…¨é™å®šåä¸ºåçš„æ–‡ä»¶"><a href="#2-åˆ›å»ºä»¥çˆ¶ç±»æˆ–æ¥å£çš„å®Œå…¨é™å®šåä¸ºåçš„æ–‡ä»¶" class="headerlink" title="2. åˆ›å»ºä»¥çˆ¶ç±»æˆ–æ¥å£çš„å®Œå…¨é™å®šåä¸ºåçš„æ–‡ä»¶"></a>2. åˆ›å»ºä»¥çˆ¶ç±»æˆ–æ¥å£çš„å®Œå…¨é™å®šåä¸ºåçš„æ–‡ä»¶</h3><p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªæ¥å£åä¸º<code>Animal</code>ï¼Œå®ƒçš„å®Œå…¨é™å®šåä¸º<code>io.github.iamazy.asm.spi.Animal</code>ï¼Œåˆ™åœ¨<code>META-INF/services</code>æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶<code>io.github.iamazy.asm.spi.Animal</code>ã€‚</p><p>Animalæ¥å£å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>asm<span class="token punctuation">.</span>spi<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>    String <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-åœ¨io-github-iamazy-asm-spi-Animalæ–‡ä»¶ä¸­æ·»åŠ å­ç±»çš„å®Œå…¨é™å®šå"><a href="#3-åœ¨io-github-iamazy-asm-spi-Animalæ–‡ä»¶ä¸­æ·»åŠ å­ç±»çš„å®Œå…¨é™å®šå" class="headerlink" title="3. åœ¨io.github.iamazy.asm.spi.Animalæ–‡ä»¶ä¸­æ·»åŠ å­ç±»çš„å®Œå…¨é™å®šå"></a>3. åœ¨<code>io.github.iamazy.asm.spi.Animal</code>æ–‡ä»¶ä¸­æ·»åŠ å­ç±»çš„å®Œå…¨é™å®šå</h3><p>åˆ›å»º<code>Animal</code>çš„å­ç±»<code>Dog</code>å’Œ<code>Cat</code>ï¼Œç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Dog.java</span><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>asm<span class="token punctuation">.</span>spi<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">implements</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"DOG"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Cat.java</span><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>asm<span class="token punctuation">.</span>spi<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token keyword">implements</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"CAT"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ™<code>io.github.iamazy.asm.spi.Animal</code>æ–‡ä»¶å†…å®¹åº”ä¸ºï¼š</p><pre><code>io.github.iamazy.asm.spi.Dogio.github.iamazy.asm.spi.Cat</code></pre><h3 id="4-ä½¿ç”¨ServiceLoaderåŠ è½½"><a href="#4-ä½¿ç”¨ServiceLoaderåŠ è½½" class="headerlink" title="4. ä½¿ç”¨ServiceLoaderåŠ è½½"></a>4. ä½¿ç”¨<code>ServiceLoader</code>åŠ è½½</h3><p>åœ¨mainæ–¹æ³•ä¸­ä½¿ç”¨<code>ServiceLoader</code>åŠ è½½<code>Animal</code>æ¥å£</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ServiceLoader<span class="token operator">&lt;</span>Animal<span class="token operator">></span> animals <span class="token operator">=</span> ServiceLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>Animal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>Animal animal<span class="token operator">:</span>animals<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>classæ–‡ä»¶æ ¼å¼</title>
      <link href="2020/03/17/jdk-class-file/"/>
      <url>2020/03/17/jdk-class-file/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å­¦ä¹ Javaçš„åŒå­¦å¯¹classæ–‡ä»¶å¯èƒ½ä¸ä¼šé™Œç”Ÿï¼Œå®ƒæ˜¯<code>.java</code>æ–‡ä»¶ç¼–è¯‘åç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶(æ‰©å±•åä¸º<code>.class</code>)ï¼Œå®ƒæ˜¯Javaè¯­è¨€<code>ä¸€æ¬¡ç¼–è¯‘ï¼Œå¤„å¤„è¿è¡Œ</code>çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯å…¶ä»–<code>jvm</code>è¯­è¨€è¿è¡Œåœ¨jvmä¸Šçš„åŸºç¡€ã€‚</p></blockquote><h3 id="1-classæ–‡ä»¶ç»“æ„"><a href="#1-classæ–‡ä»¶ç»“æ„" class="headerlink" title="1. classæ–‡ä»¶ç»“æ„"></a>1. classæ–‡ä»¶ç»“æ„</h3><p>ä¸€ä¸ªclassç”±ä»¥ä¸‹å„ç§å±æ€§æ„æˆ</p><pre><code>ClassFile {    u4             magic;    u2             minor_version;    u2             major_version;    u2             constant_pool_count;    cp_info        constant_pool[constant_pool_count-1];    u2             access_flags;    u2             this_class;    u2             super_class;    u2             interfaces_count;    u2             interfaces[interfaces_count];    u2             fields_count;    field_info     fields[fields_count];    u2             methods_count;    method_info    methods[methods_count];    u2             attributes_count;    attribute_info attributes[attributes_count];}</code></pre><h4 id="1-magic"><a href="#1-magic" class="headerlink" title="1. magic"></a>1. magic</h4><p>é­”æ•°ï¼Œç”¨æ¥æ ‡è¯†ä¸€ä¸ªclassæ–‡ä»¶çš„æ ¼å¼ï¼Œå®ƒçš„å€¼æ˜¯<code>0xCAFEBABE</code>(å’–å•¡å®è´)ï¼Œå•ä½æ˜¯æ— ç¬¦å·çš„4ä¸ªå­—èŠ‚(<code>u4</code>)ã€‚(é€šå¸¸è¯†åˆ«ä¸€ä¸ªæ–‡ä»¶æ ¼å¼æ¯”è¾ƒä¸¥è°¨çš„æ–¹å¼æ˜¯é‰´åˆ«å®ƒçš„é­”æ•°è€Œä¸æ˜¯æ–‡ä»¶çš„æ‰©å±•å)ã€‚jvmåŠ è½½classæ–‡ä»¶æ—¶ä¼šé¦–å…ˆæ£€æŸ¥è¿™å››ä¸ªå­—èŠ‚ï¼Œå¦‚æœä¸æ˜¯<code>0xCAFEBABE</code>åˆ™ä¼šæ‹’ç»åŠ è½½è¯¥æ–‡ä»¶é¿å…æµªè´¹èµ„æºã€‚</p><h4 id="2-minor-versionï¼Œmajor-version"><a href="#2-minor-versionï¼Œmajor-version" class="headerlink" title="2. minor_versionï¼Œmajor_version"></a>2. minor_versionï¼Œmajor_version</h4><p>è¿™ä¸ªå­—æ®µåæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå‡å¦‚ä½ çš„å¼€å‘ç¯å¢ƒçš„jdkç‰ˆæœ¬å’Œéƒ¨ç½²ç¯å¢ƒçš„jdkç‰ˆæœ¬ä¸æ˜¯ä¸€ä¸ªä¸»ç‰ˆæœ¬(å¦‚å¼€å‘ç¯å¢ƒæ˜¯jdk1.8ï¼Œéƒ¨ç½²ç¯å¢ƒæ˜¯jdk13)ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šé‡åˆ°<code>Unsupported major.minor version 57</code>ï¼Œç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªå¼‚å¸¸å¾ˆå¤šäººéƒ½ä¼šå¾ˆå¥‡æ€ªè¿™ä¸ª57æ˜¯æ€ä¹ˆæ¥çš„ã€‚</p><table><thead><tr><th>Java SE</th><th>å¯¹åº”çš„ä¸»ç‰ˆæœ¬å·</th><th>å…¼å®¹çš„ä¸»ç‰ˆæœ¬å·</th></tr></thead><tbody><tr><td>1.0.2</td><td>45</td><td>45</td></tr><tr><td>1.1</td><td>45</td><td>45</td></tr><tr><td>1.2</td><td>46</td><td>45 .. 46</td></tr><tr><td>1.3</td><td>47</td><td>45 .. 47</td></tr><tr><td>1.4</td><td>48</td><td>45 .. 48</td></tr><tr><td>5.0</td><td>49</td><td>45 .. 49</td></tr><tr><td>6</td><td>50</td><td>45 .. 50</td></tr><tr><td>7</td><td>51</td><td>45 .. 51</td></tr><tr><td>8</td><td>52</td><td>45 .. 52</td></tr><tr><td>9</td><td>53</td><td>45 .. 53</td></tr><tr><td>10</td><td>54</td><td>45 .. 54</td></tr><tr><td>11</td><td>55</td><td>45 .. 55</td></tr><tr><td>12</td><td>56</td><td>45 .. 56</td></tr><tr><td>13</td><td>57</td><td>45 .. 57</td></tr></tbody></table><p>ä¸»ç‰ˆæœ¬å·(major version)å’Œæ¬¡ç‰ˆæœ¬å·(minor version)å…±åŒå†³å®šclassæ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ã€‚å¦‚æœä¸€ä¸ªclassæ–‡ä»¶çš„ä¸»ç‰ˆæœ¬å·æ˜¯Mï¼Œæ¬¡ç‰ˆæœ¬å·æ˜¯mï¼Œåˆ™å°†è¯¥classæ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬å®šä¹‰ä¸º<code>M.m</code></p><blockquote><p>å¯¹äºä¸»ç‰ˆæœ¬å·(major version)å¤§äº56çš„classæ–‡ä»¶ï¼Œæ¬¡ç‰ˆæœ¬å·(minor version)å¿…é¡»æ˜¯0æˆ–65535<br>å¯¹äºä¸»ç‰ˆæœ¬å·(major version)åœ¨[45,55]èŒƒå›´å†…çš„ï¼Œæ¬¡ç‰ˆæœ¬å·(minor version)å¯ä»¥æ˜¯ä»»æ„å€¼</p></blockquote><h4 id="3-constant-pool-count"><a href="#3-constant-pool-count" class="headerlink" title="3. constant_pool_count"></a>3. constant_pool_count</h4><p>é¡¾åæ€ä¹‰ï¼Œè¡¨ç¤ºå¸¸é‡æ± çš„å¤§å°ï¼Œç­‰äºå¸¸é‡æ± <code>constant_pool</code>çš„å¤§å°åŠ 1</p><h4 id="4-constant-pool-constant-pool-count-1"><a href="#4-constant-pool-constant-pool-count-1" class="headerlink" title="4. constant_pool[constant_pool_count-1]"></a>4. constant_pool[constant_pool_count-1]</h4><p>ç´§è·Ÿåœ¨<code>constant_pool_count</code>åé¢çš„ç»“æ„å°±æ˜¯<code>constant_pool</code>ï¼Œè¡¨ç¤ºå¸¸é‡æ± ï¼Œé‡Œé¢å­˜å‚¨<code>constant_pool_count</code>ä¸ªå¸¸é‡(ä¸»è¦åŒ…æ‹¬å­—é¢å¸¸é‡ï¼Œç±»å’Œæ¥å£åï¼Œå­—æ®µåï¼Œä»¥åŠå…¶ä»–ç±»å‹çš„å¸¸é‡)ï¼Œå¸¸é‡æ± çš„ç´¢å¼•å€¼çš„èŒƒå›´æ˜¯[1,constant_pool_count-1]ã€‚<br>æ¯ä¸ªå¸¸é‡æ± çš„é¡¹(entry)ä½¿ç”¨<code>cp_info</code>ç±»å‹è¡¨ç¤ºï¼Œ<code>cp_info</code>çš„ç»“æ„ä¸ºï¼š</p><pre><code>cp_info {    u1 tag;    u1 info[];}</code></pre><p>jvmæ ¹æ®<code>tag</code>çš„å€¼æ¥ç¡®å®šæ¯ä¸ªå¸¸é‡æ± çš„é¡¹è¡¨ç¤ºä»€ä¹ˆç±»å‹çš„å­—é¢é‡ï¼Œinfo[]è¡¨ç¤ºçš„æ˜¯è¯¥å­—é¢é‡çš„å­—èŠ‚æ•°ç»„ã€‚<br>jvmè§„å®šäº†ä¸åŒçš„<code>tag</code>å¯¹åº”ä¸åŒç±»å‹çš„å­—é¢é‡ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>tag</th><th>è¡¨ç¤ºçš„å­—é¢é‡</th><th>å¯¹åº”çš„ç»“æ„</th></tr></thead><tbody><tr><td>1</td><td>è¡¨ç¤ºå­—ç¬¦ä¸²å¸¸é‡çš„å€¼</td><td>CONSTANT_Utf8_info</td></tr><tr><td>3</td><td>è¡¨ç¤º4å­—èŠ‚(int)æ•°å€¼å¸¸é‡</td><td>CONSTANT_Integer_info</td></tr><tr><td>4</td><td>è¡¨ç¤º4å­—èŠ‚(float)æ•°å€¼å¸¸é‡</td><td>CONSTANT_Float_info</td></tr><tr><td>5</td><td>è¡¨ç¤º8å­—èŠ‚(long)æ•°å€¼å¸¸é‡</td><td>CONSTANT_Long_info</td></tr><tr><td>6</td><td>è¡¨ç¤º8å­—èŠ‚(double)æ•°å€¼å¸¸é‡</td><td>CONSTANT_Double_info</td></tr><tr><td>7</td><td>è¡¨ç¤ºç±»æˆ–æ¥å£çš„å®Œå…¨é™å®šå</td><td>CONSTANT_Class_info</td></tr><tr><td>8</td><td>è¡¨ç¤ºjava.lang.Stringç±»å‹çš„å¸¸é‡</td><td>CONSTANT_String_info</td></tr><tr><td>9</td><td>è¡¨ç¤ºç±»çš„å­—æ®µ</td><td>CONSTANT_Fieldref_info</td></tr><tr><td>10</td><td>è¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•</td><td>CONSTANT_Methodref_info</td></tr><tr><td>11</td><td>è¡¨ç¤ºç±»æ‰€å®ç°æ¥å£çš„æ–¹æ³•</td><td>CONSTANT_InterfaceMethodref_info</td></tr><tr><td>12</td><td>è¡¨ç¤ºå­—æ®µæˆ–æ–¹æ³•çš„åç§°å’Œç±»å‹</td><td>CONSTANT_NameAndType_info</td></tr><tr><td>15</td><td>è¡¨ç¤ºæ–¹æ³•å¥æŸ„</td><td>CONSTANT_MethodHandle_info</td></tr><tr><td>16</td><td>è¡¨ç¤ºæ–¹æ³•ç±»å‹</td><td>CONSTANT_MethodType_info</td></tr><tr><td>18</td><td>è¡¨ç¤ºinvokedynamicæŒ‡ä»¤æ‰€ä½¿ç”¨çš„å¼•å¯¼æ–¹æ³•åŠå…¶è°ƒç”¨åç§°ï¼Œå‚æ•°ï¼Œè¯·æ±‚è¿”å›ç±»å‹ä»¥åŠå¯ä»¥é€‰æ‹©æ€§é™„åŠ çš„é™æ€å‚æ•°çš„å¸¸é‡åºåˆ—(å‚è€ƒ<code>lambda</code>è¡¨è¾¾å¼)</td><td>CONSTANT_InvokeDynamic_info</td></tr></tbody></table><h4 id="5-access-flags"><a href="#5-access-flags" class="headerlink" title="5. access_flags"></a>5. access_flags</h4><p>ç±»è®¿é—®æ ‡è¯†ä¿®é¥°ç¬¦</p><table><thead><tr><th>flag</th><th>å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>ACC_PUBLIC</td><td>0x0001</td><td>å…è®¸è¢«ä¸åœ¨åŒä¸€packageçš„ç±»è®¿é—®</td></tr><tr><td>ACC_FINAL</td><td>0x0010</td><td>ä¸å…è®¸æœ‰å­ç±»</td></tr><tr><td>ACC_SUPER</td><td>0x0020</td><td>å½“è¢«<code>invokespecial</code>æŒ‡ä»¤è°ƒç”¨æ—¶ï¼Œéœ€è¦ç‰¹åˆ«å¤„ç†è¶…ç±»æ–¹æ³•</td></tr><tr><td>ACC_INTERFACE</td><td>0x0200</td><td>è¡¨ç¤ºæ˜¯ä¸€ä¸ªæ¥å£</td></tr><tr><td>ACC_ABSTRACT</td><td>0x0400</td><td>è¡¨ç¤ºæ˜¯æŠ½è±¡çš„ç±»æˆ–æ–¹æ³•ï¼Œä¸å…è®¸è¢«åˆå§‹åŒ–</td></tr><tr><td>ACC_SYNTHETIC</td><td>0x1000</td><td>ä¸ä¼šåœ¨æºç ä¸­æ˜¾ç¤º</td></tr><tr><td>ACC_ANNOTATION</td><td>0x2000</td><td>è¡¨ç¤ºæ˜¯ä¸€ä¸ªæ³¨è§£ç±»å‹</td></tr><tr><td>ACC_ENUM</td><td>0x4000</td><td>è¡¨ç¤ºæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹</td></tr><tr><td>ACC_MODULE</td><td>0x8000</td><td>è¡¨ç¤ºæ˜¯ä¸€ä¸ªæ¨¡å—</td></tr></tbody></table><p>å¯ä»¥è‡ªå·±è¯•ç€åˆ†æä»¥ä¸‹å“ªäº›æ ‡è¯†å¯ä»¥ä¸€èµ·è¢«è®¾ç½®ï¼Œå“ªäº›åˆ™ä¸èƒ½(å¦‚<code>ACC_FINAL</code>å’Œ<code>ACC_ABSTRACT</code>ä¸èƒ½åŒæ—¶è¢«è®¾ç½®)</p><h4 id="5-this-class"><a href="#5-this-class" class="headerlink" title="5. this_class"></a>5. this_class</h4><p>è¡¨ç¤ºå½“å‰ç±»çš„å…¨å±€é™å®šååœ¨å¸¸é‡æ± (<code>constant_pool</code>)ä¸­çš„ç´¢å¼•ï¼Œè¯¥ç´¢å¼•å¯¹åº”çš„å¸¸é‡æ± é¡¹å¿…é¡»æ˜¯<code>CONSTANT_Class_info</code>çš„ç»“æ„ï¼Œä»£è¡¨è¿™ä¸ªclassæ–‡ä»¶å®šä¹‰çš„æ˜¯ä¸€ä¸ªç±»è¿˜æ˜¯ä¸€ä¸ªæ¥å£ã€‚</p><h4 id="6-super-class"><a href="#6-super-class" class="headerlink" title="6. super_class"></a>6. super_class</h4><p>å¯¹äºä¸€ä¸ªç±»ï¼Œå®ƒçš„<code>super_class</code>çš„å€¼å¿…é¡»æ˜¯0æˆ–è€…æ˜¯å¸¸é‡æ± ä¸­çš„ä¸€ä¸ªæœ‰æ•ˆç´¢å¼•ï¼Œå¦‚æœ<code>super_class</code>ä¸ä¸º0ï¼Œåˆ™å…¶å¯¹åº”çš„å¸¸é‡æ± ä¸­çš„é¡¹å¿…é¡»æ˜¯<code>CONSTANT_Class_info</code>çš„ç»“æ„ï¼Œä»£è¡¨åœ¨classæ–‡ä»¶ä¸­ï¼Œæ˜¯è¯¥ç±»çš„ç›´æ¥è¶…ç±»ã€‚è¯¥ç›´æ¥è¶…ç±»å’Œå…¶ä»–è¶…ç±»éƒ½ä¸å…è®¸è¢«<code>access_flags</code>ä¸º<code>ACC_FINAL</code>çš„ä¿®é¥°ç¬¦ä¿®é¥°ã€‚</p><h4 id="7-interfaces-count"><a href="#7-interfaces-count" class="headerlink" title="7. interfaces_count"></a>7. interfaces_count</h4><p>è¡¨ç¤ºè¯¥ç±»(æˆ–æ¥å£)ç›´æ¥å®ç°(æˆ–ç»§æ‰¿)çš„æ¥å£æ•°</p><h4 id="8-interfaces"><a href="#8-interfaces" class="headerlink" title="8. interfaces[]"></a>8. interfaces[]</h4><p>è¡¨ç¤ºçš„è¯¥ç±»(æˆ–æ¥å£)æ˜¯ç›´æ¥å®ç°(æˆ–ç»§æ‰¿)çš„æ¥å£é›†åˆåœ¨å¸¸é‡æ± ä¸­çš„ç´¢å¼•æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦åœ¨[0,interfaces_count)ä¹‹é—´ã€‚ä¸”å¸¸é‡æ± ä¸­å¯¹åº”çš„ç´¢å¼•å¿…é¡»éƒ½æ˜¯<code>CONSTANT_Class_info</code>çš„ç»“æ„ã€‚</p><h4 id="9-fields-count"><a href="#9-fields-count" class="headerlink" title="9. fields_count"></a>9. fields_count</h4><p>è¡¨ç¤ºè¯¥ç±»ä¸­å®šä¹‰çš„å­—æ®µ(åŒ…æ‹¬é™æ€å˜é‡å’Œå®ä¾‹å˜é‡)çš„æ•°é‡</p><h4 id="10-fields"><a href="#10-fields" class="headerlink" title="10. fields[]"></a>10. fields[]</h4><p>è¡¨ç¤ºå­—æ®µæ•°ç»„ï¼Œæ¯ä¸€é¡¹çš„ç±»å‹å¿…é¡»æ˜¯<code>field_info</code>ï¼Œä»¥æä¾›è¯¥ç±»æˆ–æ¥å£ä¸­å­—æ®µçš„å®Œæ•´æè¿°ã€‚è¿™ä¸ªå­—æ®µæ•°ç»„åªåŒ…å«è¯¥ç±»æˆ–æ¥å£è‡ªå·±å®šä¹‰çš„å­—æ®µï¼Œä¸åŒ…å«ä»è¶…ç±»æˆ–è¶…æ¥å£ä¸­ç»§æ‰¿çš„å­—æ®µã€‚</p><h4 id="11-methods-count"><a href="#11-methods-count" class="headerlink" title="11. methods_count"></a>11. methods_count</h4><p>è¡¨ç¤ºè¯¥ç±»æˆ–æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•æ•°é‡</p><h4 id="12-methods"><a href="#12-methods" class="headerlink" title="12. methods[]"></a>12. methods[]</h4><p>è¡¨ç¤ºæ–¹æ³•æ•°ç»„ï¼Œæ¯ä¸€é¡¹çš„ç±»å‹å¿…é¡»æ˜¯<code>method_info</code>ï¼Œä»¥æä¾›è¯¥ç±»æˆ–æ¥å£ä¸­å­—æ®µçš„å®Œæˆæè¿°ã€‚æ–¹æ³•æ•°ç»„åŒ…å«è¿™ä¸ªç±»æˆ–æ¥å£å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼Œä½†æ˜¯ä¸åŒ…å«ä»è¶…ç±»æˆ–è¶…æ¥å£ä¸­ç»§æ‰¿çš„æ–¹æ³•ã€‚å¦‚æœæŸäº›é¡¹ä¸­æœªè®¾ç½®<code>access_flags</code>ä¸º<code>ACC_NATIVE</code>æˆ–<code>ACC_ABSTRACT</code>çš„ä¿®é¥°ç¬¦ï¼Œè¿˜éœ€è¦æä¾›å®ç°è¯¥æ–¹æ³•çš„jvmæŒ‡ä»¤ã€‚</p><h4 id="13-attributes-count"><a href="#13-attributes-count" class="headerlink" title="13. attributes_count"></a>13. attributes_count</h4><p>è¡¨ç¤ºè¯¥ç±»æˆ–æ¥å£ä¸­å®šä¹‰çš„å±æ€§çš„æ•°é‡</p><h4 id="14-attributes"><a href="#14-attributes" class="headerlink" title="14. attributes[]"></a>14. attributes[]</h4><p>è¡¨ç¤ºè¯¥classæ–‡ä»¶ä¸­å®šä¹‰çš„å±æ€§åˆ—è¡¨ï¼Œå…¶ä¸­çš„æ¯ä¸€é¡¹å¿…é¡»æ˜¯<code>attribute_info</code>ç±»å‹ã€‚</p><h3 id="2-å®Œå…¨é™å®šå"><a href="#2-å®Œå…¨é™å®šå" class="headerlink" title="2. å®Œå…¨é™å®šå"></a>2. å®Œå…¨é™å®šå</h3><p>ç±»æˆ–æ¥å£åœ¨classæ–‡ä»¶ä¸­å§‹ç»ˆä»¥å®Œå…¨é™å®šåè¡¨ç¤ºï¼Œè¿™ç±»åç§°ä½¿ç”¨<code>CONSTANT_Utf8_info</code>ç»“æ„è¿›è¡Œè¡¨ç¤ºã€‚<br>ç±»å’Œæ¥å£æ˜¯ä»å°†è¿™ç±»åç§°ä½œä¸ºä»–ä»¬æè¿°ç¬¦(descriptor)çš„ä¸€éƒ¨åˆ†çš„<code>CONSTANT_NameAndType_info</code>å’Œ<code>CONSTANT_Class_info</code>çš„ç»“æ„ä¸­å¼•ç”¨çš„ã€‚<br>ç”±äºå†å²åŸå› ï¼Œå‡ºç°åœ¨classæ–‡ä»¶ä¸­çš„å®Œå…¨é™å®šåå’Œæˆ‘ä»¬åœ¨ç¨‹åºä¸­ä½¿ç”¨çš„å®Œå…¨é™å®šåä¸ä¸€æ ·ï¼Œåœ¨classå†…éƒ¨ç»“æ„ä¸­ï¼Œé€šå¸¸ä¼šå°†è‹±æ–‡ç¬¦å·çš„<code>.</code>ä½¿ç”¨æ­£æ–œæ <code>/</code>ä»£æ›¿ã€‚</p><blockquote><p>å¦‚<code>Thread</code>ç±»çš„å®Œå…¨é™å®šåæ˜¯<code>java.lang.Thread</code>ï¼Œåœ¨classæ–‡ä»¶æ ¼å¼çš„æè¿°ç¬¦ä¸­ï¼Œ<code>Thread</code>ä½¿ç”¨<code>CONSTANT_Utf8_info</code>ç»“æ„çš„å­—ç¬¦ä¸²<code>java/lang/Thread</code>æ¥å®ç°å¯¹ç±»åçš„å¼•ç”¨ã€‚</p></blockquote><hr><h3 id="3-éé™å®šåç§°"><a href="#3-éé™å®šåç§°" class="headerlink" title="3. éé™å®šåç§°"></a>3. éé™å®šåç§°</h3><p>æ–¹æ³•ï¼Œå­—æ®µï¼Œå±€éƒ¨å˜é‡å’Œå½¢å‚çš„åç§°éƒ½ä»¥éé™å®šåç§°å­˜å‚¨ï¼Œéé™å®šåç§°è‡³å°‘è¦åŒ…å«ä¸€ä¸ªUnicode<code>ä»£ç ç‚¹</code>ä¸”ä¸å…è®¸åŒ…å«<code>. ; [ /</code>çš„å­—ç¬¦ã€‚<br>æ–¹æ³•åç§°è¿˜å—åˆ°è¿›ä¸€æ­¥çš„é™åˆ¶ï¼šé™¤äº†ç‰¹æ®Šæ–¹æ³•åç§°<code>&lt;init&gt;</code>å’Œ<code>&lt;clinit&gt;</code>ï¼Œæ–¹æ³•åç§°ä¸å¾—åŒ…å«<code>&lt; &gt;</code>çš„å­—ç¬¦ã€‚<br>è¯·æ³¨æ„ï¼Œå­—æ®µåç§°æˆ–æ¥å£æ–¹æ³•åç§°å¯ä»¥æ˜¯<code>&lt;init&gt;</code>æˆ–<code>&lt;clinit&gt;</code>ï¼Œä½†æ˜¯ä»»ä½•æ–¹æ³•è°ƒç”¨æŒ‡ä»¤éƒ½ä¸èƒ½å¼•ç”¨<code>&lt;clinit&gt;</code>ï¼Œè€Œåªæœ‰<code>invokespecial</code>æŒ‡ä»¤å¯ä»¥å¼•ç”¨<code>&lt;init&gt;</code>ã€‚</p><h3 id="4-æè¿°ç¬¦"><a href="#4-æè¿°ç¬¦" class="headerlink" title="4. æè¿°ç¬¦"></a>4. æè¿°ç¬¦</h3><blockquote><p>æè¿°ç¬¦è¡¨ç¤ºä¸€ä¸ªå­—æ®µæˆ–æ–¹æ³•ç±»å‹çš„å­—ç¬¦ä¸²ã€‚</p></blockquote><h4 id="1-å­—æ®µæè¿°ç¬¦"><a href="#1-å­—æ®µæè¿°ç¬¦" class="headerlink" title="1. å­—æ®µæè¿°ç¬¦"></a>1. å­—æ®µæè¿°ç¬¦</h4><table><thead><tr><th>classæ–‡ä»¶ä¸­çš„å­—æ®µç±»å‹</th><th>å­—æ®µç±»å‹</th><th>è§£é‡Š</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>V</td><td>void</td><td>voidç±»å‹</td><td>V -&gt; void</td></tr><tr><td>B</td><td>byte</td><td>æœ‰ç¬¦å·çš„byteç±»å‹</td><td>B -&gt; byte</td></tr><tr><td>C</td><td>char</td><td>å­—ç¬¦ç±»å‹</td><td>C -&gt; char</td></tr><tr><td>D</td><td>double</td><td>åŒç²¾åº¦æµ®ç‚¹ç±»å‹</td><td>D -&gt; double</td></tr><tr><td>F</td><td>float</td><td>å•ç²¾åº¦æµ®ç‚¹ç±»å‹</td><td>F -&gt; float</td></tr><tr><td>I</td><td>int</td><td>æ•´å‹</td><td>I -&gt; int</td></tr><tr><td>J</td><td>long</td><td>é•¿æ•´å‹</td><td>J -&gt; long</td></tr><tr><td>L</td><td>className;</td><td>å¼•ç”¨</td><td>ä¸€ä¸ªç±»å®ä¾‹çš„å¼•ç”¨</td></tr><tr><td>S</td><td>short</td><td>æœ‰ç¬¦å·çš„çŸ­æ•´å‹</td><td>S -&gt; short</td></tr><tr><td>Z</td><td>boolean</td><td>å¸ƒå°”ç±»å‹</td><td>Z -&gt; boolean</td></tr><tr><td>[</td><td>ä¸€ç»´æ•°ç»„</td><td>ä¸€ç»´æ•°ç»„çš„å¼•ç”¨</td><td>[[[D -&gt; double[][][]</td></tr></tbody></table><h4 id="2-æ–¹æ³•æè¿°ç¬¦"><a href="#2-æ–¹æ³•æè¿°ç¬¦" class="headerlink" title="2. æ–¹æ³•æè¿°ç¬¦"></a>2. æ–¹æ³•æè¿°ç¬¦</h4><blockquote><p>æ–¹æ³•æè¿°ç¬¦çš„è¡¨è¾¾å¼: <code>(å‚æ•°æè¿°ç¬¦) è¿”å›å€¼æè¿°ç¬¦</code></p></blockquote><p>ç¤ºä¾‹ï¼š</p><blockquote><p>void m(int i,double d) { â€¦ } -&gt; (ID)V<br>Object m(int i,double d,Thread t) { â€¦ } -&gt; (IDLjava/lang/Thread;)Ljava/lang/Object;</p></blockquote><!-- `this`å…³é”®å­—å¯¹å¯¹è±¡çš„å¼•ç”¨é™¤äº†é¢„æœŸçš„å‚æ•°å¤–ï¼Œå¹¶æœªååº”åœ¨æ–¹æ³•æè¿°ç¬¦ä¸­ï¼Œå®é™…ä¸Šï¼Œå¯¹`this`çš„å¼•ç”¨ç”±è°ƒç”¨å®ä¾‹æ–¹æ³•çš„jvmæŒ‡ä»¤éšå¼ä¼ é€’ã€‚ --><h3 id="5-å®æˆ˜"><a href="#5-å®æˆ˜" class="headerlink" title="5. å®æˆ˜"></a>5. å®æˆ˜</h3><p>ä¸‹é¢å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ä½“ä¼šä¸Šè¿°æ–‡æ¡£çš„å«ä¹‰ã€‚</p><h4 id="1-åˆ›å»ºé¡¹ç›®ï¼Œå¹¶å¼•å…¥ä¾èµ–"><a href="#1-åˆ›å»ºé¡¹ç›®ï¼Œå¹¶å¼•å…¥ä¾èµ–" class="headerlink" title="1. åˆ›å»ºé¡¹ç›®ï¼Œå¹¶å¼•å…¥ä¾èµ–"></a>1. åˆ›å»ºé¡¹ç›®ï¼Œå¹¶å¼•å…¥ä¾èµ–</h4><p>ä½¿ç”¨ideåˆ›å»ºä¸€ä¸ªjavaé¡¹ç›®ï¼Œå¹¶å¼•å…¥mavenä¾èµ–(å…¶å®jdké‡Œå·²ç»åŒ…å«asmåº“äº†)</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.ow2.asm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>asm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>7.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-ç¼–å†™javaæ–‡ä»¶"><a href="#2-ç¼–å†™javaæ–‡ä»¶" class="headerlink" title="2. ç¼–å†™javaæ–‡ä»¶"></a>2. ç¼–å†™javaæ–‡ä»¶</h4><p>åˆ›å»ºä¸€ä¸ªjavaæ–‡ä»¶ï¼Œå¯ä»¥å‘½åä¸º<code>ClassWriterTest.java</code>ï¼Œå¹¶è¾“å…¥å¦‚ä¸‹ä»£ç ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>objectweb<span class="token punctuation">.</span>asm<span class="token punctuation">.</span>ClassWriter<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token keyword">static</span> org<span class="token punctuation">.</span>objectweb<span class="token punctuation">.</span>asm<span class="token punctuation">.</span>Opcodes<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassWriterTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        ClassWriter classWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        classWriter<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>V1_8<span class="token punctuation">,</span>ACC_PUBLIC<span class="token operator">+</span>ACC_ABSTRACT<span class="token operator">+</span>ACC_INTERFACE<span class="token punctuation">,</span>                <span class="token string">"pkg/Comparable"</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span><span class="token string">"java/lang/Object"</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"java/io/Serializable"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        classWriter<span class="token punctuation">.</span><span class="token function">visitField</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token operator">+</span>ACC_FINAL<span class="token operator">+</span>ACC_STATIC<span class="token punctuation">,</span><span class="token string">"LESS"</span><span class="token punctuation">,</span>                <span class="token string">"I"</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        classWriter<span class="token punctuation">.</span><span class="token function">visitField</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token operator">+</span>ACC_FINAL<span class="token operator">+</span>ACC_STATIC<span class="token punctuation">,</span><span class="token string">"EQUAL"</span><span class="token punctuation">,</span>                <span class="token string">"Z"</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        classWriter<span class="token punctuation">.</span><span class="token function">visitField</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token operator">+</span>ACC_FINAL<span class="token operator">+</span>ACC_STATIC<span class="token punctuation">,</span><span class="token string">"GREATER"</span><span class="token punctuation">,</span>                <span class="token string">"J"</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        classWriter<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token operator">+</span>ACC_ABSTRACT<span class="token punctuation">,</span><span class="token string">"compareTo"</span><span class="token punctuation">,</span>                <span class="token string">"(Ljava/lang/Object;)I"</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        classWriter<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> classWriter<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"./Comparable.class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œä»£ç çš„ç»“æœä¼šç”Ÿæˆä¸€ä¸ª<code>Comparable.class</code>æ–‡</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Comparable.class</span><span class="token keyword">package</span> pkg<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparable</span> <span class="token keyword">extends</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> LESS <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> EQUAL <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> GREATER <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object o<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆä»£ç å’Œç”Ÿæˆçš„classæ–‡ä»¶ï¼Œä½ å¯¹ä¸Šé¢çš„æ–‡æ¡£æœ‰æ›´æ·±çš„äº†è§£äº†å—ï¼Ÿ</p><p>å‚è€ƒ: <a href="https://docs.oracle.com/javase/specs/jvms/se13/html/jvms-4.htm" target="_blank" rel="noopener">Java Virtual Machine Specification-ch4</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> jdk-tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> jdk </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HashCode</title>
      <link href="2020/03/15/source-hash-hashcode/"/>
      <url>2020/03/15/source-hash-hashcode/</url>
      
        <content type="html"><![CDATA[<h1 id="HashCode"><a href="#HashCode" class="headerlink" title="HashCode"></a>HashCode</h1><h3 id="1-hashCodeå£°æ˜"><a href="#1-hashCodeå£°æ˜" class="headerlink" title="1. hashCodeå£°æ˜"></a>1. hashCodeå£°æ˜</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * Returns a hash code value for the object. This method is     * supported for the benefit of hash tables such as those provided by     * {@link java.util.HashMap}.     * &lt;p>     * The general contract of {@code hashCode} is:     * &lt;ul>     * &lt;li>Whenever it is invoked on the same object more than once during     *     an execution of a Java application, the {@code hashCode} method     *     must consistently return the same integer, provided no information     *     used in {@code equals} comparisons on the object is modified.     *     This integer need not remain consistent from one execution of an     *     application to another execution of the same application.     * &lt;li>If two objects are equal according to the {@code equals(Object)}     *     method, then calling the {@code hashCode} method on each of     *     the two objects must produce the same integer result.     * &lt;li>It is &lt;em>not&lt;/em> required that if two objects are unequal     *     according to the {@link java.lang.Object#equals(java.lang.Object)}     *     method, then calling the {@code hashCode} method on each of the     *     two objects must produce distinct integer results.  However, the     *     programmer should be aware that producing distinct integer results     *     for unequal objects may improve the performance of hash tables.     * &lt;/ul>     *     * @implSpec     * As far as is reasonably practical, the {@code hashCode} method defined     * by class {@code Object} returns distinct integers for distinct objects.     *     * @return  a hash code value for this object.     * @see     java.lang.Object#equals(java.lang.Object)     * @see     java.lang.System#identityHashCode     */</span>    <span class="token annotation punctuation">@HotSpotIntrinsicCandidate</span>    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ ¹æ®æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“å‡ ç‚¹ï¼š(å·²çŸ¥å­˜åœ¨xï¼Œyä¸¤ä¸ªå¯¹è±¡)</p></blockquote><pre><code>1. Objectç±»çš„hashCodeå‡½æ•°æ˜¯æœ¬åœ°æ–¹æ³•2. å¦‚æœx.equals(y)==trueï¼Œåˆ™xï¼Œyçš„hashCodeä¸€å®šç›¸ç­‰3. å¦‚æœx.equals(y)==false,åˆ™xï¼Œyçš„hashCodeæœ‰å¯èƒ½ç›¸ç­‰4. å¦‚æœx.equals(y)==false,ä¸”x,yçš„hashCodeä¸ç›¸ç­‰ä¼šæé«˜hashè¡¨æŸ¥æ‰¾æ€§èƒ½5. å¦‚æœå­ç±»é‡å†™equalsæ–¹æ³•ï¼Œå»ºè®®åŒæ—¶é‡å†™hashCodeæ–¹æ³•ï¼Œåä¹‹äº¦ç„¶</code></pre><h3 id="2-å¸¸è§ç”ŸæˆhashCodeçš„æ–¹å¼"><a href="#2-å¸¸è§ç”ŸæˆhashCodeçš„æ–¹å¼" class="headerlink" title="2. å¸¸è§ç”ŸæˆhashCodeçš„æ–¹å¼"></a>2. å¸¸è§ç”ŸæˆhashCodeçš„æ–¹å¼</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token number">1</span><span class="token punctuation">.</span> Objects<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">2</span><span class="token punctuation">.</span> System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>Object x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">3</span><span class="token punctuation">.</span> HashCodeBuilder<span class="token punctuation">.</span><span class="token function">reflectionHashCode</span><span class="token punctuation">(</span>Object x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>ç¤ºä¾‹ï¼šç”Ÿæˆå­—ç¬¦ä¸²â€Aaâ€,â€BBâ€çš„hashCode</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token string">"Aa"</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                  <span class="token comment" spellcheck="true">// hashCode -> 2112</span><span class="token string">"BB"</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                  <span class="token comment" spellcheck="true">// hashCode -> 2112</span>Objects<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">"Aa"</span><span class="token punctuation">)</span>                               <span class="token comment" spellcheck="true">// hash -> 2143</span>Objects<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">"BB"</span><span class="token punctuation">)</span>                               <span class="token comment" spellcheck="true">// hash -> 2143</span>System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token string">"Aa"</span><span class="token punctuation">)</span>                    <span class="token comment" spellcheck="true">// hashCode -> 1528902577</span>System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token string">"BB"</span><span class="token punctuation">)</span>                    <span class="token comment" spellcheck="true">// hashCode -> 1927950199</span>HashCodeBuilder<span class="token punctuation">.</span><span class="token function">reflectionHashCode</span><span class="token punctuation">(</span><span class="token string">"Aa"</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">// hashCode -> 1305660456</span>HashCodeBuilder<span class="token punctuation">.</span><span class="token function">reflectionHashCode</span><span class="token punctuation">(</span><span class="token string">"BB"</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">// hashCode -> 1305964374</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-Stringç±»çš„hashCodeå®ç°"><a href="#3-Stringç±»çš„hashCodeå®ç°" class="headerlink" title="3. Stringç±»çš„hashCodeå®ç°"></a>3. Stringç±»çš„hashCodeå®ç°</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * Returns a hash code for this string. The hash code for a     * {@code String} object is computed as     * &lt;blockquote>&lt;pre>     * s[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]     * &lt;/pre>&lt;/blockquote>     * using {@code int} arithmetic, where {@code s[i]} is the     * &lt;i>i&lt;/i>th character of the string, {@code n} is the length of     * the string, and {@code ^} indicates exponentiation.     * (The hash value of the empty string is zero.)     *     * @return  a hash code value for this object.     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// The hash or hashIsZero fields are subject to a benign data race,</span>        <span class="token comment" spellcheck="true">// making it crucial to ensure that any observable result of the</span>        <span class="token comment" spellcheck="true">// calculation in this method stays correct under any possible read of</span>        <span class="token comment" spellcheck="true">// these fields. Necessary restrictions to allow this to be correct</span>        <span class="token comment" spellcheck="true">// without explicit memory fences or similar concurrency primitives is</span>        <span class="token comment" spellcheck="true">// that we can ever only write to one of these two fields for a given</span>        <span class="token comment" spellcheck="true">// String instance, and that the computation is idempotent and derived</span>        <span class="token comment" spellcheck="true">// from immutable state</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> hash<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hashIsZero<span class="token punctuation">)</span> <span class="token punctuation">{</span>            h <span class="token operator">=</span> <span class="token function">isLatin1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> StringLatin1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>                           <span class="token operator">:</span> StringUTF16<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                hashIsZero <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                hash <span class="token operator">=</span> h<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> h<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ ¹æ®æ³¨é‡Šå¯çŸ¥</p></blockquote><pre><code>1. Stringçš„hashCodeè®¡ç®—å…¬å¼ï¼šs[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]</code></pre><blockquote><p>StringLatin1.hashCode(byte[] value)å®ç°</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> v <span class="token operator">:</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        h <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> h <span class="token operator">+</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> h<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>é€‰æ‹©æ•°å­—31æ˜¯å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¥‡è´¨æ•°ï¼Œå¦‚æœé€‰æ‹©ä¸€ä¸ªå¶æ•°ä¼šåœ¨ä¹˜æ³•è¿ç®—ä¸­äº§ç”Ÿæº¢å‡ºï¼Œå¯¼è‡´æ•°å€¼ä¿¡æ¯ä¸¢å¤±ï¼Œå› ä¸ºä¹˜äºŒç›¸å½“äºç§»ä½è¿ç®—ã€‚é€‰æ‹©è´¨æ•°çš„ä¼˜åŠ¿å¹¶ä¸æ˜¯ç‰¹åˆ«çš„æ˜æ˜¾ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªä¼ ç»Ÿã€‚åŒæ—¶ï¼Œæ•°å­—31æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ï¼Œå³ä¹˜æ³•è¿ç®—å¯ä»¥è¢«ç§»ä½å’Œå‡æ³•è¿ç®—å–ä»£ï¼Œæ¥è·å–æ›´å¥½çš„æ€§èƒ½ï¼š<code>31 * i == (i &lt;&lt; 5) - i</code>ï¼Œç°ä»£çš„ Java è™šæ‹Ÿæœºå¯ä»¥è‡ªåŠ¨çš„å®Œæˆè¿™ä¸ªä¼˜åŒ–ã€‚<br>31æ˜¯è´¨å­æ•°ä¸­ä¸€ä¸ªâ€œä¸å¤§ä¸å°â€çš„å­˜åœ¨ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå¦‚2çš„è¾ƒå°è´¨æ•°ï¼Œé‚£ä¹ˆå¾—å‡ºçš„ä¹˜ç§¯ä¼šåœ¨ä¸€ä¸ªå¾ˆå°çš„èŒƒå›´ï¼Œå¾ˆå®¹æ˜“é€ æˆå“ˆå¸Œå€¼çš„å†²çªã€‚è€Œå¦‚æœé€‰æ‹©ä¸€ä¸ª100ä»¥ä¸Šçš„è´¨æ•°ï¼Œå¾—å‡ºçš„å“ˆå¸Œå€¼ä¼šè¶…å‡ºintçš„æœ€å¤§èŒƒå›´ï¼Œè¿™ä¸¤ç§éƒ½ä¸åˆé€‚ã€‚å¦‚æœä½ å¯¹è¶…è¿‡50000ä¸ªè‹±æ–‡å•è¯ï¼ˆç”±ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„Unixå­—å…¸åˆå¹¶è€Œæˆè¿›è¡Œhashcodeè¿ç®—ï¼Œå¹¶ä½¿ç”¨å¸¸æ•°<code>31</code>,<code>33</code>,<code>37</code>,<code>39</code>å’Œ<code>41</code>ä½œä¸ºä¹˜å­ï¼Œæ¯ä¸ªå¸¸æ•°ç®—å‡ºçš„å“ˆå¸Œå€¼å†²çªæ•°éƒ½å°äº7ä¸ªï¼Œæ‰€ä»¥åœ¨ä¸Šé¢å‡ ä¸ªå¸¸æ•°ä¸­ï¼Œå¸¸æ•°<code>31</code>è¢« Javaå®ç°æ‰€é€‰ç”¨ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†</p></blockquote><h3 id="4-0xffé—®é¢˜"><a href="#4-0xffé—®é¢˜" class="headerlink" title="4. 0xffé—®é¢˜"></a>4. 0xffé—®é¢˜</h3><blockquote><p>è®¡ç®—æœºä¸­å­˜å‚¨çš„æ•°æ®éƒ½æ˜¯ä»¥è¡¥ç çš„å½¢å¼å­˜å‚¨çš„</p><blockquote><p>åŸç </p><blockquote><p>æ­£æ•°ï¼šï¼ˆåè¿›åˆ¶ï¼‰æ­£æ•°è½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯è¯¥æ­£æ•°çš„åŸç <br> è´Ÿæ•°ï¼šï¼ˆåè¿›åˆ¶ï¼‰è´Ÿæ•°çš„ç»å¯¹å€¼è½¬æ¢æˆäºŒè¿›åˆ¶ç„¶ååœ¨é«˜ä½è¡¥1å°±æ˜¯è¯¥è´Ÿæ•°çš„åŸç </p></blockquote></blockquote></blockquote><blockquote><blockquote><p>åç </p><blockquote><p>æ­£æ•°ï¼šï¼ˆåè¿›åˆ¶ï¼‰æ­£æ•°çš„åç ä¸åŸç ç›¸åŒ<br>è´Ÿæ•°ï¼šï¼ˆåè¿›åˆ¶ï¼‰è´Ÿæ•°çš„åç ç­‰äºåŸç é™¤ç¬¦å·ä½ä»¥å¤–æ‰€æœ‰çš„ä½å–å</p></blockquote></blockquote></blockquote><blockquote><blockquote><p>è¡¥ç </p><blockquote><p>æ­£æ•°ï¼šï¼ˆåè¿›åˆ¶ï¼‰æ­£æ•°çš„è¡¥ç ä¸åŸç ç›¸åŒ<br>è´Ÿæ•°ï¼šï¼ˆåè¿›åˆ¶ï¼‰è´Ÿæ•°çš„è¡¥ç ç­‰äºè´Ÿæ•°çš„åŸç æœ€ä½ä½åŠ 1</p></blockquote></blockquote></blockquote><table><thead><tr><th>num</th><th>åŸç </th><th>åç </th><th>è¡¥ç </th></tr></thead><tbody><tr><td>128</td><td>1000 0000</td><td>1000 0000</td><td>1000 0000</td></tr><tr><td>-127</td><td>1111 1111</td><td>1000 0000</td><td>1000 0001</td></tr></tbody></table><h4 id="a-ä¸ºä»€ä¹ˆè¦v-amp-0xffï¼Ÿ"><a href="#a-ä¸ºä»€ä¹ˆè¦v-amp-0xffï¼Ÿ" class="headerlink" title="a. ä¸ºä»€ä¹ˆè¦v&amp;0xffï¼Ÿ"></a>a. ä¸ºä»€ä¹ˆè¦v&amp;0xffï¼Ÿ<br></h4><blockquote><p>&amp;è¡¨ç¤ºæŒ‰ä½ä¸ï¼Œåªæœ‰ä¸¤ä¸ªæ•°åŒæ—¶ä¸º1ï¼Œæ‰èƒ½å¾—åˆ°1<br>0xffè¡¨ç¤ºçš„äºŒè¿›åˆ¶æ•°æ˜¯<code>1111 1111</code>,å ä¸€ä¸ªå­—èŠ‚ï¼Œå’Œå…¶è¿›è¡Œ&amp;æ“ä½œçš„æ•°ï¼Œæœ€ä½8ä½ï¼Œä¸ä¼šå‘ç”Ÿå˜åŒ–</p></blockquote><h5 id="1-ç¤ºä¾‹"><a href="#1-ç¤ºä¾‹" class="headerlink" title="1. ç¤ºä¾‹"></a>1. ç¤ºä¾‹</h5><p>å½“byteç±»å‹çš„æ•°å­—ï¼ˆå¦‚-127ï¼‰è½¬æ¢ä¸ºintç±»å‹çš„æ—¶å€™ï¼Œå…¶è¡¥ç å°†æå‡åˆ°32ä½ï¼Œè¡¥ç çš„é«˜ä½è¡¥1</p><blockquote><p>(byte)-127 -&gt; (int)-127 æ—¶</p></blockquote><pre><code>1000 0001è½¬1111 1111 1111 1111 1111 1111 1000 0001</code></pre><blockquote><p>è´Ÿæ•°çš„è¡¥ç è½¬åŸç ï¼Œç¬¦å·ä½ä¸å˜ï¼Œå…¶ä»–ä½å–åï¼Œç„¶åæœ€ä½ä½åŠ 1</p></blockquote><pre><code>1111 1111 1111 1111 1111 1111 1000 0001 (-127è¡¥ç é«˜24ä½è¡¥1)è½¬1000 0000 0000 0000 0000 0000 0111 1111 (intç±»å‹çš„32ä½-127çš„åŸç )</code></pre><p>å¯ä»¥çœ‹å‡ºå½“byte-&gt;intæ—¶å¯ä»¥ä¿è¯åè¿›åˆ¶ä¸å˜</p><p>ä½†æ˜¯æœ‰æ—¶å€™å¦‚æ–‡ä»¶æµè½¬ä¸ºbyteæ•°ç»„çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒå¯¹åº”çš„åè¿›åˆ¶æ•°æœ‰æ²¡æœ‰å˜ï¼Œè€Œæ˜¯å…³å¿ƒå¯¹åº”çš„è¡¥ç æœ‰æ²¡æœ‰å˜ï¼Œè¿™æ—¶å€™å°±éœ€è¦åŠ ä¸Š&amp;0xffã€‚</p><p>ä¸Šä¾‹ä¸­ï¼Œbyte-&gt;inté«˜24ä½å¿…å°†è¡¥1ï¼Œæ­¤æ—¶è¡¥ç æ˜¾ç„¶å‘ç”Ÿå˜åŒ–ï¼Œå†&amp;0xffï¼Œå°†é«˜24ä½é‡æ–°ç½®0ï¼Œè¿™æ ·å°±èƒ½ä¿è¯è¡¥ç çš„ä¸€è‡´æ€§ï¼Œç”±äºç¬¦å·ä½å‘ç”Ÿå˜åŒ–ï¼Œè¡¨ç¤ºçš„åè¿›åˆ¶æ•°ä¹Ÿä¼šæ”¹å˜ã€‚</p><pre><code>1111 1111 1111 1111 1111 1111 1000 0001&amp;0000 0000 0000 0000 0000 0000 1111 1111 ç»“æœï¼š0000 0000 0000 0000 0000 0000 1000 0001 -&gt; æ­£æ•°çš„è¡¥ç ==åŸç  -&gt; 129</code></pre><p>å’ŒåŸæ¥çš„è¡¥ç ä¸€è‡´ï¼Œä½†æ˜¯æ˜¾ç„¶ç¬¦å·ä½å˜äº†ï¼Œè¡¨ç¤ºçš„åè¿›åˆ¶å‘ç”Ÿå˜åŒ–ï¼Œå˜ä¸º129</p><h5 id="2-æ€»ç»“"><a href="#2-æ€»ç»“" class="headerlink" title="2.æ€»ç»“"></a>2.æ€»ç»“</h5><blockquote><p>å–å¾—ä½8ä½<br>ä¿æŒè¡¥ç çš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯è¡¨ç¤ºçš„åè¿›åˆ¶æ•°å¯èƒ½ä¼šå˜</p></blockquote><h3 id="5-ä¸ºä»€ä¹ˆhashCodeå¯èƒ½ä¼šç›¸åŒ"><a href="#5-ä¸ºä»€ä¹ˆhashCodeå¯èƒ½ä¼šç›¸åŒ" class="headerlink" title="5. ä¸ºä»€ä¹ˆhashCodeå¯èƒ½ä¼šç›¸åŒ"></a>5. ä¸ºä»€ä¹ˆhashCodeå¯èƒ½ä¼šç›¸åŒ</h3><blockquote><p>å“ˆå¸Œè¡¨ç»“åˆäº†<strong>ç›´æ¥å¯»å€</strong>å’Œ<strong>é“¾å¼å¯»å€</strong>ä¸¤ç§æ–¹å¼ï¼Œæ‰€éœ€è¦çš„å°±æ˜¯å°†éœ€è¦åŠ å…¥å“ˆå¸Œè¡¨çš„æ•°æ®é¦–å…ˆè®¡ç®—å“ˆå¸Œå€¼ï¼Œé¢„å…ˆåˆ†ç»„ï¼Œç„¶åå†å°†æ•°æ®æŒ‚åˆ°åˆ†ç»„åçš„é“¾è¡¨ä¸­ï¼Œéšç€æ·»åŠ çš„æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œåˆ†ç»„é“¾ä¸Šä¼šæŒ‚æ¥æ›´å¤šçš„æ•°æ®ï¼ŒåŒä¸€ä¸ªåˆ†ç»„é“¾ä¸Šçš„æ•°æ®å¿…å®šå…·æœ‰ç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œå› ä¸ºjavaçš„hashå‡½æ•°è¿”å›å€¼æ˜¯intç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å¤šå…è®¸å­˜åœ¨2^32ä¸ªåˆ†ç»„ï¼Œä¹Ÿæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å‡ºç°ç›¸åŒçš„hashå€¼ã€‚</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> jdk-tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> jdk </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaæ‰«æjaråŒ…å’Œmvné¡¹ç›®å­æ¨¡å—</title>
      <link href="2020/03/08/java-sao-miao-jar-bao-he-mvn-xiang-mu-zi-mo-kuai/"/>
      <url>2020/03/08/java-sao-miao-jar-bao-he-mvn-xiang-mu-zi-mo-kuai/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åˆšå…¥èŒï¼Œé¢†å¯¼åˆ†é…äº†ä¸€ä¸ªå°ä»»åŠ¡ï¼šå°†è‡ªç ”çš„mqç³»ç»Ÿçš„é…ç½®å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚å¬èµ·æ¥å¥½åƒæŒºç®€å•ï¼Œä½†æ˜¯ä¸€çœ‹ä»£ç å‘ç°å¥½å¤šé…ç½®é¡¹ä¸åœ¨ä¸€ä¸ªmoduleé‡Œï¼Œè€Œä¸”æœ‰çš„é…ç½®é¡¹ç½®åªæš´éœ²å‡ºæ¥apiï¼Œå¦‚æœåœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ³•è·å–åˆ°æ‰€æœ‰é…ç½®é¡¹çš„ã€‚æƒ³äº†ä¸€ä¸‹åˆï¼Œæƒ³åˆ°ä½¿ç”¨<code>spi</code>æˆ–è€…<code>asm</code>æ¥è§£å†³ï¼Œ<code>spi</code>ä¸€æ ·æœ‰æ— æ³•è·å–<code>private</code>,<code>package-protected</code>æˆ–è€…å…¶ä»–æ¨¡å—çš„é…ç½®é¡¹çš„é—®é¢˜ã€‚<code>asm</code>æƒ³ç€åº”è¯¥å¯ä»¥è§£å†³ï¼Œä½†æˆ‘æ˜¯ä¸ª<code>asm</code>åŠåŠå­æ°´è´§ï¼Œç”¨çš„ä¸å¥½ã€‚æ‰€ä»¥æƒ³æ¥æƒ³å»åªæƒ³åˆ°æ‰«æ<code>mvn</code>é¡¹ç›®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¥½åœ¨å·²ç»æœ‰äººé‡åˆ°è¿‡è¿™ç§é—®é¢˜å¹¶å·²ç»è§£å†³äº†(<a href="https://blog.csdn.net/a729913162/article/details/81698109" target="_blank" rel="noopener">åœ°å€</a>)ï¼Œå…ˆè¯´å£°è°¢è°¢å•¦ã€‚</p></blockquote><h3 id="å®šä¹‰Scanneræ¥å£"><a href="#å®šä¹‰Scanneræ¥å£" class="headerlink" title="å®šä¹‰Scanneræ¥å£"></a>å®šä¹‰Scanneræ¥å£</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Scanner</span> <span class="token punctuation">{</span>    String CLASS_SUFFIX <span class="token operator">=</span> <span class="token string">".class"</span><span class="token punctuation">;</span>    Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">,</span> Predicate<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">search</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šä¹‰FileScanner"><a href="#å®šä¹‰FileScanner" class="headerlink" title="å®šä¹‰FileScanner"></a>å®šä¹‰FileScanner</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileScanner</span> <span class="token keyword">implements</span> <span class="token class-name">Scanner</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String defaultClassPath <span class="token operator">=</span> FileScanner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">getDefaultClassPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> defaultClassPath<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDefaultClassPath</span><span class="token punctuation">(</span>String defaultClassPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassPath <span class="token operator">=</span> defaultClassPath<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">FileScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">FileScanner</span><span class="token punctuation">(</span>String defaultClassPath<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassPath<span class="token operator">=</span>defaultClassPath<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">,</span> Predicate<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String classPath <span class="token operator">=</span> defaultClassPath<span class="token punctuation">;</span>        String basePkgPath <span class="token operator">=</span> pkgName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span>File<span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>        String searchPath <span class="token operator">=</span> classPath<span class="token operator">+</span>basePkgPath<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClassSearcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>searchPath<span class="token punctuation">)</span><span class="token punctuation">,</span>pkgName<span class="token punctuation">,</span>predicate<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ClassSearcher</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> classPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">doPath</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span>String pkgName<span class="token punctuation">,</span>Predicate<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> predicate<span class="token punctuation">,</span><span class="token keyword">boolean</span> flag<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                File<span class="token punctuation">[</span><span class="token punctuation">]</span> files<span class="token operator">=</span>file<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>                    pkgName <span class="token operator">=</span> pkgName<span class="token operator">+</span><span class="token string">"."</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>files<span class="token operator">!=</span>null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span>File f <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">doPath</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> pkgName<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>CLASS_SUFFIX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>pkgName<span class="token operator">+</span><span class="token string">"."</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>predicate<span class="token operator">==</span>null<span class="token operator">||</span>predicate<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                            classPaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> classPaths<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šä¹‰JarScanner"><a href="#å®šä¹‰JarScanner" class="headerlink" title="å®šä¹‰JarScanner"></a>å®šä¹‰JarScanner</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JarScanner</span> <span class="token keyword">implements</span> <span class="token class-name">Scanner</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">,</span> Predicate<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> clazzSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Enumeration<span class="token operator">&lt;</span>URL<span class="token operator">></span> urlEnumeration <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>urlEnumeration<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                URL url <span class="token operator">=</span> urlEnumeration<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String protocol <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"jar"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    JarURLConnection connection <span class="token operator">=</span> <span class="token punctuation">(</span>JarURLConnection<span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>connection<span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>                        JarFile jarFile <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getJarFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>jarFile<span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>                            Enumeration<span class="token operator">&lt;</span>JarEntry<span class="token operator">></span> jarEntryEnumeration <span class="token operator">=</span> jarFile<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">while</span> <span class="token punctuation">(</span>jarEntryEnumeration<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                                JarEntry entry <span class="token operator">=</span> jarEntryEnumeration<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                String entryName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">if</span><span class="token punctuation">(</span>entryName<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>CLASS_SUFFIX<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>entryName<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                                    String clazzName <span class="token operator">=</span> entryName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>entryName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>clazzName<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token keyword">if</span><span class="token punctuation">(</span>predicate<span class="token operator">==</span>null<span class="token operator">||</span>predicate<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                                        clazzSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token punctuation">}</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    FileScanner fileScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    fileScanner<span class="token punctuation">.</span><span class="token function">setDefaultClassPath</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    clazzSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>fileScanner<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>predicate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> <span class="token operator">|</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> clazzSet<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šä¹‰ä¸¤ç§Scannerçš„å§”æ‰˜"><a href="#å®šä¹‰ä¸¤ç§Scannerçš„å§”æ‰˜" class="headerlink" title="å®šä¹‰ä¸¤ç§Scannerçš„å§”æ‰˜"></a>å®šä¹‰ä¸¤ç§Scannerçš„å§”æ‰˜</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScannerExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Scanner</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> ScannerExecutor INSTANCE<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">,</span> Predicate<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Scanner fileScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> fileSearch <span class="token operator">=</span> fileScanner<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>predicate<span class="token punctuation">)</span><span class="token punctuation">;</span>        Scanner jarScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> jarSearch <span class="token operator">=</span> jarScanner<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>predicate<span class="token punctuation">)</span><span class="token punctuation">;</span>        fileSearch<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>jarSearch<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> fileSearch<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token function">ScannerExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> ScannerExecutor <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>INSTANCE<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ScannerExecutor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>INSTANCE<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>                    INSTANCE<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ScannerExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šä¹‰å°è£…çš„å·¥å…·ç±»"><a href="#å®šä¹‰å°è£…çš„å·¥å…·ç±»" class="headerlink" title="å®šä¹‰å°è£…çš„å·¥å…·ç±»"></a>å®šä¹‰å°è£…çš„å·¥å…·ç±»</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassScanner</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">search</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">search</span><span class="token punctuation">(</span>String pkgName<span class="token punctuation">,</span> Predicate<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> predicate<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> ScannerExecutor<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>predicate<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> maven </tag>
            
            <tag> scanner </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯«å­ä¹¦</title>
      <link href="2020/02/14/jie-zi-shu/"/>
      <url>2020/02/14/jie-zi-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="è¯«å­ä¹¦"><a href="#è¯«å­ä¹¦" class="headerlink" title="è¯«å­ä¹¦"></a>è¯«å­ä¹¦</h3><p>å¤«å›å­ä¹‹è¡Œï¼Œé™ä»¥ä¿®èº«ï¼Œä¿­ä»¥å…»å¾·ã€‚éæ·¡æ³Šæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œã€‚å¤«å­¦é¡»é™ä¹Ÿï¼Œæ‰é¡»å­¦ä¹Ÿï¼Œéå­¦æ— ä»¥å¹¿æ‰ï¼Œéå¿—æ— ä»¥æˆå­¦ã€‚æ·«æ…¢åˆ™ä¸èƒ½åŠ±ç²¾ï¼Œé™©èºåˆ™ä¸èƒ½æ²»æ€§ã€‚å¹´ä¸æ—¶é©°ï¼Œæ„ä¸æ—¥å»ï¼Œé‚æˆæ¯è½ï¼Œå¤šä¸æ¥ä¸–ï¼Œæ‚²å®ˆç©·åºï¼Œå°†å¤ä½•åŠï¼</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯¸è‘›äº® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯¸è‘›äº® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åå‡ºå¸ˆè¡¨</title>
      <link href="2020/02/14/hou-chu-shi-biao/"/>
      <url>2020/02/14/hou-chu-shi-biao/</url>
      
        <content type="html"><![CDATA[<h3 id="åå‡ºå¸ˆè¡¨"><a href="#åå‡ºå¸ˆè¡¨" class="headerlink" title="åå‡ºå¸ˆè¡¨"></a>åå‡ºå¸ˆè¡¨</h3><p>å…ˆå¸æ·±è™‘æ±‰ã€è´¼ä¸ä¸¤ç«‹ï¼Œç‹ä¸šä¸åå®‰ï¼Œæ•…æ‰˜è‡£ä»¥è®¨è´¼ä¹Ÿã€‚ä»¥å…ˆå¸ä¹‹æ˜ï¼Œé‡è‡£ä¹‹æ‰ï¼Œå›ºçŸ¥è‡£ä¼è´¼ï¼Œæ‰å¼±æ•Œå¼ºä¹Ÿã€‚ç„¶ä¸ä¼è´¼ï¼Œç‹ä¸šäº¦äº¡ã€‚æƒŸåè€Œå¾…äº¡ï¼Œå­°ä¸ä¼ä¹‹ï¼Ÿæ˜¯æ•…æ‰˜è‡£è€Œå¼—ç–‘ä¹Ÿã€‚è‡£å—å‘½ä¹‹æ—¥ï¼Œå¯ä¸å®‰å¸­ï¼Œé£Ÿä¸ç”˜å‘³ã€‚æ€æƒŸåŒ—å¾ã€‚å®œå…ˆå…¥å—ã€‚æ•…äº”æœˆæ¸¡æ³¸ï¼Œæ·±å…¥ä¸æ¯›ï¼Œå¹¶æ—¥è€Œé£Ÿï¼›è‡£éä¸è‡ªæƒœä¹Ÿï¼Œé¡¾ç‹ä¸šä¸å¯å¾—åå®‰äºèœ€éƒ½ï¼Œæ•…å†’å±éš¾ï¼Œä»¥å¥‰å…ˆå¸ä¹‹é—æ„ä¹Ÿï¼Œè€Œè®®è€…è°“ä¸ºéè®¡ã€‚ä»Šè´¼é€‚ç–²äºè¥¿ï¼ŒåˆåŠ¡äºä¸œï¼Œå…µæ³•ä¹˜åŠ³ï¼Œæ­¤è¿›è¶‹ä¹‹æ—¶ä¹Ÿã€‚è°¨é™ˆå…¶äº‹å¦‚å·¦ï¼š</p><p>é«˜å¸æ˜å¹¶æ—¥æœˆï¼Œè°‹è‡£æ¸Šæ·±ï¼Œç„¶æ¶‰é™©è¢«åˆ›ï¼Œå±ç„¶åå®‰ã€‚ä»Šé™›ä¸‹æœªåŠé«˜å¸ï¼Œè°‹è‡£ä¸å¦‚è‰¯ã€å¹³ï¼Œè€Œæ¬²ä»¥é•¿ç­–å–èƒœï¼Œåå®šå¤©ä¸‹ï¼Œæ­¤è‡£ä¹‹æœªè§£ä¸€ä¹Ÿã€‚</p><p>åˆ˜ç¹‡ã€ç‹æœ—å„æ®å·éƒ¡ï¼Œè®ºå®‰è¨€è®¡ï¼ŒåŠ¨å¼•åœ£äººï¼Œç¾¤ç–‘æ»¡è…¹ï¼Œä¼—éš¾å¡èƒ¸ï¼Œä»Šå²ä¸æˆ˜ï¼Œæ˜å¹´ä¸å¾ï¼Œä½¿å­™ç­–åå¤§ï¼Œé‚å¹¶æ±Ÿä¸œï¼Œæ­¤è‡£ä¹‹æœªè§£äºŒä¹Ÿã€‚</p><p>æ›¹æ“æ™ºè®¡ï¼Œæ®Šç»äºäººï¼Œå…¶ç”¨å…µä¹Ÿï¼Œä»¿ä½›å­™ã€å´ï¼Œç„¶å›°äºå—é˜³ï¼Œé™©äºä¹Œå·¢ï¼Œå±äºç¥è¿ï¼Œé€¼äºé»é˜³ï¼Œå‡ è´¥åŒ—å±±ï¼Œæ®†æ­»æ½¼å…³ï¼Œç„¶åä¼ªå®šä¸€æ—¶è€³ã€‚å†µè‡£æ‰å¼±ï¼Œè€Œæ¬²ä»¥ä¸å±è€Œå®šä¹‹ï¼Œæ­¤è‡£ä¹‹æœªè§£ä¸‰ä¹Ÿã€‚æ›¹æ“äº”æ”»æ˜Œéœ¸ä¸ä¸‹ï¼Œå››è¶Šå·¢æ¹–ä¸æˆï¼Œä»»ç”¨ææœè€Œææœå›¾ä¹‹ï¼Œå§”ä»»å¤ä¾¯è€Œå¤ä¾¯è´¥äº¡ï¼Œå…ˆå¸æ¯ç§°æ“ä¸ºèƒ½ï¼ŒçŠ¹æœ‰æ­¤å¤±ï¼Œå†µè‡£é©½ä¸‹ï¼Œä½•èƒ½å¿…èƒœï¼Ÿæ­¤è‡£ä¹‹æœªè§£å››ä¹Ÿã€‚</p><p>è‡ªè‡£åˆ°æ±‰ä¸­ï¼Œä¸­é—´æœŸå¹´è€³ï¼Œç„¶ä¸§èµµäº‘ã€é˜³ç¾¤ã€é©¬ç‰ã€é˜èŠã€ä¸ç«‹ã€ç™½å¯¿ã€åˆ˜éƒƒã€é‚“é“œç­‰åŠæ›²é•¿ã€å±¯å°†ä¸ƒåä½™äººï¼Œçªå°†ã€æ— å‰ã€è³¨åŸã€é’ç¾Œã€æ•£éª‘ã€æ­¦éª‘ä¸€åƒä½™äººã€‚æ­¤çš†æ•°åå¹´ä¹‹å†…æ‰€çº åˆå››æ–¹ä¹‹ç²¾é”ï¼Œéä¸€å·ä¹‹æ‰€æœ‰ï¼›è‹¥å¤æ•°å¹´ï¼Œåˆ™æŸä¸‰åˆ†ä¹‹äºŒä¹Ÿï¼Œå½“ä½•ä»¥å›¾æ•Œï¼Ÿæ­¤è‡£ä¹‹æœªè§£äº”ä¹Ÿã€‚</p><p>ä»Šæ°‘ç©·å…µç–²ï¼Œè€Œäº‹ä¸å¯æ¯ï¼›äº‹ä¸å¯æ¯ï¼Œåˆ™ä½ä¸è¡ŒåŠ³è´¹æ­£ç­‰ã€‚è€Œä¸åŠä»Šå›¾ä¹‹ï¼Œæ¬²ä»¥ä¸€å·ä¹‹åœ°ï¼Œä¸è´¼æŒä¹…ï¼Œæ­¤è‡£ä¹‹æœªè§£å…­ä¹Ÿã€‚</p><p>å¤«éš¾å¹³è€…ï¼Œäº‹ä¹Ÿã€‚æ˜”å…ˆå¸è´¥å†›äºæ¥šï¼Œå½“æ­¤æ—¶ï¼Œæ›¹æ“æ‹Šæ‰‹ï¼Œè°“å¤©ä¸‹ä»¥å®šã€‚ç„¶åå…ˆå¸ä¸œè¿å´è¶Šï¼Œè¥¿å–å·´èœ€ï¼Œä¸¾å…µåŒ—å¾ï¼Œå¤ä¾¯æˆé¦–ï¼Œæ­¤æ“ä¹‹å¤±è®¡ï¼Œè€Œæ±‰äº‹å°†æˆä¹Ÿã€‚ç„¶åå´æ›´è¿ç›Ÿï¼Œå…³ç¾½æ¯è´¥ï¼Œç§­å½’è¹‰è·Œï¼Œæ›¹ä¸•ç§°å¸ã€‚å‡¡äº‹å¦‚æ˜¯ï¼Œéš¾å¯é€†è§ã€‚è‡£é èº¬å°½ç˜ï¼Œæ­»è€Œåå·²ã€‚è‡³äºæˆè´¥åˆ©é’ï¼Œéè‡£ä¹‹æ˜æ‰€èƒ½é€†ç¹ä¹Ÿã€‚</p><p>æ³¨ï¼šæ­¤è¡¨ï¼Œã€Šäº®é›†ã€‹æ‰€æ— ï¼Œå‡ºå¼ ä¿¨é»˜è®°ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯¸è‘›äº® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯¸è‘›äº® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡ºå¸ˆè¡¨</title>
      <link href="2020/02/14/chu-shi-biao/"/>
      <url>2020/02/14/chu-shi-biao/</url>
      
        <content type="html"><![CDATA[<h3 id="å‡ºå¸ˆè¡¨"><a href="#å‡ºå¸ˆè¡¨" class="headerlink" title="å‡ºå¸ˆè¡¨"></a>å‡ºå¸ˆè¡¨</h3><p>å…ˆå¸åˆ›ä¸šæœªåŠè€Œä¸­é“å´©æ®‚ï¼Œä»Šå¤©ä¸‹ä¸‰åˆ†ï¼Œç›Šå·ç–²å¼Šï¼Œæ­¤è¯šå±æ€¥å­˜äº¡ä¹‹ç§‹ä¹Ÿã€‚ç„¶ä¾å«ä¹‹è‡£ä¸æ‡ˆäºå†…ï¼Œå¿ å¿—ä¹‹å£«å¿˜èº«äºå¤–è€…ï¼Œç›–è¿½å…ˆå¸ä¹‹æ®Šé‡ï¼Œæ¬²æŠ¥ä¹‹äºé™›ä¸‹ä¹Ÿã€‚è¯šå®œå¼€å¼ åœ£å¬ï¼Œä»¥å…‰å…ˆå¸é—å¾·ï¼Œæ¢å¼˜å¿—å£«ä¹‹æ°”ï¼Œä¸å®œå¦„è‡ªè²è–„ï¼Œå¼•å–»å¤±ä¹‰ï¼Œä»¥å¡å¿ è°ä¹‹è·¯ä¹Ÿã€‚</p><p>å®«ä¸­åºœä¸­ï¼Œä¿±ä¸ºä¸€ä½“ï¼Œé™Ÿç½šè‡§å¦ï¼Œä¸å®œå¼‚åŒã€‚è‹¥æœ‰ä½œå¥¸çŠ¯ç§‘åŠä¸ºå¿ å–„è€…ï¼Œå®œä»˜æœ‰å¸è®ºå…¶åˆ‘èµï¼Œä»¥æ˜­é™›ä¸‹å¹³æ˜ä¹‹ç†ï¼Œä¸å®œåç§ï¼Œä½¿å†…å¤–å¼‚æ³•ä¹Ÿã€‚</p><p>ä¾ä¸­ã€ä¾éƒéƒ­æ”¸ä¹‹ã€è´¹ç¥ã€è‘£å…ç­‰ï¼Œæ­¤çš†è‰¯å®ï¼Œå¿—è™‘å¿ çº¯ï¼Œæ˜¯ä»¥å…ˆå¸ç®€æ‹”ä»¥é—é™›ä¸‹ã€‚æ„šä»¥ä¸ºå®«ä¸­ä¹‹äº‹ï¼Œäº‹æ— å¤§å°ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œç„¶åæ–½è¡Œï¼Œå¿…èƒ½è£¨è¡¥é˜™æ¼ï¼Œæœ‰æ‰€å¹¿ç›Šã€‚</p><p>å°†å†›å‘å® ï¼Œæ€§è¡Œæ·‘å‡ï¼Œæ™“ç•…å†›äº‹ï¼Œè¯•ç”¨äºæ˜”æ—¥ï¼Œå…ˆå¸ç§°ä¹‹æ›°èƒ½ï¼Œæ˜¯ä»¥ä¼—è®®ä¸¾å® ä¸ºç£ã€‚æ„šä»¥ä¸ºè¥ä¸­ä¹‹äº‹ï¼Œæ‚‰ä»¥å’¨ä¹‹ï¼Œå¿…èƒ½ä½¿è¡Œé˜µå’Œç¦ï¼Œä¼˜åŠ£å¾—æ‰€ã€‚</p><p>äº²è´¤è‡£ï¼Œè¿œå°äººï¼Œæ­¤å…ˆæ±‰æ‰€ä»¥å…´éš†ä¹Ÿï¼›äº²å°äººï¼Œè¿œè´¤è‡£ï¼Œæ­¤åæ±‰æ‰€ä»¥å€¾é¢“ä¹Ÿã€‚å…ˆå¸åœ¨æ—¶ï¼Œæ¯ä¸è‡£è®ºæ­¤äº‹ï¼Œæœªå°ä¸å¹æ¯ç—›æ¨äºæ¡“ã€çµä¹Ÿã€‚ä¾ä¸­ã€å°šä¹¦ã€é•¿å²ã€å‚å†›ï¼Œæ­¤æ‚‰è´è‰¯æ­»èŠ‚ä¹‹è‡£ï¼Œæ„¿é™›ä¸‹äº²ä¹‹ä¿¡ä¹‹ï¼Œåˆ™æ±‰å®¤ä¹‹éš†ï¼Œå¯è®¡æ—¥è€Œå¾…ä¹Ÿã€‚</p><p>è‡£æœ¬å¸ƒè¡£ï¼Œèº¬è€•äºå—é˜³ï¼Œè‹Ÿå…¨æ€§å‘½äºä¹±ä¸–ï¼Œä¸æ±‚é—»è¾¾äºè¯¸ä¾¯ã€‚å…ˆå¸ä¸ä»¥è‡£å‘é„™ï¼ŒçŒ¥è‡ªæ‰å±ˆï¼Œä¸‰é¡¾è‡£äºè‰åºä¹‹ä¸­ï¼Œå’¨è‡£ä»¥å½“ä¸–ä¹‹äº‹ï¼Œç”±æ˜¯æ„Ÿæ¿€ï¼Œé‚è®¸å…ˆå¸ä»¥é©±é©°ã€‚åå€¼å€¾è¦†ï¼Œå—ä»»äºè´¥å†›ä¹‹é™…ï¼Œå¥‰å‘½äºå±éš¾ä¹‹é—´ï¼Œå°”æ¥äºŒåæœ‰ä¸€å¹´çŸ£ã€‚</p><p>å…ˆå¸çŸ¥è‡£è°¨æ…ï¼Œæ•…ä¸´å´©å¯„è‡£ä»¥å¤§äº‹ä¹Ÿã€‚å—å‘½ä»¥æ¥ï¼Œå¤™å¤œå¿§å¹ï¼Œææ‰˜ä»˜ä¸æ•ˆï¼Œä»¥ä¼¤å…ˆå¸ä¹‹æ˜ï¼Œæ•…äº”æœˆæ¸¡æ³¸ï¼Œæ·±å…¥ä¸æ¯›ã€‚ä»Šå—æ–¹å·²å®šï¼Œå…µç”²å·²è¶³ï¼Œå½“å¥–ç‡ä¸‰å†›ï¼ŒåŒ—å®šä¸­åŸï¼Œåº¶ç«­é©½é’ï¼Œæ”˜é™¤å¥¸å‡¶ï¼Œå…´å¤æ±‰å®¤ï¼Œè¿˜äºæ—§éƒ½ã€‚æ­¤è‡£æ‰€ä»¥æŠ¥å…ˆå¸è€Œå¿ é™›ä¸‹ä¹‹èŒåˆ†ä¹Ÿã€‚è‡³äºæ–Ÿé…ŒæŸç›Šï¼Œè¿›å°½å¿ è¨€ï¼Œåˆ™æ”¸ä¹‹ã€ç¥ã€å…ä¹‹ä»»ä¹Ÿã€‚</p><p>æ„¿é™›ä¸‹æ‰˜è‡£ä»¥è®¨è´¼å…´å¤ä¹‹æ•ˆï¼Œä¸æ•ˆï¼Œåˆ™æ²»è‡£ä¹‹ç½ªï¼Œä»¥å‘Šå…ˆå¸ä¹‹çµã€‚è‹¥æ— å…´å¾·ä¹‹è¨€ï¼Œåˆ™è´£æ”¸ä¹‹ã€ç¥ã€å…ç­‰ä¹‹æ…¢ï¼Œä»¥å½°å…¶å’ï¼›é™›ä¸‹äº¦å®œè‡ªè°‹ï¼Œä»¥å’¨è¯¹å–„é“ï¼Œå¯Ÿçº³é›…è¨€ï¼Œæ·±è¿½å…ˆå¸é—è¯ï¼Œè‡£ä¸èƒœå—æ©æ„Ÿæ¿€ã€‚</p><p>ä»Šå½“è¿œç¦»ï¼Œä¸´è¡¨æ¶•é›¶ï¼Œä¸çŸ¥æ‰€è¨€</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯¸è‘›äº® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯¸è‘›äº® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Antlr4æ•™ç¨‹</title>
      <link href="2020/02/12/antlr4-jiao-cheng/"/>
      <url>2020/02/12/antlr4-jiao-cheng/</url>
      
        <content type="html"><![CDATA[<h2 id="Antlr4"><a href="#Antlr4" class="headerlink" title="Antlr4"></a>Antlr4</h2><h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h3><blockquote><p>Antlr (ANother Tool for Language Recognition) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„<code>è·¨è¯­è¨€</code>è¯­æ³•è§£æå™¨ï¼Œå¯ä»¥ç”¨æ¥è¯»å–ã€å¤„ç†ã€æ‰§è¡Œæˆ–ç¿»è¯‘ç»“æ„åŒ–æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®ƒè¢«å¹¿æ³›ç”¨æ¥æ„å»ºè¯­è¨€ï¼Œå·¥å…·å’Œæ¡†æ¶ã€‚Antlrå¯ä»¥ä»è¯­æ³•ä¸Šæ¥ç”Ÿæˆä¸€ä¸ªå¯ä»¥æ„å»ºå’Œéå†è§£ææ ‘çš„è§£æå™¨ã€‚</p></blockquote><h3 id="2-è°åœ¨ä½¿ç”¨"><a href="#2-è°åœ¨ä½¿ç”¨" class="headerlink" title="2. è°åœ¨ä½¿ç”¨"></a>2. è°åœ¨ä½¿ç”¨</h3><ol><li>Hive</li><li>Spark</li><li>Oracle</li><li>Presto</li><li>Elasticsearch</li></ol><h3 id="3-å¸¸è§çš„è¯­æ³•åˆ†æå™¨"><a href="#3-å¸¸è§çš„è¯­æ³•åˆ†æå™¨" class="headerlink" title="3. å¸¸è§çš„è¯­æ³•åˆ†æå™¨"></a>3. å¸¸è§çš„è¯­æ³•åˆ†æå™¨</h3><ol><li>Antlr</li><li>Javacc</li><li>SqlParser (ä½äº<code>Alibaba</code>çš„<code>Druid</code>åº“ä¸­)</li></ol><p>å…¶ä¸­<code>Antlr</code>å’Œ<code>Javacc</code>éƒ½æ˜¯ç°ä»£çš„è¯­æ³•è§£æå™¨ï¼Œä¸¤è€…éƒ½å¾ˆä¼˜ç§€ï¼Œå…¶ä¸­<code>Antlr</code>è¦æ›´èƒœä¸€ç­¹ã€‚è€Œ<code>SqlParser</code>åªèƒ½è§£æ<code>sql</code>è¯­å¥ï¼ŒåŠŸèƒ½æ¯”è¾ƒå•ä¸€ã€‚</p><p>ğŸ·ï¼šæœ¬äººåŸºäº<code>Antlr</code>å’Œ<code>SqlParser</code>åˆ†åˆ«å†™äº†ä¸€å¥—<code>elasticsearch-sql</code>ç»„ä»¶ï¼Œæœ‰éœ€è¦çš„äººå¯ä»¥çœ‹çœ‹æºç ã€‚</p><p><a href="http://github.com/iamazy/elasticsearch-sql" target="_blank" rel="noopener">åŸºäºAntlr4çš„elasticsearch-sql</a></p><p><a href="https://github.com/iamazy/elasticsearch-sql2" target="_blank" rel="noopener">åŸºäºSqlParserçš„elasticsearch-sql</a></p><h3 id="4-åŸºæœ¬æ¦‚å¿µ"><a href="#4-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="4. åŸºæœ¬æ¦‚å¿µ"></a>4. åŸºæœ¬æ¦‚å¿µ</h3><ol><li>æŠ½è±¡è¯­æ³•æ ‘ (Abstract Syntax Tree,AST)<br>æŠ½è±¡è¯­æ³•æ ‘æ˜¯æºä»£ç ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºï¼Œå®ƒä»¥æ ‘çš„å½¢çŠ¶è¡¨ç¤ºè¯­è¨€çš„è¯­æ³•ç»“æ„ã€‚æŠ½è±¡è¯­æ³•æ ‘ä¸€èˆ¬å¯ä»¥ç”¨æ¥è¿›è¡Œ<code>ä»£ç è¯­æ³•çš„æ£€æŸ¥</code>ï¼Œ<code>ä»£ç é£æ ¼çš„æ£€æŸ¥</code>ï¼Œ<code>ä»£ç çš„æ ¼å¼åŒ–</code>ï¼Œ<code>ä»£ç çš„é«˜äº®</code>ï¼Œ<code>ä»£ç çš„é”™è¯¯æç¤º</code>ä»¥åŠ<code>ä»£ç çš„è‡ªåŠ¨è¡¥å…¨</code>ç­‰ç­‰ã€‚</li><li>è¯­æ³•è§£æå™¨ (Parser)<br>è¯­æ³•è§£æå™¨é€šå¸¸ä½œä¸º<code>ç¼–è¯‘å™¨</code>æˆ–<code>è§£é‡Šå™¨</code>å‡ºç°ã€‚å®ƒçš„ä½œç”¨æ˜¯è¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œå¹¶æ„å»ºç”±è¾“å…¥å•è¯(<code>Token</code>)ç»„æˆçš„æ•°æ®ç»“æ„(å³æŠ½è±¡è¯­æ³•æ ‘)ã€‚è¯­æ³•è§£æå™¨é€šå¸¸ä½¿ç”¨<code>è¯æ³•åˆ†æå™¨(Lexer)</code>ä»è¾“å…¥å­—ç¬¦æµä¸­åˆ†ç¦»å‡ºä¸€ä¸ªä¸ªçš„å•è¯(<code>Token</code>)ï¼Œå¹¶å°†å•è¯(<code>Token</code>)æµä½œä¸ºå…¶è¾“å…¥ã€‚å®é™…å¼€å‘ä¸­ï¼Œè¯­æ³•è§£æå™¨å¯ä»¥æ‰‹å·¥ç¼–å†™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å·¥å…·è‡ªåŠ¨ç”Ÿæˆã€‚</li><li>è¯æ³•åˆ†æå™¨ (Lexer)<br><code>è¯æ³•åˆ†æ</code>æ˜¯æŒ‡åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå°†<code>å­—ç¬¦åºåˆ—</code>è½¬æ¢ä¸ºå•è¯(<code>Token</code>)çš„è¿‡ç¨‹ã€‚æ‰§è¡Œ<code>è¯æ³•åˆ†æ</code>çš„ç¨‹åºä¾¿ç§°ä¸ºè¯æ³•åˆ†æå™¨ã€‚<code>è¯æ³•åˆ†æå™¨(Lexer)</code>ä¸€èˆ¬æ˜¯ç”¨æ¥ä¾›<code>è¯­æ³•è§£æå™¨(Parser)</code>è°ƒç”¨çš„ã€‚</li></ol><h3 id="5-Antlr4ä½¿ç”¨æ–¹æ³•"><a href="#5-Antlr4ä½¿ç”¨æ–¹æ³•" class="headerlink" title="5. Antlr4ä½¿ç”¨æ–¹æ³•"></a>5. Antlr4ä½¿ç”¨æ–¹æ³•</h3><h4 id="1-å®‰è£…"><a href="#1-å®‰è£…" class="headerlink" title="(1). å®‰è£…"></a>(1). å®‰è£…</h4><pre class="line-numbers language-shell"><code class="language-shell">cd /usr/local/libwget</span> https://www.antlr.org/download/antlr-4.8-complete.jarexport CLASSPATH=".:/usr/local/lib/antlr-4.8-complete.jar:$CLASSPATH"antlr4='java -jar /usr/local/lib/antlr-4.8-complete.jar'grun='java org.antlr.v4.gui.TestRig'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯æœ¬æ–‡å¹¶ä¸ä½¿ç”¨è¿™ç§æ–¹å¼æ¥ä½¿ç”¨<code>Antlr4</code>ï¼Œè€Œæ˜¯ä½¿ç”¨æ’ä»¶çš„æ–¹å¼ã€‚</p><h4 id="2-å®‰è£…æ’ä»¶"><a href="#2-å®‰è£…æ’ä»¶" class="headerlink" title="(2). å®‰è£…æ’ä»¶"></a>(2). å®‰è£…æ’ä»¶</h4><p>æœ¬æ–‡ä½¿ç”¨IDEAä½œä¸ºå¼€å‘å·¥å…·ï¼Œåœ¨Preference-&gt;Pluginsä¸­æœç´¢<code>antlr</code>ç„¶åå®‰è£…å³å¯ã€‚</p><h4 id="3-å®šä¹‰DSLè¯­æ³•"><a href="#3-å®šä¹‰DSLè¯­æ³•" class="headerlink" title="(3). å®šä¹‰DSLè¯­æ³•"></a>(3). å®šä¹‰DSLè¯­æ³•</h4><p>æœ¬æ–‡å°†ä½¿ç”¨<code>Antlr4</code>å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„<code>Elasticsearch</code>çš„æŸ¥è¯¢è¯­æ³•ï¼Œä»£æ›¿<code>Elasticsearch</code>çš„<code>dsl</code>ã€‚</p><p><strong>æœç´¢è¯­æ³•å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><blockquote><p>å•ä¸ªæŸ¥è¯¢ï¼š<code>field</code>:<code>value</code>ï¼Œå…¶ä¸­å†’å·<code>:</code>å’Œç­‰äºå·<code>=</code>è¡¨ç¤ºç­‰äºï¼Œ<code>!=</code>è¡¨ç¤ºä¸ç­‰äº<br>å¤šä¸ªæŸ¥è¯¢ï¼š<code>field1</code>:<code>value1</code>,<code>field2</code>:<code>value2</code>ï¼Œä½¿ç”¨é€—å·<code>,</code>æˆ–è€…<code>&amp;&amp;</code>è¡¨ç¤º<code>ä¸”</code>çš„å…³ç³»ï¼Œä½¿ç”¨<code>||</code>è¡¨ç¤º<code>æˆ–</code>çš„å…³ç³»<br>æ‹¬å·ï¼šå¯ä»¥ä½¿ç”¨æ‹¬å·<code>()</code>å°†å¤šä¸ªæ¡ä»¶æ‰©èµ·æ¥</p></blockquote><p><strong>ç¤ºä¾‹ï¼š</strong></p><blockquote><p>country:ä¸­å›½,province:æ¹–å—,city:å¼ å®¶ç•Œ</p></blockquote><p><strong>ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘å¦‚ä¸‹æ‰€ç¤º:</strong><br><img src="/2020/02/12/antlr4-jiao-cheng/ast1.png" alt="æœç´¢è¯­æ³•çš„æŠ½è±¡è¯­æ³•æ ‘"></p><p><strong>èšç±»è¯­æ³•å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><blockquote><p>æ¡¶èšç±»(terms)ï¼š<code>field</code><br>å»é‡å€¼è®¡æ•°(cardinality)ï¼š(<code>field</code>)<br>æ¡¶èšç±»åˆ†é¡µ(composite)ï¼š<code>field</code> after <code>value</code><br>åœ°ç†è¾¹æ¡†èšç±»(geoBoundingBox)ï¼š[<code>field</code>]<br>æ¡¶èšç±»åµŒå¥—å­èšç±»(subAgg)ï¼š<code>field1</code>&gt;<code>field2</code>&gt;<code>field3</code><br>å¤šä¸ªèšç±»æ¡ä»¶ç”¨åˆ†å·<code>;</code>éš”å¼€</p></blockquote><p><strong>ç¤ºä¾‹ï¼š</strong></p><blockquote><p>country;(country);country&gt;province&gt;city;province after æ¹–å—</p></blockquote><p><strong>ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘å¦‚ä¸‹æ‰€ç¤º:</strong><br><img src="/2020/02/12/antlr4-jiao-cheng/ast2.png" alt="èšç±»è¯­æ³•çš„æŠ½è±¡è¯­æ³•æ ‘"></p><h4 id="4-ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶"><a href="#4-ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶" class="headerlink" title="(4). ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶"></a>(4). ç¼–å†™Antlr4è¯­æ³•æ–‡ä»¶</h4><blockquote><p>åˆ›å»ºSearchLexer.g4æ–‡ä»¶ï¼Œå®šä¹‰è¯æ³•åˆ†æå™¨çš„Token</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// è¡¨æ˜SearchLexer.g4æ–‡ä»¶æ˜¯è¯æ³•åˆ†æå™¨(lexer)å®šä¹‰æ–‡ä»¶</span><span class="token comment" spellcheck="true">// è¯æ³•åˆ†æå™¨çš„åç§°ä¸€å®šè¦å’Œæ–‡ä»¶åä¿æŒä¸€è‡´</span>lexer grammar SearchLexer<span class="token punctuation">;</span>channels <span class="token punctuation">{</span>    ESQLCOMMENT<span class="token punctuation">,</span>    ERRORCHANNEL<span class="token punctuation">}</span><span class="token comment" spellcheck="true">//SKIP å½“Antlrè§£æåˆ°ä¸‹é¢çš„ä»£ç æ—¶ï¼Œä¼šé€‰æ‹©è·³è¿‡</span><span class="token comment" spellcheck="true">// é‡åˆ° \t\r\n ä¼šå¿½ç•¥</span>SPACE<span class="token punctuation">:</span> <span class="token punctuation">[</span> \t\r\n<span class="token punctuation">]</span><span class="token operator">+</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>HIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// é‡åˆ° </span><span class="token comment" spellcheck="true">/*!  */</span> ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡SPEC_ESSQL_COMMENT<span class="token punctuation">:</span> <span class="token string">'/*!'</span> <span class="token punctuation">.</span><span class="token operator">+</span><span class="token operator">?</span> <span class="token string">'*/'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>ESQLCOMMENT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// é‡åˆ° </span><span class="token comment" spellcheck="true">/* */</span> ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡COMMENT_INPUT<span class="token punctuation">:</span> <span class="token string">'/*'</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">?</span> <span class="token string">'*/'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>HIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// é‡åˆ° -- ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡</span><span class="token comment" spellcheck="true">// é‡åˆ° # ä¼šå½“ä½œæ³¨é‡Šè·³è¿‡</span>LINE_COMMENT<span class="token punctuation">:</span> <span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token string">'-- '</span> <span class="token operator">|</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>\r\n<span class="token punctuation">]</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token operator">?</span> <span class="token string">'\n'</span> <span class="token operator">|</span> EOF<span class="token punctuation">)</span>        <span class="token operator">|</span> <span class="token string">'--'</span> <span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token operator">?</span> <span class="token string">'\n'</span> <span class="token operator">|</span> EOF<span class="token punctuation">)</span>    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">channel</span><span class="token punctuation">(</span>HIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å®šä¹‰Tokenï¼Œæ¨¡å¼ä¸º {field}:{value}</span>MINUS<span class="token punctuation">:</span> <span class="token string">'-'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//ä½¿MINUSå’Œ-ç­‰ä»·ï¼Œä»¥ä¸‹åŒç†</span>STAR<span class="token punctuation">:</span> <span class="token string">'*'</span><span class="token punctuation">;</span>COLON<span class="token punctuation">:</span> <span class="token string">':'</span><span class="token operator">|</span><span class="token string">'\uFF1A'</span><span class="token punctuation">;</span>EQ<span class="token punctuation">:</span> <span class="token string">'='</span><span class="token punctuation">;</span>NE<span class="token punctuation">:</span> <span class="token string">'!='</span><span class="token punctuation">;</span>BOOLOR<span class="token punctuation">:</span> <span class="token string">'||'</span><span class="token operator">|</span><span class="token string">'|'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ä½¿BOOLORä¸||æˆ–è€…|ç­‰ä»·</span>BOOLAND<span class="token punctuation">:</span> <span class="token string">'&amp;&amp;'</span><span class="token operator">|</span>COMMA<span class="token operator">|</span><span class="token string">'&amp;'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//CONSTRUCTORS</span>DOT<span class="token punctuation">:</span> <span class="token string">'.'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">mode</span><span class="token punctuation">(</span>AFTER_DOT<span class="token punctuation">)</span><span class="token punctuation">;</span>LBRACKET<span class="token punctuation">:</span> <span class="token string">'['</span><span class="token punctuation">;</span>RBRACKET<span class="token punctuation">:</span> <span class="token string">']'</span><span class="token punctuation">;</span>LPAREN<span class="token punctuation">:</span> <span class="token string">'('</span><span class="token punctuation">;</span>RPAREN<span class="token punctuation">:</span> <span class="token string">')'</span><span class="token punctuation">;</span>COMMA<span class="token punctuation">:</span> <span class="token string">','</span><span class="token operator">|</span><span class="token string">'\uFF0C'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ä½¿COMMAä¸,æˆ–ï¼Œç­‰ä»·(\uFF0Cè¡¨ç¤ºï¼Œçš„unicodeç¼–ç )</span>SEMI<span class="token punctuation">:</span> <span class="token string">';'</span><span class="token punctuation">;</span>GT<span class="token punctuation">:</span> <span class="token string">'>'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è¿™é‡Œå’Œä»¥ä¸‹ä»£ç ç­‰ä»·</span><span class="token comment" spellcheck="true">// AFTER: 'after'  ä½†æ˜¯è¿™ç§ä»£ç åªèƒ½è¡¨ç¤ºå°å†™çš„afterï¼Œæ˜¯å¤§å°å†™åŒºåˆ†çš„ï¼Œè¿™æ ·ä¸å¥½</span><span class="token comment" spellcheck="true">// é€šè¿‡ä¸‹é¢å®šä¹‰çš„fragmentï¼Œå°†AFTERç”¨A F T E Rè¡¨ç¤ºï¼Œä¸€å®šè¦æ¯ä¸ªå­—æ¯ç©ºä¸€æ ¼ï¼Œå°±å¯ä»¥ä¸åŒºåˆ†å¤§å°å†™äº†</span><span class="token comment" spellcheck="true">// æ‰€æœ‰è¯­æ³•çš„å…³é”®å­—éƒ½å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼å£°æ˜</span>AFTER<span class="token punctuation">:</span> A F T E R<span class="token punctuation">;</span>SINGLE_QUOTE<span class="token punctuation">:</span> <span class="token string">'\''</span><span class="token punctuation">;</span>DOUBLE_QUOTE<span class="token punctuation">:</span> <span class="token string">'"'</span><span class="token punctuation">;</span>REVERSE_QUOTE<span class="token punctuation">:</span> <span class="token string">'`'</span><span class="token punctuation">;</span>UNDERLINE<span class="token punctuation">:</span> <span class="token string">'_'</span><span class="token punctuation">;</span>CHINESE<span class="token punctuation">:</span> <span class="token string">'\u4E00'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">'\u9FA5'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//è¡¨ç¤ºæ‰€æœ‰ä¸­æ–‡çš„unicodeç¼–ç ï¼Œä»¥æ”¯æŒä¸­æ–‡</span>ID<span class="token punctuation">:</span> <span class="token punctuation">(</span>CHINESE<span class="token operator">|</span>ID_LETTER<span class="token operator">|</span>DOT<span class="token operator">|</span>MINUS<span class="token operator">|</span>UNDERLINE<span class="token operator">|</span>INT<span class="token operator">|</span>FLOAT<span class="token operator">|</span>REVERSE_QUOTE<span class="token operator">|</span>DOUBLE_QUOTE<span class="token operator">|</span>SINGLE_QUOTE<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ? è¡¨ç¤ºå¯æœ‰å¯æ— </span><span class="token comment" spellcheck="true">// + è¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ª</span><span class="token comment" spellcheck="true">// | è¡¨ç¤ºæˆ–çš„å…³ç³»</span><span class="token comment" spellcheck="true">// * è¡¨ç¤ºæœ‰0æˆ–è€…å¤šä¸ª</span>INT<span class="token punctuation">:</span> MINUS<span class="token operator">?</span> DEC_DIGIT<span class="token operator">+</span><span class="token punctuation">;</span>FLOAT<span class="token punctuation">:</span> <span class="token punctuation">(</span>MINUS<span class="token operator">?</span> DEC_DIGIT<span class="token operator">+</span> DOT DEC_DIGIT<span class="token operator">+</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token punctuation">(</span>MINUS<span class="token operator">?</span> DOT DEC_DIGIT<span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ä½¿ç”¨DEC_DIGITä»£è¡¨0åˆ°9ä¹‹é—´çš„æ•°å­—</span>fragment DEC_DIGIT<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä½¿ç”¨ID_LETTERä»£è¡¨a-zçš„å¤§å†™å°å†™å­—æ¯å’Œ_</span>fragment ID_LETTER<span class="token punctuation">:</span> <span class="token punctuation">[</span>a<span class="token operator">-</span>zA<span class="token operator">-</span>Z<span class="token punctuation">]</span><span class="token operator">|</span> UNDERLINE<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è¡¨ç¤ºç”¨Aä»£è¡¨aå’ŒAï¼Œè¿™æ ·å°±å¯ä»¥ä¸åŒºåˆ†å¤§å°å†™äº†ï¼Œä»¥ä¸‹åŒç†</span>fragment A<span class="token punctuation">:</span> <span class="token punctuation">[</span>aA<span class="token punctuation">]</span><span class="token punctuation">;</span> fragment B<span class="token punctuation">:</span> <span class="token punctuation">[</span>bB<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment C<span class="token punctuation">:</span> <span class="token punctuation">[</span>cC<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment D<span class="token punctuation">:</span> <span class="token punctuation">[</span>dD<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment E<span class="token punctuation">:</span> <span class="token punctuation">[</span>eE<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment F<span class="token punctuation">:</span> <span class="token punctuation">[</span>fF<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment G<span class="token punctuation">:</span> <span class="token punctuation">[</span>gG<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment H<span class="token punctuation">:</span> <span class="token punctuation">[</span>hH<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment I<span class="token punctuation">:</span> <span class="token punctuation">[</span>iI<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment J<span class="token punctuation">:</span> <span class="token punctuation">[</span>jJ<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment K<span class="token punctuation">:</span> <span class="token punctuation">[</span>kK<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment L<span class="token punctuation">:</span> <span class="token punctuation">[</span>lL<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment M<span class="token punctuation">:</span> <span class="token punctuation">[</span>mM<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment N<span class="token punctuation">:</span> <span class="token punctuation">[</span>nN<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment O<span class="token punctuation">:</span> <span class="token punctuation">[</span>oO<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment P<span class="token punctuation">:</span> <span class="token punctuation">[</span>pP<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment Q<span class="token punctuation">:</span> <span class="token punctuation">[</span>qQ<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment R<span class="token punctuation">:</span> <span class="token punctuation">[</span>rR<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment S<span class="token punctuation">:</span> <span class="token punctuation">[</span>sS<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment T<span class="token punctuation">:</span> <span class="token punctuation">[</span>tT<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment U<span class="token punctuation">:</span> <span class="token punctuation">[</span>uU<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment V<span class="token punctuation">:</span> <span class="token punctuation">[</span>vV<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment W<span class="token punctuation">:</span> <span class="token punctuation">[</span>wW<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment X<span class="token punctuation">:</span> <span class="token punctuation">[</span>xX<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment Y<span class="token punctuation">:</span> <span class="token punctuation">[</span>yY<span class="token punctuation">]</span><span class="token punctuation">;</span>fragment Z<span class="token punctuation">:</span> <span class="token punctuation">[</span>zZ<span class="token punctuation">]</span><span class="token punctuation">;</span>mode AFTER_DOT<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//DEFAULT_MODEæ˜¯Antlrä¸­é»˜è®¤å®šä¹‰å¥½çš„mode</span>DOTINTEGER<span class="token punctuation">:</span> <span class="token punctuation">(</span> <span class="token string">'0'</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">mode</span><span class="token punctuation">(</span>DEFAULT_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>DOTID<span class="token punctuation">:</span> <span class="token punctuation">[</span>_a<span class="token operator">-</span>zA<span class="token operator">-</span>Z<span class="token punctuation">]</span> <span class="token punctuation">[</span>_a<span class="token operator">-</span>zA<span class="token operator">-</span>Z0<span class="token number">-9</span><span class="token punctuation">]</span><span class="token operator">*</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">mode</span><span class="token punctuation">(</span>DEFAULT_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åˆ›å»ºSearchParser.g4æ–‡ä»¶ï¼Œå®šä¹‰è¯­æ³•è§£æå™¨çš„æœç´¢è¯­æ³•</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// è¡¨æ˜SearchParser.g4æ–‡ä»¶æ˜¯è¯­æ³•è§£æå™¨(parser)å®šä¹‰æ–‡ä»¶</span><span class="token comment" spellcheck="true">// åŒç†ï¼Œè¯­æ³•åˆ†æå™¨çš„åç§°ä¸€å®šè¦å’Œæ–‡ä»¶åä¿æŒä¸€è‡´</span>parser grammar SearchParser<span class="token punctuation">;</span>options <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è¡¨ç¤ºè§£ætokençš„è¯æ³•è§£æå™¨ä½¿ç”¨SearchLexer</span>    tokenVocab <span class="token operator">=</span> SearchLexer<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// EOF(end of file)è¡¨ç¤ºæ–‡ä»¶ç»“æŸç¬¦ï¼Œè¿™ä¸ªæ˜¯Antlrä¸­å·²ç»å®šä¹‰å¥½çš„</span>prog<span class="token punctuation">:</span> expression <span class="token operator">|</span> STAR EOF<span class="token punctuation">;</span>expression<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">// è¡¨ç¤ºè¡¨è¾¾å¼å¯ä»¥è¢«æ‹¬å·æ‹¬èµ·æ¥</span>    <span class="token comment" spellcheck="true">// å¦‚æœè¯­æ³•åé¢åŠ ä¸Šäº†#{name}ï¼Œç›¸å½“äºå°†è¿™ä¸ªnameä½œä¸ºè¿™ä¸ªè¯­æ³•å—çš„åå­—ï¼Œè¿™ä¸ª#{name}è¦åŠ éƒ½å¾—åŠ ä¸Šï¼Œè¦ä¸åŠ éƒ½ä¸åŠ </span>    <span class="token comment" spellcheck="true">// (country:ä¸­å›½)</span>    LPAREN expression RPAREN                                                            #lrExpr    <span class="token comment" spellcheck="true">// leftExpræ˜¯ç»™å®šä¹‰çš„è¯­æ³•èµ·çš„åˆ«å(alias)ï¼Œå¯æœ‰å¯æ— ï¼Œä½†æ˜¯æœ‰ä¼šæ›´å¥½ç‚¹</span>    <span class="token comment" spellcheck="true">// å› ä¸ºantlrè§£æåŒä¸€è¯­æ³•å—çš„åŒä¸€ç±»tokenæ—¶ï¼Œä¼šå°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªlisté‡Œé¢</span>    <span class="token comment" spellcheck="true">// æ¯”å¦‚ä¸‹é¢çš„è¯­æ³•å—ï¼Œæœ‰ä¸¤ä¸ªexpressionï¼Œantlrä¼šå°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨expressionsé‡Œ</span>    <span class="token comment" spellcheck="true">// è·å–ç¬¬ä¸€ä¸ªexpressionæ—¶éœ€è¦expressions.get(0)ï¼Œè·å–ç¬¬äºŒä¸ªexpressionæ—¶éœ€è¦expressions.get(1)</span>    <span class="token comment" spellcheck="true">// å¦‚æœç»™ç¬¬ä¸€ä¸ªexpressionèµ·äº†ä¸ªåˆ«åå«leftExprï¼Œç»™ç¬¬äºŒä¸ªexpressionèµ·äº†ä¸ªåˆ«åå«rightExpr</span>    <span class="token comment" spellcheck="true">// é‚£æ ·åœ¨javaé‡Œé¢è°ƒç”¨æ—¶å°±å¯ä»¥ç›´æ¥è°ƒç”¨leftExprå’ŒrightExprï¼Œè€Œä¸éœ€è¦æŒ‡å®šexpressionsä¸­çš„ç´¢å¼•(0æˆ–1)</span>    <span class="token comment" spellcheck="true">// è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå¦‚æœä¹‹åæ·»åŠ äº†æ–°çš„tokenï¼Œæ¯”å¦‚åœ¨ä¸‹é¢è¯­æ³•ä¸­é—´æ·»åŠ ä¸€ä¸ªexpressionçš„token</span>    <span class="token comment" spellcheck="true">// è¿™æ—¶å¦‚æœä¸ä½¿ç”¨åˆ«åleftExprï¼ŒrightExprå°±å¯èƒ½éœ€è¦ä¿®æ”¹javaä»£ç ï¼Œå› ä¸ºåŸæ¥rightExprå¯¹åº”çš„expressionåœ¨expressionsä¸­ç´¢å¼•å˜ä¸º2äº†</span>    <span class="token comment" spellcheck="true">// ä½¿ç”¨åˆ«åleftExprï¼ŒrightExpr(å½“ç„¶è¿˜å¯ä»¥å–åˆ«çš„åå­—)å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œä½¿è¯­æ³•æ–‡ä»¶å’Œç”Ÿæˆçš„javaä»£ç æ›´ä¾¿äºç»´æŠ¤</span>    <span class="token comment" spellcheck="true">// country:ä¸­å›½</span>    <span class="token operator">|</span> leftExpr <span class="token operator">=</span> expression operator <span class="token operator">=</span> <span class="token punctuation">(</span>EQ <span class="token operator">|</span>COLON<span class="token operator">|</span> NE <span class="token punctuation">)</span> rightExpr <span class="token operator">=</span> expression            #eqExpr    <span class="token comment" spellcheck="true">// (country:ä¸­å›½||country:ç¾å›½)&amp;&amp;city:åŒ—äº¬</span>    <span class="token operator">|</span> leftExpr <span class="token operator">=</span> expression operator <span class="token operator">=</span> <span class="token punctuation">(</span>BOOLAND<span class="token operator">|</span>BOOLOR<span class="token punctuation">)</span> rightExpr <span class="token operator">=</span> expression            #boolExpr    <span class="token comment" spellcheck="true">// countryç­‰å­—é¢é‡</span>    <span class="token operator">|</span> ID                                                                                #identityExpr<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>åˆ›å»ºAggregateParser.g4æ–‡ä»¶ï¼Œå®šä¹‰è¯­æ³•è§£æå™¨çš„èšç±»è¯­æ³•</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript">parser grammar AggregateParser<span class="token punctuation">;</span>options <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// èšç±»çš„è¯­æ³•åˆ†æå™¨ä¹Ÿå¯ä»¥ä½¿ç”¨SearchLexer</span>    tokenVocab <span class="token operator">=</span> SearchLexer<span class="token punctuation">;</span><span class="token punctuation">}</span>expr<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">// å¤šä¸ªèšç±»æ¡ä»¶ç”¨åˆ†å·éš”å¼€</span>    aggClause <span class="token punctuation">(</span>SEMI aggClause<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// aggClauseè¡¨ç¤ºä»£è¡¨ä»¥ä¸‹èšç±»çš„ä»»æ„ä¸€ç§</span>aggClause<span class="token punctuation">:</span>    cardinalityAggClause<span class="token operator">|</span>termsAggClause<span class="token operator">|</span>termsAfterAggClause<span class="token operator">|</span>geoBoundingBoxAggClause<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å»é‡å€¼è®¡æ•° -> (country)</span>cardinalityAggClause<span class="token punctuation">:</span>    LPAREN ID RPAREN<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ¡¶èšç±»åˆ†é¡µ -> province after æ¹–å—</span>termsAfterAggClause<span class="token punctuation">:</span>    field <span class="token operator">=</span> ID AFTER after<span class="token operator">=</span>ID<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ¡¶èšç±»åµŒå¥—å­èšç±» -> country>province>city</span>termsAggClause<span class="token punctuation">:</span>    field <span class="token operator">=</span> ID <span class="token punctuation">(</span>GT termsAggClause<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// åœ°ç†è¾¹æ¡†èšç±» -> [coordinate]</span>geoBoundingBoxAggClause<span class="token punctuation">:</span>    LBRACKET ID RBRACKET<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5-ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶"><a href="#5-ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶" class="headerlink" title="(5). ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶"></a>(5). ä½¿ç”¨Antlr4è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡ä»¶</h4><blockquote><p>åœ¨IDEAä¸­ï¼Œåœ¨<code>SearchParser.g4</code>ï¼Œ<code>AggregateParser.g4</code>æ–‡ä»¶å³é”®é€‰æ‹©<code>Configure ANTLR...</code>ï¼Œé…ç½®æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä»£ç çš„é…ç½®å’Œè¾“å‡ºç›®å½•</p></blockquote><p><img src="/2020/02/12/antlr4-jiao-cheng/configure-antlr.png" alt="antlré…ç½®é¡¹"></p><blockquote><p>ç„¶ååœ¨<code>SearchParser.g4</code>ï¼Œ<code>AggregateParser.g4</code>æ–‡ä»¶å³é”®é€‰æ‹©<code>Generate ANTLR Recognizer</code>ç”Ÿæˆä»£ç æ–‡ä»¶ã€‚ç”Ÿæˆçš„ä»£ç ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">|</span><span class="token operator">--</span> io    <span class="token operator">|</span><span class="token operator">--</span> github        <span class="token operator">|</span><span class="token operator">--</span> iamazy            <span class="token operator">|</span><span class="token operator">--</span> elasticsearch                <span class="token operator">|</span><span class="token operator">--</span> dsl                    <span class="token operator">|</span><span class="token operator">--</span> antlr4                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParser<span class="token punctuation">.</span>interp                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParser<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParser<span class="token punctuation">.</span>tokens                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserBaseListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserBaseVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateParserVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> AggregateWalker<span class="token punctuation">.</span>java          <span class="token comment" spellcheck="true">//è¿™æ˜¯è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¸æ˜¯antlrè‡ªåŠ¨ç”Ÿæˆçš„</span>                        <span class="token operator">|</span><span class="token operator">--</span> QueryParser<span class="token punctuation">.</span>java              <span class="token comment" spellcheck="true">//è¿™æ˜¯è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¸æ˜¯antlrè‡ªåŠ¨ç”Ÿæˆçš„</span>                        <span class="token operator">|</span><span class="token operator">--</span> SearchLexer<span class="token punctuation">.</span>interp                        <span class="token operator">|</span><span class="token operator">--</span> SearchLexer<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchLexer<span class="token punctuation">.</span>tokens                        <span class="token operator">|</span><span class="token operator">--</span> SearchParser<span class="token punctuation">.</span>interp                        <span class="token operator">|</span><span class="token operator">--</span> SearchParser<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParser<span class="token punctuation">.</span>tokens                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserBaseListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserBaseVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserListener<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchParserVisitor<span class="token punctuation">.</span>java                        <span class="token operator">|</span><span class="token operator">--</span> SearchWalker<span class="token punctuation">.</span>java             <span class="token comment" spellcheck="true">//è¿™æ˜¯è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ï¼Œä¸æ˜¯antlrè‡ªåŠ¨ç”Ÿæˆçš„</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="6-éå†æŠ½è±¡è¯­æ³•æ ‘"><a href="#6-éå†æŠ½è±¡è¯­æ³•æ ‘" class="headerlink" title="(6). éå†æŠ½è±¡è¯­æ³•æ ‘"></a>(6). éå†æŠ½è±¡è¯­æ³•æ ‘</h4><blockquote><p>è¿™é‡Œæˆ‘ä»¬ä¸å®ç°<code>Antlr</code>ç”Ÿæˆå¥½çš„<code>Listener</code>æˆ–<code>Visitor</code>éå†æŠ½è±¡è¯­æ³•æ ‘çš„æ¥å£ï¼Œè€Œæ˜¯è‡ªå·±å†™ä»£ç éå†æŠ½è±¡è¯­æ³•æ ‘</p></blockquote><p>åœ¨<code>io.github.iamazy.elasticsearch.dsl.antlr4</code>åŒ…ä¸‹åˆ›å»ºJavaç±»<code>SearchWalker</code>ï¼Œ<code>AggregateWalker</code>ï¼Œ<code>QueryParser</code>ã€‚</p><blockquote><p><code>SearchWalker</code>ç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>antlr4<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStreams<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CommonTokenStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @descrition ç”Ÿæˆéå†æœç´¢æ¡ä»¶çš„æŠ½è±¡è¯­æ³•æ ‘çš„éå†å™¨ **/</span><span class="token keyword">class</span> <span class="token class-name">SearchWalker</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String expression<span class="token punctuation">;</span>    <span class="token function">SearchWalker</span><span class="token punctuation">(</span>String expression<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token operator">=</span>expression<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    SearchParser <span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æœç´¢è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        CharStream stream<span class="token operator">=</span> CharStreams<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>        SearchLexer lexer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SearchLexer</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommonTokenStream</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>AggregateWalker</code>ç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>antlr4<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CharStreams<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>antlr<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>CommonTokenStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @descrition ç”Ÿæˆéå†èšç±»æ¡ä»¶çš„æŠ½è±¡è¯­æ³•æ ‘çš„éå†å™¨ **/</span><span class="token keyword">class</span> <span class="token class-name">AggregateWalker</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String expression<span class="token punctuation">;</span>    <span class="token function">AggregateWalker</span><span class="token punctuation">(</span>String expression<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token operator">=</span>expression<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    AggregateParser <span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æœç´¢è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        CharStream stream<span class="token operator">=</span> CharStreams<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>        SearchLexer lexer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SearchLexer</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AggregateParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommonTokenStream</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>QueryParser</code>ç±»æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>iamazy<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>antlr4<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span>BoolQueryBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QueryBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QueryBuilders<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>AggregationBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>AggregationBuilders<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>composite<span class="token punctuation">.</span>CompositeAggregationBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>composite<span class="token punctuation">.</span>CompositeValuesSourceBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>composite<span class="token punctuation">.</span>TermsValuesSourceBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @descrition éå†æœç´¢æ¡ä»¶å’Œèšç±»æ¡ä»¶çš„æŠ½è±¡è¯­æ³•æ ‘ **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryParser</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> QueryBuilder <span class="token function">parse</span><span class="token punctuation">(</span>String expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼ä¸º*ï¼Œåˆ™è¿”å›å…¨éƒ¨æ•°æ®</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆéå†æ ‘çš„å®ä¾‹</span>        SearchWalker walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchWalker</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è°ƒç”¨æ–¹æ³•ï¼Œéå†è¡¨è¾¾å¼</span>        SearchParser searchParser <span class="token operator">=</span> walker<span class="token punctuation">.</span><span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†æœç´¢è¡¨è¾¾å¼è½¬æ¢ä¸ºæŸ¥è¯¢elasticsearchçš„querybuilder</span>        <span class="token keyword">return</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>searchParser<span class="token punctuation">.</span><span class="token function">prog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> QueryBuilder <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>ExpressionContext expressionContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼æ˜¯è¢«æ‹¬å·åŒ…å«çš„è¯ï¼Œè°ƒç”¨parseLrExprContext</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionContext <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>LrExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">parseLrExprContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>LrExprContext<span class="token punctuation">)</span> expressionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼æ˜¯æ¡ä»¶è¡¨è¾¾å¼åŒ…å«ä¸æˆ–éçš„è¯ï¼Œè°ƒç”¨parseBoolExprContext</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionContext <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>BoolExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">parseBoolExprContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>BoolExprContext<span class="token punctuation">)</span> expressionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼æ˜¯ç­‰å¼çš„è¯ï¼Œè°ƒç”¨parseEqExprContext</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionContext <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>EqExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">parseEqExprContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>EqExprContext<span class="token punctuation">)</span> expressionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸æ”¯æŒè¯¥æŸ¥è¯¢è¯­æ³•!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£ææ‹¬å·ä¸­çš„è¡¨è¾¾å¼</span>    <span class="token keyword">private</span> QueryBuilder <span class="token function">parseLrExprContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>LrExprContext lrExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        SearchParser<span class="token punctuation">.</span>ExpressionContext expression <span class="token operator">=</span> lrExprContext<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> BoolQueryBuilder <span class="token function">parseBoolExprContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>BoolExprContext boolExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//è§£ææ¡ä»¶è¡¨è¾¾å¼çš„å·¦åŠè¾¹è¡¨è¾¾å¼</span>        SearchParser<span class="token punctuation">.</span>ExpressionContext leftExpr <span class="token operator">=</span> boolExprContext<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è§£ææ¡ä»¶è¡¨è¾¾å¼çš„å³åŠè¾¹è¡¨è¾¾å¼</span>        SearchParser<span class="token punctuation">.</span>ExpressionContext rightExpr <span class="token operator">=</span> boolExprContext<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†å·¦åŠè¾¹è¡¨è¾¾å¼è½¬æ¢æˆquerybuilder</span>        QueryBuilder leftQuery <span class="token operator">=</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>leftExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†å³åŠè¾¹è¡¨è¾¾å¼è½¬æ¢ä¸ºquerybuilder</span>        QueryBuilder rightQuery <span class="token operator">=</span> <span class="token function">parseExpressionContext</span><span class="token punctuation">(</span>rightExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼è¡¨ç¤ºçš„æ˜¯ä¸”çš„å…³ç³»</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>boolExprContext<span class="token punctuation">.</span><span class="token function">BOOLAND</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>leftQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>rightQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦‚æœè¡¨è¾¾å¼è¡¨ç¤ºçš„æ˜¯æˆ–çš„å…³ç³»</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>leftQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>rightQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> QueryBuilder <span class="token function">parseEqExprContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>EqExprContext eqExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String field<span class="token punctuation">,</span> value<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å¦‚æœå·¦åŠè¾¹çš„å­—æ®µå€¼</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eqExprContext<span class="token punctuation">.</span>leftExpr <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>IdentityExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//è·å–è¯¥å­—æ®µå®é™…çš„æ˜ å°„å­—æ®µ</span>            field <span class="token operator">=</span> <span class="token function">parseIdentityContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>IdentityExprContext<span class="token punctuation">)</span> eqExprContext<span class="token punctuation">.</span>leftExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦åˆ™æŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸æ”¯æŒè¯¥æŸ¥è¯¢è¯­æ³•!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//å¦‚æœå³åŠè¾¹æ˜¯ä¸ªå€¼</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eqExprContext<span class="token punctuation">.</span>rightExpr <span class="token keyword">instanceof</span> <span class="token class-name">SearchParser<span class="token punctuation">.</span>IdentityExprContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//åˆ™ä¸åŠ¨</span>            value <span class="token operator">=</span> <span class="token function">parseIdentityContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>IdentityExprContext<span class="token punctuation">)</span> eqExprContext<span class="token punctuation">.</span>rightExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦åˆ™æŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"ä¸æ”¯æŒè¯¥æŸ¥è¯¢è¯­æ³•!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//å¦‚æœæ¡ä»¶è¡¨è¾¾å¼çš„å…³è”æ¡ä»¶æ˜¯ä¸ç­‰äº</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>eqExprContext<span class="token punctuation">.</span><span class="token function">NE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//åˆ™è°ƒç”¨must_not</span>            <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">//å¦‚æœæ¡ä»¶è¡¨è¾¾å¼çš„å…³è”æ¡ä»¶æ˜¯å†’å·æˆ–è€…ç­‰äºå·</span>        <span class="token keyword">return</span> QueryBuilders<span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£æå­—æ®µåå’Œå­—æ®µå€¼</span>    <span class="token keyword">private</span> String <span class="token function">parseIdentityContext</span><span class="token punctuation">(</span>SearchParser<span class="token punctuation">.</span>IdentityExprContext identityExprContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> identityExprContext<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£æèšç±»è¡¨è¾¾å¼</span>    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> <span class="token function">parseAggregationExpr</span><span class="token punctuation">(</span>String expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆèšç±»éå†æ ‘å®ä¾‹</span>        AggregateWalker walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AggregateWalker</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//éå†èšç±»è¡¨è¾¾å¼</span>        AggregateParser aggregateParser <span class="token operator">=</span> walker<span class="token punctuation">.</span><span class="token function">buildAntlrTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å°†èšç±»è¡¨è¾¾å¼è½¬æ¢æˆelasticsearchçš„aggregationbuilderçš„åˆ—è¡¨</span>        <span class="token keyword">return</span> <span class="token function">parseAggregationContext</span><span class="token punctuation">(</span>aggregateParser<span class="token punctuation">.</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> <span class="token function">parseAggregationContext</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>AggregateParser<span class="token punctuation">.</span>AggClauseContext<span class="token operator">></span> aggClauseContexts<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºaggregationbuilderç©ºåˆ—è¡¨</span>        List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> aggregationBuilders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ˜¯å¦æ”¯æŒèšç±»åˆ†é¡µï¼Œé»˜è®¤å€¼ä¸ºfalse</span>        <span class="token keyword">boolean</span> hasCompositeAggregation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºCompositeValuesSourceBuilderçš„åˆ—è¡¨</span>        List<span class="token operator">&lt;</span>CompositeValuesSourceBuilder<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> compositeValuesSourceBuilders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºafterkeyçš„map</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> afterKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å¯¹èšç±»è¡¨è¾¾å¼è¿›è¡Œéå†</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>AggregateParser<span class="token punctuation">.</span>AggClauseContext aggClauseContext <span class="token operator">:</span> aggClauseContexts<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚(ip)ï¼Œåˆ™è°ƒç”¨AggregationBuilders.cardinalityæ–¹æ³•ï¼Œå¹¶æ·»åŠ åˆ°èšç±»åˆ—è¡¨ä¸­</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">cardinalityAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//è·å–èšç±»å­—æ®µå</span>                String field <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">cardinalityAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//å°†è½¬æ¢åçš„å­—æ®µæºå…¥AggregationBuilders.cardinalityæ–¹æ³•ä¸­</span>                aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AggregationBuilders<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span>field <span class="token operator">+</span> <span class="token string">"_cardinality"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚country after æ¹–å—ï¼Œåˆ™è°ƒç”¨CompositeValuesSourceBuilderè¿›è¡Œèšç±»åˆ†é¡µ</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//è·å–å­—æ®µå€¼</span>                String field <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//å°†æ˜¯å¦èšç±»åˆ†é¡µå­—æ®µè®¾ç½®ä¸ºtrue</span>                hasCompositeAggregation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//è·å–afterçš„å€¼</span>                String after <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>after<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//è®¾ç½®æŸ¥è¯¢çš„åç§°</span>                String compositeField <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAfterAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_composite"</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//ç”Ÿæˆèšç±»åˆ†é¡µçš„å®ä¾‹</span>                CompositeValuesSourceBuilder sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TermsValuesSourceBuilder</span><span class="token punctuation">(</span>compositeField<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//æ·»åŠ åˆ°èšç±»åˆ†é¡µçš„åˆ—è¡¨ä¸­</span>                compositeValuesSourceBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>                afterKeys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>compositeField<span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚[coordinate]ï¼Œåˆ™è¿›è¡Œåœ°ç†è¾¹æ¡†èšç±»</span>             <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">geoBoundingBoxAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//è·å–åœ°ç†å­—æ®µçš„å€¼</span>                String field <span class="token operator">=</span> aggClauseContext<span class="token punctuation">.</span><span class="token function">geoBoundingBoxAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//æ·»åŠ åˆ°èšç±»åˆ—è¡¨ä¸­</span>                aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AggregationBuilders<span class="token punctuation">.</span><span class="token function">geoBounds</span><span class="token punctuation">(</span>field <span class="token operator">+</span> <span class="token string">"_geoBound"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>             <span class="token comment" spellcheck="true">//å¦‚æœèšç±»è¡¨è¾¾å¼å½¢å¦‚ipï¼Œåˆ™å¯¹å…¶è¿›è¡Œæ¡¶èšç±»</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//å°†è½¬æ¢åçš„æ¡¶èšç±»å®ä¾‹æ·»åŠ åˆ°èšç±»åˆ—è¡¨ä¸­</span>                aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">parseTermsAggregationContext</span><span class="token punctuation">(</span>aggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//å¦‚æœè¯·æ±‚ä¸­å­˜åœ¨èšç±»åˆ†é¡µ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasCompositeAggregation<span class="token punctuation">)</span> <span class="token punctuation">{</span>            CompositeAggregationBuilder composite <span class="token operator">=</span> AggregationBuilders<span class="token punctuation">.</span><span class="token function">composite</span><span class="token punctuation">(</span><span class="token string">"composites"</span><span class="token punctuation">,</span> compositeValuesSourceBuilders<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//åˆ™è®¾ç½®èšç±»åˆ†é¡µçš„å€¼ï¼Œä½†æ¯æ¬¡è¯·æ±‚åªæ”¯æŒä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ†é¡µ</span>            composite<span class="token punctuation">.</span><span class="token function">aggregateAfter</span><span class="token punctuation">(</span>afterKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>            aggregationBuilders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>composite<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>compositeValuesSourceBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"æš‚ä¸æ”¯æŒå¤šå­—æ®µåˆ†é¡µåŠŸèƒ½"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> aggregationBuilders<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//è§£ææ¡¶èšç±»è¡¨è¾¾å¼ï¼Œå½¢å¦‚ip</span>    <span class="token keyword">private</span> AggregationBuilder <span class="token function">parseTermsAggregationContext</span><span class="token punctuation">(</span>AggregateParser<span class="token punctuation">.</span>TermsAggClauseContext termsAggClauseContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//è·å–å­—æ®µå</span>        String field <span class="token operator">=</span> termsAggClauseContext<span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//ç”Ÿæˆæ¡¶èšç±»å®ä¾‹</span>        AggregationBuilder aggregationBuilder <span class="token operator">=</span> AggregationBuilders<span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span>field <span class="token operator">+</span> <span class="token string">"_terms"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>termsAggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å¦‚æœæ¡¶èšç±»ä¸‹æœ‰å­èšç±»ï¼Œåˆ™æ·»åŠ å­èšç±»</span>            aggregationBuilder<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token function">parseTermsAggregationContext</span><span class="token punctuation">(</span>termsAggClauseContext<span class="token punctuation">.</span><span class="token function">termsAggClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> aggregationBuilder<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="7-å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch-DSL"><a href="#7-å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch-DSL" class="headerlink" title="(7). å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch DSL"></a>(7). å°†æŸ¥è¯¢è¯­å¥è½¬æ¢æˆElasticsearch DSL</h4><blockquote><p>åœ¨mainæ–¹æ³•(æˆ–å…¶ä»–è°ƒç”¨è§£æå™¨çš„æ–¹æ³•)ä¸­</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    QueryParser queryParser<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">QueryParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//å°†æœç´¢æ¡ä»¶è½¬æ¢æˆQueryBuilder</span>    QueryBuilder queryBuilder <span class="token operator">=</span> queryParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"country:ä¸­å›½,province:æ¹–å—,city:å¼ å®¶ç•Œ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//ç„¶åå°†queryBuilderä¼ ç»™Elasticsearchè¿›è¡ŒæŸ¥è¯¢</span>    <span class="token comment" spellcheck="true">//å°†èšç±»æ¡ä»¶è½¬æ¢æˆList&lt;AggregationBuilder></span>    List<span class="token operator">&lt;</span>AggregationBuilder<span class="token operator">></span> aggregationBuilders <span class="token operator">=</span> queryParser<span class="token punctuation">.</span><span class="token function">parseAggregationExpr</span><span class="token punctuation">(</span><span class="token string">"country,(country),country>province>city,province after æ¹–å—"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//ç„¶åå°†aggregationBuildersä¼ ç»™Elasticsearchè¿›è¡Œèšç±»</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-æ¨èé˜…è¯»"><a href="#6-æ¨èé˜…è¯»" class="headerlink" title="6. æ¨èé˜…è¯»"></a>6. æ¨èé˜…è¯»</h3><p><a href="https://github.com/antlr/antlr4/blob/master/doc/index.md" target="_blank" rel="noopener">Antlr4å®˜æ–¹æŒ‡å—</a><br><a href="https://github.com/antlr/grammars-v4" target="_blank" rel="noopener">Antlr4å®˜æ–¹ç¤ºä¾‹:Grammars-v4</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> antlr </category>
          
      </categories>
      
      
        <tags>
            
            <tag> antlr </tag>
            
            <tag> dsl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­£è®®</title>
      <link href="2020/02/11/zheng-yi/"/>
      <url>2020/02/11/zheng-yi/</url>
      
        <content type="html"><![CDATA[<h3 id="æ­£è®®"><a href="#æ­£è®®" class="headerlink" title="æ­£è®®"></a>æ­£è®®</h3><p>æ˜”åœ¨é¡¹ç¾½ï¼Œèµ·ä¸ç”±å¾·ï¼Œè™½å¤„åå¤ï¼Œç§‰å¸è€…ä¹‹åŠ¿ï¼Œå’å°±æ±¤é•¬ï¼Œä¸ºåæ°¸æˆ’ã€‚é­ä¸å®¡é‰´ï¼Œä»Šæ¬¡ä¹‹çŸ£;å…èº«ä¸ºå¹¸ï¼Œæˆ’åœ¨å­å­™ã€‚è€ŒäºŒä¸‰å­å„ä»¥è€†è‰¾ä¹‹é½¿ï¼Œæ‰¿ä¼ªæŒ‡è€Œè¿›ä¹¦ï¼Œæœ‰è‹¥å´‡ã€ç«¦ç§°è½ä¹‹åŠŸï¼Œäº¦å°†åªäºå…ƒç¥¸è‹Ÿå…è€…é‚ª!<br>æ˜”ä¸–ç¥–ä¹‹åˆ›è¿¹æ—§åŸºï¼Œå¥‹ç¾¸å’æ•°åƒï¼Œæ‘§è½å¼ºæ—…å››åä½™ä¸‡äºæ˜†é˜³ä¹‹éƒŠã€‚å¤«æ®é“è®¨æ·«ï¼Œä¸åœ¨ä¼—å¯¡ã€‚åŠè‡³å­Ÿå¾·ï¼Œä»¥å…¶è°²èƒœä¹‹åŠ›ï¼Œä¸¾æ•°åä¸‡ä¹‹å¸ˆï¼Œæ•‘å¼ éƒƒäºé˜³å¹³ï¼ŒåŠ¿ç©·è™‘æ‚”ï¼Œä»…èƒ½è‡ªè„±ï¼Œè¾±å…¶é”‹é”ä¹‹ä¼—ï¼Œé‚ä¸§æ±‰ä¸­ä¹‹åœ°ï¼Œæ·±çŸ¥ç¥å™¨ä¸å¯å¦„è·ï¼Œæ—‹è¿˜æœªè‡³ï¼Œæ„Ÿæ¯’è€Œæ­»ã€‚å­æ¡“æ·«é€¸ï¼Œç»§ä¹‹ä»¥ç¯¡ã€‚çºµä½¿äºŒä¸‰å­å¤šé€è‹ã€å¼ è¯¡é¡ä¹‹è¯´ï¼Œå¥‰è¿›é©©å…œæ»”å¤©ä¹‹è¾ï¼Œæ¬²ä»¥è¯¬æ¯å”å¸ï¼Œè®½è§£ç¦¹ã€ç¨·ï¼Œæ‰€è°“å¾’ä¸§æ–‡è—»çƒ¦åŠ³ç¿°å¢¨è€…çŸ£!å¤«å¤§äººå›å­ä¹‹æ‰€ä¸ä¸ºä¹Ÿã€‚åˆã€Šå†›è¯«ã€‹æ›°:â€œä¸‡äººå¿…æ­»ï¼Œæ¨ªè¡Œå¤©ä¸‹ã€‚â€æ˜”è½©è¾•æ°æ•´å’æ•°ä¸‡ï¼Œåˆ¶å››æ–¹ï¼Œå®šæµ·å†…ï¼Œå†µä»¥æ•°åä¸‡ä¹‹ä¼—ï¼Œæ®æ­£é“è€Œä¸´æœ‰ç½ªï¼Œå¯å¾—å¹²æ‹Ÿè€…å“‰!</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯¸è‘›äº® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯¸è‘›äº® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>éš†ä¸­å¯¹</title>
      <link href="2020/02/11/long-zhong-dui/"/>
      <url>2020/02/11/long-zhong-dui/</url>
      
        <content type="html"><![CDATA[<h3 id="éš†ä¸­å¯¹"><a href="#éš†ä¸­å¯¹" class="headerlink" title="éš†ä¸­å¯¹"></a>éš†ä¸­å¯¹</h3><p>äº®èº¬è€•é™‡äº©ï¼Œå¥½ä¸ºã€Šæ¢çˆ¶åŸã€‹ã€‚èº«é•¿å…«å°ºï¼Œæ¯è‡ªæ¯”äºç®¡ä»²ã€ä¹æ¯…ï¼Œæ—¶äººè«ä¹‹è®¸ä¹Ÿã€‚æƒŸåšé™µå´”å·å¹³ã€é¢å·å¾åº¶å…ƒç›´ä¸äº®å‹å–„ï¼Œè°“ä¸ºä¿¡ç„¶ã€‚</p><p>æ—¶å…ˆä¸»å±¯æ–°é‡ã€‚å¾åº¶è§å…ˆä¸»ï¼Œå…ˆä¸»å™¨ä¹‹ï¼Œè°“å…ˆä¸»æ›°ï¼šâ€œè¯¸è‘›å­”æ˜è€…ï¼Œå§é¾™ä¹Ÿï¼Œå°†å†›å²‚æ„¿è§ä¹‹ä¹ï¼Ÿâ€å…ˆä¸»æ›°ï¼šâ€œå›ä¸ä¿±æ¥ã€‚â€åº¶æ›°ï¼šâ€œæ­¤äººå¯å°±è§ï¼Œä¸å¯å±ˆè‡´ä¹Ÿã€‚å°†å†›å®œæ‰é©¾é¡¾ä¹‹ã€‚â€</p><p>ç”±æ˜¯å…ˆä¸»é‚è¯£äº®ï¼Œå‡¡ä¸‰å¾€ï¼Œä¹ƒè§ã€‚å› å±äººæ›°ï¼šâ€œæ±‰å®¤å€¾é¢“ï¼Œå¥¸è‡£çªƒå‘½ï¼Œä¸»ä¸Šè’™å°˜ã€‚å­¤ä¸åº¦å¾·é‡åŠ›ï¼Œæ¬²ä¿¡å¤§ä¹‰äºå¤©ä¸‹ï¼Œè€Œæ™ºæœ¯æµ…çŸ­ï¼Œé‚ç”¨çŒ–è¹¶ï¼Œè‡³äºä»Šæ—¥ã€‚ç„¶å¿—çŠ¹æœªå·²ï¼Œå›è°“è®¡å°†å®‰å‡ºï¼Ÿâ€</p><p>äº®ç­”æ›°ï¼šâ€œè‡ªè‘£å“å·²æ¥ï¼Œè±ªæ°å¹¶èµ·ï¼Œè·¨å·è¿éƒ¡è€…ä¸å¯èƒœæ•°ã€‚æ›¹æ“æ¯”äºè¢ç»ï¼Œåˆ™åå¾®è€Œä¼—å¯¡ï¼Œç„¶æ“é‚èƒ½å…‹ç»ï¼Œä»¥å¼±ä¸ºå¼ºè€…ï¼ŒéæƒŸå¤©æ—¶ï¼ŒæŠ‘äº¦äººè°‹ä¹Ÿã€‚ä»Šæ“å·²æ‹¥ç™¾ä¸‡ä¹‹ä¼—ï¼ŒæŒŸå¤©å­è€Œä»¤è¯¸ä¾¯ï¼Œæ­¤è¯šä¸å¯ä¸äº‰é”‹ã€‚å­™æƒæ®æœ‰æ±Ÿä¸œï¼Œå·²å†ä¸‰ä¸–ï¼Œå›½é™©è€Œæ°‘é™„ï¼Œè´¤èƒ½ä¸ºä¹‹ç”¨ï¼Œæ­¤å¯ä»¥ä¸ºæ´è€Œä¸å¯å›¾ä¹Ÿã€‚è†å·åŒ—æ®æ±‰ã€æ²”ï¼Œåˆ©å°½å—æµ·ï¼Œä¸œè¿å´ä¼šï¼Œè¥¿é€šå·´ã€èœ€ï¼Œæ­¤ç”¨æ­¦ä¹‹å›½ï¼Œè€Œå…¶ä¸»ä¸èƒ½å®ˆï¼Œæ­¤æ®†å¤©æ‰€ä»¥èµ„å°†å†›ï¼Œå°†å†›å²‚æœ‰æ„ä¹ï¼Ÿç›Šå·é™©å¡ï¼Œæ²ƒé‡åƒé‡Œï¼Œå¤©åºœä¹‹åœŸï¼Œé«˜ç¥–å› ä¹‹ä»¥æˆå¸ä¸šã€‚åˆ˜ç’‹æš—å¼±ï¼Œå¼ é²åœ¨åŒ—ï¼Œæ°‘æ®·å›½å¯Œè€Œä¸çŸ¥å­˜æ¤ï¼Œæ™ºèƒ½ä¹‹å£«æ€å¾—æ˜å›ã€‚å°†å†›æ—¢å¸å®¤ä¹‹èƒ„ï¼Œä¿¡ä¹‰è‘—äºå››æµ·ï¼Œæ€»æ½è‹±é›„ï¼Œæ€è´¤å¦‚æ¸´ï¼Œè‹¥è·¨æœ‰è†ã€ç›Šï¼Œä¿å…¶å²©é˜»ï¼Œè¥¿å’Œè¯¸æˆï¼Œå—æŠšå¤·è¶Šï¼Œå¤–ç»“å¥½å­™æƒï¼Œå†…ä¿®æ”¿ç†ï¼›å¤©ä¸‹æœ‰å˜ï¼Œåˆ™å‘½ä¸€ä¸Šå°†å°†è†å·ä¹‹å†›ä»¥å‘å®›ã€æ´›ï¼Œå°†å†›èº«ç‡ç›Šå·ä¹‹ä¼—å‡ºäºç§¦å·ï¼Œç™¾å§“å­°æ•¢ä¸ç®ªé£Ÿå£¶æµ†ä»¥è¿å°†å†›è€…ä¹ï¼Ÿè¯šå¦‚æ˜¯ï¼Œåˆ™éœ¸ä¸šå¯æˆï¼Œæ±‰å®¤å¯å…´çŸ£ã€‚â€</p><p>å…ˆä¸»æ›°ï¼šâ€œå–„ï¼â€äºæ˜¯ä¸äº®æƒ…å¥½æ—¥å¯†ã€‚</p><p>å…³ç¾½ã€å¼ é£ç­‰ä¸æ‚¦ï¼Œå…ˆä¸»è§£ä¹‹æ›°ï¼šâ€œå­¤ä¹‹æœ‰å­”æ˜ï¼ŒçŠ¹é±¼ä¹‹æœ‰æ°´ä¹Ÿã€‚æ„¿è¯¸å›å‹¿å¤è¨€ã€‚â€ç¾½ã€é£ä¹ƒæ­¢ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¯¸è‘›äº® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯¸è‘›äº® </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
